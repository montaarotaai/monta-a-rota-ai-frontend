<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Monta a Rota Ai</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f0f2f5;color:#333;}
.login-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;background:linear-gradient(135deg,#FF6B35 0%,#004E89 100%);}
.login-box{background:white;padding:28px;border-radius:16px;width:100%;max-width:390px;box-shadow:0 8px 30px rgba(0,0,0,0.2);}
.login-logo{text-align:center;margin-bottom:20px;}
.login-logo h1{color:#004E89;font-size:22px;margin-top:8px;}
.tabs{display:flex;margin-bottom:16px;border-radius:8px;overflow:hidden;border:1px solid #eee;}
.tab{flex:1;padding:10px;text-align:center;cursor:pointer;background:#f5f5f5;color:#666;font-size:14px;border:none;}
.tab.active{background:linear-gradient(135deg,#FF6B35,#004E89);color:white;font-weight:600;}
.fg{margin-bottom:12px;}
.fg label{display:block;font-size:12px;font-weight:600;color:#555;margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px;}
.fg input,.fg select,.fg textarea{width:100%;padding:11px 13px;border:1.5px solid #e0e0e0;border-radius:8px;font-size:14px;background:white;transition:border .2s;}
.fg input:focus,.fg select:focus{outline:none;border-color:#FF6B35;}
.fg textarea{resize:vertical;min-height:65px;}
.g2{display:grid;grid-template-columns:2fr 1fr;gap:10px;}
.g2b{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.btn{width:100%;padding:13px;border:none;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer;}
.btn:hover{opacity:.88;}.btn:disabled{opacity:.5;cursor:not-allowed;}
.btn-primary{background:linear-gradient(135deg,#FF6B35,#004E89);color:white;}
.btn-green{background:#00C9A7;color:white;}
.btn-blue{background:#004E89;color:white;}
.user-type{display:flex;gap:10px;margin-bottom:12px;}
.user-type label{flex:1;padding:11px;text-align:center;border:2px solid #e0e0e0;border-radius:10px;cursor:pointer;font-size:14px;transition:all .2s;}
.user-type input:checked+label{border-color:#FF6B35;background:#fff5f2;color:#FF6B35;font-weight:600;}
.user-type input{display:none;}
.msg-error{background:#ffebee;color:#c62828;padding:10px 13px;border-radius:8px;font-size:13px;margin-bottom:10px;}
.msg-ok{background:#e8f5e9;color:#2e7d32;padding:10px 13px;border-radius:8px;font-size:13px;margin-bottom:10px;}
.header{background:linear-gradient(135deg,#FF6B35 0%,#004E89 100%);color:white;padding:20px 16px 16px;text-align:center;position:relative;}
.header h1{font-size:20px;font-weight:700;}
.header p{font-size:13px;opacity:.85;margin-top:3px;}
.btn-logout{position:absolute;top:14px;right:14px;background:rgba(255,255,255,.18);color:white;border:none;padding:7px 13px;border-radius:8px;font-size:13px;cursor:pointer;font-weight:600;}
.container{padding:14px;max-width:900px;margin:0 auto;}
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:10px;margin-bottom:14px;}
.card{background:white;padding:14px;border-radius:12px;box-shadow:0 1px 6px rgba(0,0,0,.07);}
.card h3{font-size:11px;color:#999;font-weight:500;margin-bottom:5px;text-transform:uppercase;}
.card .val{font-size:24px;font-weight:700;color:#FF6B35;}
.menu{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;}
.mitem{background:white;padding:20px 12px;border-radius:12px;text-align:center;box-shadow:0 1px 6px rgba(0,0,0,.07);cursor:pointer;transition:transform .15s,box-shadow .15s;}
.mitem:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.12);}
.mitem .ico{font-size:30px;margin-bottom:7px;}
.mitem h3{font-size:13px;color:#444;font-weight:600;}
.btn-logout2{position:absolute;top:14px;right:14px;background:rgba(255,255,255,.18);color:white;border:none;padding:7px 13px;border-radius:8px;font-size:13px;cursor:pointer;font-weight:600;}
.secao{background:white;border-radius:12px;box-shadow:0 1px 6px rgba(0,0,0,.07);padding:14px;margin-bottom:12px;}
.s-title{font-size:14px;font-weight:700;color:#004E89;margin-bottom:10px;}
.badge{display:inline-block;padding:2px 9px;border-radius:20px;font-size:11px;font-weight:600;}
.b-ativo{background:#e8f5e9;color:#2e7d32;}
.b-bloqueado,.b-vermelho{background:#ffebee;color:#c62828;}
.b-pendente{background:#fff8e1;color:#e65100;}
.b-entregue{background:#e8f5e9;color:#2e7d32;}
.b-em_rota{background:#e3f2fd;color:#1565c0;}
.b-online{background:#e8f5e9;color:#2e7d32;}
.b-offline{background:#f5f5f5;color:#777;}
.mapa-box{border-radius:10px;overflow:hidden;position:relative;}
.mapa-ctrl{position:absolute;top:8px;right:8px;z-index:999;display:flex;flex-direction:column;gap:6px;}
.mapa-btn{background:white;border:none;width:36px;height:36px;border-radius:8px;font-size:18px;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.2);display:flex;align-items:center;justify-content:center;}
.mapa-btn.seguindo{background:#FF6B35;color:white;}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:1000;overflow-y:auto;-webkit-overflow-scrolling:touch;}
.modal.open{display:flex;align-items:flex-start;justify-content:center;padding:10px;}
.modal-box{background:white;border-radius:14px;width:100%;max-width:600px;padding:18px;position:relative;margin:auto;}
.modal-close{position:absolute;top:12px;right:14px;font-size:24px;cursor:pointer;color:#999;background:none;border:none;line-height:1;}
.litem{padding:12px 0;border-bottom:1px solid #f0f0f0;display:flex;gap:10px;align-items:flex-start;}
.litem:last-child{border-bottom:none;}
.btn-sm{background:#FF6B35;color:white;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px;white-space:nowrap;margin:0;width:auto;font-weight:600;}
.btn-sm.green{background:#00C9A7;}.btn-sm.blue{background:#004E89;}.btn-sm.red{background:#e74c3c;}.btn-sm.gray{background:#888;}.btn-sm.orange{background:#FF6B35;}
.foto-wrap{cursor:pointer;margin:0 auto 10px;}
.foto-circle{width:82px;height:82px;border-radius:50%;background:rgba(255,255,255,.25);border:3px dashed rgba(255,255,255,.5);display:flex;align-items:center;justify-content:center;font-size:34px;margin:0 auto;}
.foto-img{width:82px;height:82px;border-radius:50%;object-fit:cover;border:3px solid white;}
.codigo-box{background:rgba(255,255,255,.15);border-radius:10px;padding:8px 16px;margin-top:8px;display:inline-block;}
.codigo-num{font-size:28px;font-weight:700;letter-spacing:6px;color:white;}
.codigo-label{font-size:11px;opacity:.8;text-align:center;}
.ecard{background:#f8f9fa;border-radius:10px;padding:12px;margin-bottom:8px;border-left:4px solid #FF6B35;}
.ecard.rota{border-left-color:#004E89;background:#f0f4ff;}
.ocr-progress{background:#e3f2fd;border-radius:8px;padding:14px;text-align:center;margin:12px 0;}
.ocr-bar{height:6px;background:#e0e0e0;border-radius:3px;margin-top:8px;overflow:hidden;}
.ocr-fill{height:100%;background:linear-gradient(90deg,#FF6B35,#004E89);border-radius:3px;transition:width .3s;width:0%;}
.hidden{display:none!important;}
.row{display:flex;gap:8px;align-items:center;}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="pg-login" class="login-wrap">
  <div class="login-box">
    <div class="login-logo"><div style="font-size:40px;">&#128230;</div><h1>Monta a Rota Ai</h1></div>
    <div class="tabs">
      <button class="tab active" onclick="switchTab('login',this)">Entrar</button>
      <button class="tab" onclick="switchTab('register',this)">Cadastrar</button>
    </div>
    <div id="login-tab">
      <div id="login-msg"></div>
      <div class="fg"><label>Email</label><input type="email" id="l-email" placeholder="seu@email.com" autocomplete="email"></div>
      <div class="fg"><label>Senha</label><input type="password" id="l-senha" placeholder="..." autocomplete="current-password"></div>
      <button class="btn btn-primary" onclick="fazerLogin()" id="btn-login">Entrar</button>
    </div>
    <div id="register-tab" class="hidden">
      <div id="reg-msg"></div>
      <div class="user-type">
        <label><input type="radio" name="rtype" value="loja" checked onchange="toggleCad()"><span>&#127978; Loja</span></label>
        <label><input type="radio" name="rtype" value="entregador" onchange="toggleCad()"><span>&#128757; Entregador</span></label>
      </div>
      <div class="fg"><label>Nome</label><input type="text" id="r-nome"></div>
      <div class="fg"><label>Email</label><input type="email" id="r-email"></div>
      <div class="fg"><label>Telefone</label><input type="tel" id="r-tel" placeholder="(16) 99999-9999"></div>
      <div class="fg"><label>Senha</label><input type="password" id="r-senha" placeholder="Minimo 6 caracteres"></div>
      <div id="c-loja">
        <div class="fg"><label>Nome da Loja</label><input type="text" id="r-nloja"></div>
        <div class="fg"><label>CNPJ</label><input type="text" id="r-cnpj" placeholder="00.000.000/0000-00"></div>
        <div class="g2"><div class="fg"><label>Rua</label><input type="text" id="r-rua"></div><div class="fg"><label>Numero</label><input type="text" id="r-num"></div></div>
        <div class="g2b"><div class="fg"><label>Bairro</label><input type="text" id="r-bairro"></div><div class="fg"><label>Cidade</label><input type="text" id="r-cidade" value="Ribeirao Preto"></div></div>
      </div>
      <div id="c-ent" class="hidden">
        <div class="fg"><label>Placa</label><input type="text" id="r-placa" placeholder="ABC-1234"></div>
        <div class="fg"><label>Chave Pix</label><input type="text" id="r-pix"></div>
      </div>
      <button class="btn btn-primary" onclick="fazerCadastro()" id="btn-cad">Cadastrar</button>
    </div>
  </div>
</div>

<!-- ADMIN -->
<div id="pg-admin" class="hidden">
  <div class="header">
    <button class="btn-logout" onclick="sair()">Sair</button>
    <h1>&#128230; Monta a Rota Ai</h1><p>Painel Administrativo</p>
  </div>
  <div class="container">
    <div class="cards">
      <div class="card"><h3>Entregadores</h3><div class="val" id="adm-ent">0</div></div>
      <div class="card"><h3>Lojas</h3><div class="val" id="adm-loj">0</div></div>
      <div class="card"><h3>Online</h3><div class="val" id="adm-on">0</div></div>
    </div>
    <div class="secao">
      <div class="s-title">&#128205; Entregadores Online Agora</div>
      <div class="mapa-box">
        <div id="mapa-admin" style="height:260px;"></div>
        <div class="mapa-ctrl">
          <button class="mapa-btn" id="btn-fol-adm" onclick="toggleFollow('admin')" title="Seguir">&#128247;</button>
          <button class="mapa-btn" onclick="centerMap('admin')" title="Centralizar">&#127962;</button>
        </div>
      </div>
      <div id="lista-on-adm" style="margin-top:8px;display:flex;flex-wrap:wrap;gap:6px;"></div>
    </div>
    <div class="menu">
      <div class="mitem" onclick="abrirEntAdm()"><div class="ico">&#128757;</div><h3>Entregadores</h3></div>
      <div class="mitem" onclick="abrirLojAdm()"><div class="ico">&#127978;</div><h3>Lojas</h3></div>
      <div class="mitem" onclick="abrirFinAdm()"><div class="ico">&#128176;</div><h3>Financeiro</h3></div>
      <div class="mitem" onclick="abrirCobAdm()"><div class="ico">&#128197;</div><h3>Cobrancas</h3></div>
    </div>
  </div>
</div>

<!-- LOJA -->
<div id="pg-loja" class="hidden">
  <div class="header">
    <button class="btn-logout" onclick="sair()">Sair</button>
    <h1 id="loja-nome">Minha Loja</h1><p>Painel da Loja</p>
    <div class="codigo-box">
      <div class="codigo-label">Codigo para Entregadores</div>
      <div class="codigo-num" id="loja-cod">------</div>
    </div>
  </div>
  <div class="container">
    <div class="cards">
      <div class="card"><h3>Taxa Sistema</h3><div class="val" id="lj-ts">-</div></div>
      <div class="card"><h3>Taxa Ent.</h3><div class="val" id="lj-te">-</div></div>
      <div class="card"><h3>Hoje</h3><div class="val" id="lj-hj">0</div></div>
    </div>
    <div class="secao">
      <div class="s-title">&#128176; Taxa por entrega ao entregador</div>
      <div class="row">
        <input type="number" id="lj-taxa-new" step="0.10" min="0" placeholder="0.00" style="flex:1;padding:10px;border:1.5px solid #e0e0e0;border-radius:8px;font-size:14px;">
        <button class="btn-sm blue" onclick="salvarTaxaLj()">Salvar</button>
      </div>
      <div id="taxa-msg" style="font-size:12px;margin-top:5px;"></div>
    </div>
    <div class="secao">
      <div class="s-title">&#128205; Entregadores Online</div>
      <div class="mapa-box">
        <div id="mapa-loja" style="height:240px;"></div>
        <div class="mapa-ctrl">
          <button class="mapa-btn" id="btn-fol-lj" onclick="toggleFollow('loja')" title="Seguir">&#128247;</button>
          <button class="mapa-btn" onclick="centerMap('loja')" title="Centralizar">&#127962;</button>
        </div>
      </div>
      <div id="lista-on-lj" style="margin-top:8px;display:flex;flex-wrap:wrap;gap:6px;"></div>
    </div>
    <div class="menu">
      <div class="mitem" onclick="abrirNovoPedido()"><div class="ico">&#128247;</div><h3>Novo Pedido</h3></div>
      <div class="mitem" onclick="abrirPedidosLj()"><div class="ico">&#128230;</div><h3>Pedidos / Rota</h3></div>
      <div class="mitem" onclick="abrirRelLj()"><div class="ico">&#128202;</div><h3>Relatorio</h3></div>
      <div class="mitem" onclick="abrirGerEnt()"><div class="ico">&#128101;</div><h3>Entregadores</h3></div>
      <div class="mitem" onclick="abrirCfgLj()" style="grid-column:1/-1;max-width:180px;margin:0 auto;"><div class="ico">&#9881;</div><h3>Configuracoes</h3></div>
    </div>
  </div>
</div>

<!-- ENTREGADOR -->
<div id="pg-entregador" class="hidden">
  <div class="header">
    <button class="btn-logout" onclick="sair()">Sair</button>
    <div class="foto-wrap" onclick="abrirFoto()">
      <div id="foto-ph" class="foto-circle">&#128100;</div>
      <img id="foto-img" class="foto-img hidden" src="" alt="">
    </div>
    <h1 id="ent-nome">Entregador</h1>
    <p id="ent-st">&#9899; Offline</p>
    <input type="file" id="input-foto" accept="image/*" class="hidden" onchange="uploadFoto(event)">
  </div>
  <div class="container">
    <div class="cards">
      <div class="card"><h3>Entregas Hoje</h3><div class="val" id="ent-cnt">0</div></div>
      <div class="card"><h3>Ganhos Hoje</h3><div class="val" id="ent-gnh">R$0</div></div>
    </div>
    <div class="secao">
      <div class="s-title">&#127978; Minhas Lojas</div>
      <div id="minhas-lojas" style="margin-bottom:10px;"></div>
      <div style="background:#fff3e0;border-radius:10px;padding:12px;">
        <p style="font-size:12px;font-weight:700;color:#e65100;margin-bottom:6px;">&#128273; Conectar a uma nova loja</p>
        <p style="font-size:12px;color:#666;margin-bottom:8px;">Peca o <strong>codigo de 6 letras</strong> que aparece no painel da loja</p>
        <div class="row">
          <input type="text" id="cod-loja-inp" placeholder="EX: AB12CD" maxlength="6" style="flex:1;padding:11px;border:1.5px solid #e0e0e0;border-radius:8px;font-size:20px;text-transform:uppercase;letter-spacing:4px;text-align:center;font-weight:700;">
          <button class="btn-sm orange" onclick="conectarCodigo()" style="padding:11px 14px;font-size:14px;">Conectar</button>
        </div>
        <div id="msg-cod" style="font-size:13px;margin-top:6px;"></div>
      </div>
    </div>
    <div class="menu">
      <div class="mitem" id="btn-on-card" onclick="toggleOnline()">
        <div class="ico" id="ico-on">&#128994;</div>
        <h3 id="txt-on">Ficar Online</h3>
      </div>
      <div class="mitem" onclick="abrirRotaEnt()"><div class="ico">&#127758;</div><h3>Minha Rota</h3></div>
      <div class="mitem" onclick="abrirGanhosEnt()"><div class="ico">&#128181;</div><h3>Meus Ganhos</h3></div>
      <div class="mitem" onclick="abrirCfgEnt()"><div class="ico">&#9881;</div><h3>Configuracoes</h3></div>
    </div>
  </div>
</div>

<!-- MODAIS -->
<div id="m-adm-ent" class="modal"><div class="modal-box"><button class="modal-close" onclick="closeM('adm-ent')">&times;</button><h2 style="margin-bottom:14px;">Entregadores</h2><div id="adm-ent-lst"></div></div></div>
<div id="m-adm-loj" class="modal"><div class="modal-box"><button class="modal-close" onclick="closeM('adm-loj')">&times;</button><h2 style="margin-bottom:14px;">Lojas</h2><div id="adm-loj-lst"></div></div></div>
<div id="m-adm-fin" class="modal"><div class="modal-box"><button class="modal-close" onclick="closeM('adm-fin')">&times;</button><h2 style="margin-bottom:14px;">Financeiro</h2><div id="adm-fin-lst"></div></div></div>
<div id="m-adm-cob" class="modal"><div class="modal-box"><button class="modal-close" onclick="closeM('adm-cob')">&times;</button><h2 style="margin-bottom:14px;">Cobrancas</h2><div id="adm-cob-lst"></div></div></div>

<!-- Novo Pedido -->
<div id="m-pedido" class="modal"><div class="modal-box">
  <button class="modal-close" onclick="closeM('pedido')">&times;</button>
  <h2 style="margin-bottom:4px;">&#128247; Novo Pedido</h2>
  <p style="font-size:13px;color:#888;margin-bottom:14px;">Fotografe a comanda para leitura automatica</p>
  <div onclick="document.getElementById('ocr-input').click()" style="background:linear-gradient(135deg,#FF6B35,#004E89);border-radius:12px;padding:20px;text-align:center;cursor:pointer;color:white;margin-bottom:12px;">
    <div style="font-size:36px;margin-bottom:6px;">&#128247;</div>
    <div style="font-weight:700;font-size:15px;">Fotografar Comanda</div>
    <div style="font-size:12px;opacity:.8;margin-top:3px;">Toque aqui para abrir a camera ou galeria</div>
  </div>
  <input type="file" id="ocr-input" accept="image/*" capture="environment" class="hidden" onchange="lerComanda(event)">
  <div id="ocr-prev" class="hidden" style="margin-bottom:12px;text-align:center;">
    <img id="ocr-img" style="max-width:100%;max-height:180px;border-radius:8px;border:1px solid #eee;">
    <div style="margin-top:6px;"><button onclick="document.getElementById('ocr-input').click()" class="btn-sm gray">Trocar foto</button></div>
  </div>
  <div id="ocr-load" class="ocr-progress hidden">
    <div>&#129300; Lendo comanda com OCR...</div>
    <div class="ocr-bar"><div class="ocr-fill" id="ocr-fill"></div></div>
    <div id="ocr-pct" style="font-size:12px;color:#888;margin-top:4px;">0%</div>
  </div>
  <div class="fg"><label>Numero do Pedido</label><input type="text" id="p-num" placeholder="Ex: 4321 ou #IFD-123"></div>
  <div class="fg"><label>Nome do Cliente</label><input type="text" id="p-cli"></div>
  <div class="fg"><label>Telefone</label><input type="tel" id="p-tel"></div>
  <div class="g2"><div class="fg"><label>Rua / Avenida</label><input type="text" id="p-rua"></div><div class="fg"><label>Numero</label><input type="text" id="p-nend"></div></div>
  <div class="g2b"><div class="fg"><label>Bairro</label><input type="text" id="p-bairro"></div><div class="fg"><label>Cidade</label><input type="text" id="p-cidade" value="Ribeirao Preto"></div></div>
  <div class="fg"><label>Complemento (apto, bloco, torre...)</label><input type="text" id="p-comp" placeholder="Ex: Apto 12 Torre 2"></div>
  <div class="fg"><label>Observacoes do Pedido</label><input type="text" id="p-obs"></div>
  <div id="ped-msg" style="margin-top:6px;"></div>
  <button class="btn btn-green" onclick="salvarPedido()" style="margin-top:10px;">&#10004; Salvar e Adicionar a Rota</button>
</div></div>

<!-- Pedidos/Rota Loja -->
<div id="m-rota" class="modal"><div class="modal-box">
  <button class="modal-close" onclick="closeM('rota')">&times;</button>
  <h2 style="margin-bottom:10px;">&#128230; Pedidos e Rota</h2>
  <div class="row" style="margin-bottom:12px;flex-wrap:wrap;">
    <button class="btn-sm blue" onclick="otimizarRota()" style="padding:9px 14px;">&#129302; Otimizar</button>
    <button class="btn-sm green" onclick="enviarRota()" style="padding:9px 14px;">&#128757; Enviar ao Entregador</button>
  </div>
  <div id="rota-lst"></div>
</div></div>

<!-- Relatorio -->
<div id="m-rel" class="modal"><div class="modal-box">
  <button class="modal-close" onclick="closeM('rel')">&times;</button>
  <h2 style="margin-bottom:10px;">&#128202; Relatorio</h2>
  <select id="rel-f" onchange="carregarRel()" style="width:100%;padding:10px;border:1.5px solid #e0e0e0;border-radius:8px;margin-bottom:12px;"><option value="hoje">Hoje</option><option value="semana">Esta semana</option><option value="mes">Este mes</option></select>
  <div id="rel-dados"></div>
</div></div>

<!-- Gerenciar Entregadores -->
<div id="m-ger" class="modal"><div class="modal-box">
  <button class="modal-close" onclick="closeM('ger')">&times;</button>
  <h2 style="margin-bottom:10px;">&#128101; Meus Entregadores</h2>
  <div class="secao" style="background:#fff3e0;margin-bottom:12px;">
    <div class="s-title" style="color:#e65100;">Como o entregador se conecta</div>
    <p style="font-size:13px;color:#666;">O entregador abre o app, vai em <strong>Minhas Lojas</strong> e digita o codigo abaixo:</p>
    <div style="font-size:32px;text-align:center;letter-spacing:8px;font-weight:700;color:#004E89;margin-top:8px;" id="ger-cod">------</div>
  </div>
  <div id="ger-lst"></div>
</div></div>

<!-- Config Loja -->
<div id="m-cfg-lj" class="modal"><div class="modal-box">
  <button class="modal-close" onclick="closeM('cfg-lj')">&times;</button>
  <h2 style="margin-bottom:14px;">&#9881; Configuracoes</h2>
  <div class="fg"><label>Nome da Loja</label><input type="text" id="cfg-nlj"></div>
  <div class="fg"><label>Telefone</label><input type="tel" id="cfg-tel"></div>
  <div class="fg"><label>CNPJ</label><input type="text" id="cfg-cnpj"></div>
  <div class="g2"><div class="fg"><label>Rua</label><input type="text" id="cfg-rua"></div><div class="fg"><label>Numero</label><input type="text" id="cfg-nend"></div></div>
  <div class="g2b"><div class="fg"><label>Bairro</label><input type="text" id="cfg-bairro"></div><div class="fg"><label>Cidade</label><input type="text" id="cfg-cidade"></div></div>
  <div class="fg"><label>Complemento</label><input type="text" id="cfg-comp"></div>
  <div class="g2b"><div class="fg"><label>Abertura</label><input type="time" id="cfg-ab"></div><div class="fg"><label>Fechamento</label><input type="time" id="cfg-fch"></div></div>
  <div class="fg"><label>Nova Senha (em branco = nao alterar)</label><input type="password" id="cfg-senha"></div>
  <div id="cfg-lj-msg"></div>
  <button class="btn btn-primary" onclick="salvarCfgLj()">Salvar</button>
</div></div>

<!-- Ganhos -->
<div id="m-ganhos" class="modal"><div class="modal-box">
  <button class="modal-close" onclick="closeM('ganhos')">&times;</button>
  <h2 style="margin-bottom:10px;">&#128181; Meus Ganhos</h2>
  <select id="gnh-f" onchange="carregarGanhos()" style="width:100%;padding:10px;border:1.5px solid #e0e0e0;border-radius:8px;margin-bottom:12px;"><option value="hoje">Hoje</option><option value="semana">Esta semana</option><option value="mes">Este mes</option></select>
  <div id="gnh-dados"></div>
</div></div>

<!-- Rota Entregador -->
<div id="m-rota-ent" class="modal"><div class="modal-box">
  <button class="modal-close" onclick="closeM('rota-ent')">&times;</button>
  <h2 style="margin-bottom:10px;">&#127758; Minhas Entregas</h2>
  <div id="rota-ent-lst"></div>
</div></div>

<!-- Config Entregador -->
<div id="m-cfg-ent" class="modal"><div class="modal-box">
  <button class="modal-close" onclick="closeM('cfg-ent')">&times;</button>
  <h2 style="margin-bottom:14px;">&#9881; Meus Dados</h2>
  <div class="fg"><label>Nome</label><input type="text" id="ent-nome2"></div>
  <div class="fg"><label>Telefone</label><input type="tel" id="ent-tel2"></div>
  <div class="fg"><label>Placa</label><input type="text" id="ent-plc"></div>
  <div class="fg"><label>Chave Pix</label><input type="text" id="ent-pix"></div>
  <div class="fg"><label>Nova Senha</label><input type="password" id="ent-sen"></div>
  <div id="ent-cfg-msg"></div>
  <button class="btn btn-primary" onclick="salvarCfgEnt()">Salvar</button>
</div></div>

<script>
const SB_URL='https://dfvjaweyxfenhjgusekq.supabase.co';
const SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRmdmphd2V5eGZlbmhqZ3VzZWtxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzk4NTMsImV4cCI6MjA4NzYxNTg1M30.MT9pzSQgc3ZNGiIV95DwjVtNvSZI0Lz-SKMkvMys1Kg';
const db=window.supabase.createClient(SB_URL,SB_KEY);
const RP=[-21.1767,-47.8208];

let U=null;
let mapas={admin:null,loja:null};
let mrks={admin:{},loja:{}};
let seg={admin:false,loja:false};
let ivs={rast:null,mAdm:null,mLj:null};

window.onload=()=>{const s=localStorage.getItem('u');if(s){U=JSON.parse(s);showPg(U.tipo);}};

const $=id=>document.getElementById(id);
const v=id=>{const e=$(id);return e?e.value.trim():'';}
const fR=val=>'R$'+parseFloat(val||0).toFixed(2).replace('.',',');
const fEnd=(r,n,b,c,cp)=>{let s=[r,n].filter(Boolean).join(', ');if(b)s+=', '+b;if(c)s+=' - '+c;if(cp)s+=' ('+cp+')';return s;};
function showM(id,msg,ok){const e=$(id);if(!e)return;e.className=ok?'msg-ok':'msg-error';e.textContent=msg;}
function clearM(id){const e=$(id);if(e){e.className='';e.textContent='';}}
function iDia(){const d=new Date();d.setHours(0,0,0,0);return d.toISOString();}
function fDia(){const d=new Date();d.setHours(23,59,59,999);return d.toISOString();}
function iPer(p){const n=new Date();if(p==='hoje')n.setHours(0,0,0,0);else if(p==='semana'){n.setDate(n.getDate()-n.getDay());n.setHours(0,0,0,0);}else{n.setDate(1);n.setHours(0,0,0,0);}return n.toISOString();}

function openM(id){const m=$('m-'+id);if(m)m.classList.add('open');}
function closeM(id){const m=$('m-'+id);if(m)m.classList.remove('open');}
window.addEventListener('click',e=>{if(e.target.classList.contains('modal'))e.target.classList.remove('open');});

function switchTab(tab,el){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));el.classList.add('active');
  if(tab==='login'){$('login-tab').classList.remove('hidden');$('register-tab').classList.add('hidden');}
  else{$('login-tab').classList.add('hidden');$('register-tab').classList.remove('hidden');}
}
function toggleCad(){
  const t=document.querySelector('input[name="rtype"]:checked').value;
  $('c-loja').classList.toggle('hidden',t!=='loja');$('c-ent').classList.toggle('hidden',t!=='entregador');
}

async function fazerLogin(){
  const email=v('l-email'),senha=v('l-senha'),btn=$('btn-login');
  if(!email||!senha){showM('login-msg','Preencha email e senha');return;}
  btn.disabled=true;btn.textContent='Entrando...';
  try{
    const{data:u}=await db.from('usuarios').select('*').eq('email',email).single();
    if(!u){showM('login-msg','Usuario nao encontrado');return;}
    if(u.status==='bloqueado'){showM('login-msg','Acesso bloqueado.');return;}
    if(senha!==u.senha_hash){showM('login-msg','Senha incorreta');return;}
    U=u;localStorage.setItem('u',JSON.stringify(u));showPg(u.tipo);
  }catch(e){showM('login-msg','Erro: '+e.message);}
  finally{btn.disabled=false;btn.textContent='Entrar';}
}

async function fazerCadastro(){
  const tipo=document.querySelector('input[name="rtype"]:checked').value;
  const nome=v('r-nome'),email=v('r-email'),senha=v('r-senha'),btn=$('btn-cad');
  if(!nome||!email||!senha){showM('reg-msg','Preencha nome, email e senha');return;}
  if(senha.length<6){showM('reg-msg','Senha minimo 6 caracteres');return;}
  btn.disabled=true;btn.textContent='Cadastrando...';
  try{
    const{data:ex}=await db.from('usuarios').select('id').eq('email',email).single();
    if(ex){showM('reg-msg','Email ja cadastrado');return;}
    const rua=v('r-rua'),num=v('r-num'),bairro=v('r-bairro'),cidade=v('r-cidade')||'Ribeirao Preto';
    const d={tipo,nome,email,telefone:v('r-tel'),senha_hash:senha,status:'ativo',taxa_sistema:0.50,taxa_entrega:0,online:false,cidade};
    if(tipo==='loja'){
      d.nome_loja=v('r-nloja');d.cnpj=v('r-cnpj');
      d.endereco=fEnd(rua,num,bairro,cidade,'');
      d.endereco_rua=rua;d.endereco_numero=num;d.endereco_bairro=bairro;d.endereco_cidade=cidade;
      d.codigo_loja=Math.random().toString(36).substring(2,8).toUpperCase();
    }else{d.placa_moto=v('r-placa');d.chave_pix=v('r-pix');}
    const{error}=await db.from('usuarios').insert([d]);
    if(error){showM('reg-msg','Erro: '+error.message);return;}
    showM('reg-msg','Cadastro realizado! Faca login.',true);
    setTimeout(()=>document.querySelectorAll('.tab')[0].click(),1500);
  }catch(e){showM('reg-msg','Erro: '+e.message);}
  finally{btn.disabled=false;btn.textContent='Cadastrar';}
}

function showPg(tipo){
  ['pg-login','pg-admin','pg-loja','pg-entregador'].forEach(id=>$(id).classList.add('hidden'));
  $('pg-'+tipo).classList.remove('hidden');
  pararIvs();
  if(tipo==='admin')initAdmin();
  else if(tipo==='loja')initLoja();
  else if(tipo==='entregador')initEnt();
}

function sair(){
  pararIvs();
  if(U&&U.online)db.from('usuarios').update({online:false}).eq('id',U.id);
  U=null;localStorage.removeItem('u');showPg('login');
  $('l-email').value='';$('l-senha').value='';
}
function pararIvs(){Object.keys(ivs).forEach(k=>{if(ivs[k]){clearInterval(ivs[k]);ivs[k]=null;}});}

// MAPA
function criarMapa(tipo){
  const id=tipo==='admin'?'mapa-admin':'mapa-loja';
  if(mapas[tipo])return;
  mapas[tipo]=L.map(id).setView(RP,13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'OSM'}).addTo(mapas[tipo]);
}
function icoEnt(nome){
  return L.divIcon({html:`<div style="position:relative"><div style="background:#FF6B35;color:white;border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;font-size:17px;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,.4)">&#128757;</div><div style="position:absolute;bottom:-18px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.65);color:white;font-size:9px;padding:1px 5px;border-radius:4px;white-space:nowrap">${nome.split(' ')[0]}</div></div>`,iconSize:[36,36],iconAnchor:[18,18],className:''});
}
async function atuMapa(tipo,ents){
  const m=mapas[tipo];if(!m)return;
  const mk=mrks[tipo];
  Object.keys(mk).forEach(id=>{if(!ents.find(e=>e.id===id)){mk[id].remove();delete mk[id];}});
  const bounds=[];
  ents.forEach(e=>{
    if(!e.latitude||!e.longitude)return;
    const ll=[e.latitude,e.longitude];
    if(mk[e.id])mk[e.id].setLatLng(ll);
    else mk[e.id]=L.marker(ll,{icon:icoEnt(e.nome)}).addTo(m).bindPopup(`<strong>${e.nome}</strong><br>${e.telefone||''}`);
    bounds.push(ll);
    if(seg[tipo]&&ents.length===1)m.setView(ll,16,{animate:true});
  });
  if(!seg[tipo]){if(bounds.length)m.fitBounds(bounds,{padding:[40,40]});else m.setView(RP,13);}
  setTimeout(()=>m.invalidateSize(),200);
}
function toggleFollow(tipo){
  seg[tipo]=!seg[tipo];
  const bid='btn-fol-'+(tipo==='admin'?'adm':'lj');
  const b=$(bid);if(b){b.classList.toggle('seguindo',seg[tipo]);b.innerHTML=seg[tipo]?'&#128994;':'&#128247;';}
}
function centerMap(tipo){
  seg[tipo]=false;
  const bid='btn-fol-'+(tipo==='admin'?'adm':'lj');
  const b=$(bid);if(b){b.classList.remove('seguindo');b.innerHTML='&#128247;';}
  mapas[tipo]&&mapas[tipo].setView(RP,13);
}

// ADMIN
async function initAdmin(){
  const{data:e}=await db.from('usuarios').select('id').eq('tipo','entregador').eq('status','ativo');
  const{data:l}=await db.from('usuarios').select('id').eq('tipo','loja').eq('status','ativo');
  $('adm-ent').textContent=e?e.length:0;$('adm-loj').textContent=l?l.length:0;
  criarMapa('admin');await pullAdm();ivs.mAdm=setInterval(pullAdm,15000);
}
async function pullAdm(){
  const{data:ents}=await db.from('usuarios').select('id,nome,telefone,latitude,longitude').eq('tipo','entregador').eq('online',true);
  $('adm-on').textContent=ents?ents.length:0;
  const el=$('lista-on-adm');
  el.innerHTML=ents&&ents.length?ents.map(e=>`<span class="badge b-online">&#128994; ${e.nome}</span>`).join(''):'<span style="font-size:13px;color:#999">Nenhum online</span>';
  await atuMapa('admin',ents||[]);
}
async function abrirEntAdm(){
  openM('adm-ent');$('adm-ent-lst').innerHTML='<p>Carregando...</p>';
  const{data}=await db.from('usuarios').select('*').eq('tipo','entregador');
  if(!data||!data.length){$('adm-ent-lst').innerHTML='<p>Nenhum</p>';return;}
  $('adm-ent-lst').innerHTML=data.map(e=>`
    <div class="litem">
      <div style="flex:1"><strong>${e.nome}</strong> <span class="badge ${e.online?'b-online':'b-offline'}">${e.online?'Online':'Offline'}</span><br>
      <small style="color:#888">Tel:${e.telefone||'-'} | Placa:${e.placa_moto||'-'} | Pix:${e.chave_pix||'-'}</small></div>
      <div style="display:flex;flex-direction:column;gap:5px;align-items:flex-end">
        <span class="badge b-${e.status}">${e.status}</span>
        <button class="btn-sm ${e.status==='ativo'?'red':'green'}" onclick="toggleSt('${e.id}','${e.status}','adm-ent')">${e.status==='ativo'?'Bloquear':'Ativar'}</button>
      </div>
    </div>`).join('');
}
async function abrirLojAdm(){
  openM('adm-loj');$('adm-loj-lst').innerHTML='<p>Carregando...</p>';
  const{data}=await db.from('usuarios').select('*').eq('tipo','loja');
  if(!data||!data.length){$('adm-loj-lst').innerHTML='<p>Nenhuma</p>';return;}
  $('adm-loj-lst').innerHTML=data.map(l=>`
    <div class="litem" style="flex-direction:column;align-items:flex-start">
      <div style="display:flex;justify-content:space-between;width:100%;margin-bottom:8px">
        <div><strong>${l.nome_loja||l.nome}</strong> <span style="font-size:12px;font-weight:700;color:#888">[${l.codigo_loja||'---'}]</span><br>
        <small style="color:#888">${l.endereco||''}</small></div>
        <span class="badge b-${l.status}">${l.status}</span>
      </div>
      <div class="row" style="flex-wrap:wrap">
        <label style="font-size:12px;color:#666">Taxa R$</label>
        <input type="number" id="tx-${l.id}" value="${parseFloat(l.taxa_sistema||0.50).toFixed(2)}" step="0.01" min="0" style="width:72px;padding:6px;border:1.5px solid #e0e0e0;border-radius:6px;font-size:13px">
        <button class="btn-sm blue" onclick="saveTaxAdm('${l.id}')">Salvar</button>
        <button class="btn-sm ${l.status==='ativo'?'red':'green'}" onclick="toggleSt('${l.id}','${l.status}','adm-loj')">${l.status==='ativo'?'Bloquear':'Ativar'}</button>
      </div>
      <small id="tx-msg-${l.id}" style="color:#27ae60;margin-top:3px"></small>
    </div>`).join('');
}
async function toggleSt(id,st,modal){
  const novo=st==='ativo'?'bloqueado':'ativo';
  await db.from('usuarios').update({status:novo}).eq('id',id);
  if(modal==='adm-loj')abrirLojAdm();else abrirEntAdm();
}
async function saveTaxAdm(id){
  const val=parseFloat($('tx-'+id).value);
  await db.from('usuarios').update({taxa_sistema:val}).eq('id',id);
  const m=$('tx-msg-'+id);m.textContent='Salvo!';setTimeout(()=>{m.textContent='';},2000);
}
async function abrirFinAdm(){
  openM('adm-fin');const{data:l}=await db.from('usuarios').select('*').eq('tipo','loja');
  $('adm-fin-lst').innerHTML=(!l||!l.length)?'<p>Nenhuma</p>':l.map(x=>`<div class="litem"><div><strong>${x.nome_loja||x.nome}</strong><br><small>Taxa:${fR(x.taxa_sistema)}/entrega</small></div><span class="badge b-${x.status}">${x.status}</span></div>`).join('');
}
async function abrirCobAdm(){
  openM('adm-cob');const{data:l}=await db.from('usuarios').select('*').eq('tipo','loja');
  const hoje=new Date(),d=(3-hoje.getDay()+7)%7||7,prox=new Date(hoje);prox.setDate(hoje.getDate()+d);
  $('adm-cob-lst').innerHTML=`<p style="margin-bottom:12px">Proxima: <strong>${prox.toLocaleDateString('pt-BR')}</strong></p>`+
    (!l||!l.length?'<p>Sem lojas</p>':l.map(x=>`<div class="litem"><div><strong>${x.nome_loja||x.nome}</strong><br><small>Taxa:${fR(x.taxa_sistema)}/ent</small></div><span class="badge b-${x.status}">${x.status}</span></div>`).join(''));
}

// LOJA
async function initLoja(){
  const{data}=await db.from('usuarios').select('*').eq('id',U.id).single();
  if(data){U={...U,...data};localStorage.setItem('u',JSON.stringify(U));}
  $('loja-nome').textContent=U.nome_loja||U.nome;
  $('loja-cod').textContent=U.codigo_loja||'------';
  $('lj-ts').textContent=fR(U.taxa_sistema);$('lj-te').textContent=fR(U.taxa_entrega);
  $('lj-taxa-new').value=parseFloat(U.taxa_entrega||0).toFixed(2);
  const{data:ent}=await db.from('entregas').select('id').eq('loja_id',U.id).gte('created_at',iDia()).lte('created_at',fDia());
  $('lj-hj').textContent=ent?ent.length:0;
  criarMapa('loja');await pullLj();ivs.mLj=setInterval(pullLj,15000);
}
async function pullLj(){
  const{data:assoc}=await db.from('loja_entregadores').select('entregador_id').eq('loja_id',U.id).eq('status','ativo');
  const el=$('lista-on-lj');
  if(!assoc||!assoc.length){el.innerHTML='<span style="font-size:13px;color:#999">Nenhum entregador vinculado.</span>';return;}
  const ids=assoc.map(a=>a.entregador_id);
  const{data:ents}=await db.from('usuarios').select('id,nome,telefone,latitude,longitude').in('id',ids).eq('online',true);
  el.innerHTML=ents&&ents.length?ents.map(e=>`<span class="badge b-online">&#128994; ${e.nome}</span>`).join(''):'<span style="font-size:13px;color:#999">Nenhum online agora.</span>';
  await atuMapa('loja',ents||[]);
}
async function salvarTaxaLj(){
  const val=parseFloat(v('lj-taxa-new'));if(isNaN(val)||val<0){$('taxa-msg').textContent='Invalido';return;}
  await db.from('usuarios').update({taxa_entrega:val}).eq('id',U.id);
  U.taxa_entrega=val;localStorage.setItem('u',JSON.stringify(U));
  $('lj-te').textContent=fR(val);$('taxa-msg').style.color='#27ae60';$('taxa-msg').textContent='Salvo!';
  setTimeout(()=>{$('taxa-msg').textContent='';},2000);
}

// OCR
function abrirNovoPedido(){
  openM('pedido');
  $('ocr-input').value='';$('ocr-prev').classList.add('hidden');$('ocr-load').classList.add('hidden');
  ['p-num','p-cli','p-tel','p-rua','p-nend','p-bairro','p-obs','p-comp'].forEach(id=>{const e=$(id);if(e)e.value='';});
  $('p-cidade').value='Ribeirao Preto';clearM('ped-msg');
}
async function lerComanda(event){
  const file=event.target.files[0];if(!file)return;
  const url=URL.createObjectURL(file);
  $('ocr-img').src=url;$('ocr-prev').classList.remove('hidden');
  $('ocr-load').classList.remove('hidden');
  $('ocr-fill').style.width='0%';$('ocr-pct').textContent='0%';
  try{
    const{data:{text}}=await Tesseract.recognize(file,'por',{
      logger:m=>{
        if(m.status==='recognizing text'){
          const p=Math.round(m.progress*100);
          $('ocr-fill').style.width=p+'%';$('ocr-pct').textContent=p+'%';
        }
      }
    });
    $('ocr-load').classList.add('hidden');
    parseOcr(text);
  }catch(err){$('ocr-load').classList.add('hidden');console.warn('OCR:',err);}
}
function parseOcr(text){
  const full=text.replace(/\n/g,' ');
  const lines=text.split('\n').map(l=>l.trim()).filter(Boolean);
  // Numero pedido
  const pm=full.match(/(?:pedido|ordem|n[?o]\.?|#)\s*:?\s*([A-Z0-9\-]{3,12})/i)||full.match(/\b(\d{3,6})\b/);
  if(pm)$('p-num').value=pm[1];
  // Telefone
  const tm=full.match(/\(?\d{2}\)?\s*9?\d{4}[\s\-]?\d{4}/);
  if(tm)$('p-tel').value=tm[0].replace(/[\s\-]/g,'');
  // Nome cliente
  for(let i=0;i<lines.length;i++){
    if(/cliente|nome|entregar/i.test(lines[i])&&lines[i+1]&&lines[i+1].length>2&&lines[i+1].length<50){
      $('p-cli').value=lines[i+1];break;
    }
  }
  // Endereco
  const em=full.match(/(rua|r\.|av\.?|avenida|alameda|al\.|travessa)\s+([^,\n]+?),?\s*(\d+)/i);
  if(em){$('p-rua').value=em[1]+' '+em[2].trim();$('p-nend').value=em[3];}
  // Bairro
  const bm=full.match(/(?:bairro|bro)\s*:?\s*([A-Za-z\s]{3,30})/i);
  if(bm)$('p-bairro').value=bm[1].trim();
  // Complemento
  const cm=full.match(/(?:apto?|apartamento|bloco|torre|sala|loja)\.?\s+[\w\d]+/i);
  if(cm)$('p-comp').value=cm[0];
}
async function salvarPedido(){
  const rua=v('p-rua');if(!rua){showM('ped-msg','Informe a rua');return;}
  const num=v('p-nend'),bairro=v('p-bairro'),cidade=v('p-cidade')||'Ribeirao Preto',comp=v('p-comp');
  const dados={
    loja_id:U.id,numero_pedido:v('p-num'),cliente_nome:v('p-cli'),cliente_telefone:v('p-tel'),
    endereco_entrega:fEnd(rua,num,bairro,cidade,comp),
    endereco_rua:rua,endereco_numero:num,endereco_bairro:bairro,endereco_cidade:cidade,endereco_complemento:comp,
    valor_sistema:parseFloat(U.taxa_sistema||0),valor_entregador:parseFloat(U.taxa_entrega||0),
    status:'pendente',ordem_rota:99
  };
  const{error}=await db.from('entregas').insert([dados]);
  if(error){showM('ped-msg','Erro: '+error.message);return;}
  showM('ped-msg','Pedido salvo!',true);
  const{data:ent}=await db.from('entregas').select('id').eq('loja_id',U.id).gte('created_at',iDia()).lte('created_at',fDia());
  $('lj-hj').textContent=ent?ent.length:0;
  setTimeout(()=>closeM('pedido'),1200);
}

async function abrirPedidosLj(){openM('rota');carregarPedidos();}
async function carregarPedidos(){
  $('rota-lst').innerHTML='<p>Carregando...</p>';
  const{data}=await db.from('entregas').select('*,entregador:entregador_id(nome)').eq('loja_id',U.id).neq('status','entregue').order('ordem_rota');
  if(!data||!data.length){$('rota-lst').innerHTML='<p style="color:#999;text-align:center;padding:20px">Sem pedidos. Use "Novo Pedido".</p>';return;}
  $('rota-lst').innerHTML=data.map((e,i)=>`
    <div class="ecard ${e.status==='em_rota'?'rota':''}">
      <div style="display:flex;justify-content:space-between;margin-bottom:4px">
        <strong>${i+1}. ${e.numero_pedido?'#'+e.numero_pedido:e.cliente_nome||'Entrega'}</strong>
        <span class="badge b-${e.status}">${e.status}</span>
      </div>
      <p style="font-size:13px;color:#555">&#128205; ${e.endereco_entrega}</p>
      ${e.cliente_nome?`<p style="font-size:12px;color:#888">&#128100; ${e.cliente_nome}${e.cliente_telefone?' | '+e.cliente_telefone:''}</p>`:''}
      ${e.entregador?`<p style="font-size:12px;color:#004E89">&#128757; ${e.entregador.nome}</p>`:''}
      <div class="row" style="margin-top:7px">
        <button class="btn-sm green" onclick="marcarEnt('${e.id}')">&#10003; Entregue</button>
        <button class="btn-sm red" onclick="cancelarEnt('${e.id}')">Cancelar</button>
      </div>
    </div>`).join('');
}
async function otimizarRota(){
  const{data}=await db.from('entregas').select('id').eq('loja_id',U.id).eq('status','pendente').order('created_at');
  if(!data||!data.length){alert('Sem pedidos pendentes.');return;}
  for(let i=0;i<data.length;i++)await db.from('entregas').update({ordem_rota:i+1}).eq('id',data[i].id);
  alert('Rota organizada!');carregarPedidos();
}
async function enviarRota(){
  const{data:assoc}=await db.from('loja_entregadores').select('entregador_id,e:entregador_id(nome,online)').eq('loja_id',U.id).eq('status','ativo');
  const on=(assoc||[]).filter(a=>a.e&&a.e.online);
  if(!on.length){alert('Nenhum entregador online vinculado.');return;}
  const{data:ents}=await db.from('entregas').select('id').eq('loja_id',U.id).eq('status','pendente');
  if(!ents||!ents.length){alert('Sem pedidos pendentes.');return;}
  const eid=on[0].entregador_id;
  for(const e of ents)await db.from('entregas').update({entregador_id:eid,status:'em_rota'}).eq('id',e.id);
  alert(`Rota enviada para ${on[0].e.nome}!`);carregarPedidos();
}
async function marcarEnt(id){
  await db.from('entregas').update({status:'entregue',entregue_at:new Date().toISOString()}).eq('id',id);
  carregarPedidos();
  const{data:ent}=await db.from('entregas').select('id').eq('loja_id',U.id).gte('created_at',iDia()).lte('created_at',fDia());
  $('lj-hj').textContent=ent?ent.length:0;
}
async function cancelarEnt(id){if(!confirm('Cancelar?'))return;await db.from('entregas').delete().eq('id',id);carregarPedidos();}

async function abrirRelLj(){openM('rel');carregarRel();}
async function carregarRel(){
  const p=$('rel-f').value,el=$('rel-dados');el.innerHTML='<p>Carregando...</p>';
  const{data:ents}=await db.from('entregas').select('*,entregador:entregador_id(nome)').eq('loja_id',U.id).gte('created_at',iPer(p));
  if(!ents||!ents.length){el.innerHTML='<p style="color:#999;text-align:center;padding:20px">Sem entregas.</p>';return;}
  const tS=ents.reduce((s,e)=>s+parseFloat(e.valor_sistema||0),0);
  const tE=ents.reduce((s,e)=>s+parseFloat(e.valor_entregador||0),0);
  const pE={};
  ents.forEach(e=>{const k=e.entregador_id||'sem';if(!pE[k])pE[k]={nome:e.entregador?e.entregador.nome:'Sem entregador',lista:[],total:0};pE[k].lista.push(e);pE[k].total+=parseFloat(e.valor_entregador||0);});
  el.innerHTML=`
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:14px">
      <div style="background:#fff3e0;padding:10px;border-radius:8px;text-align:center"><p style="font-size:10px;color:#888">Entregas</p><p style="font-size:22px;font-weight:700;color:#FF6B35">${ents.length}</p></div>
      <div style="background:#e3f2fd;padding:10px;border-radius:8px;text-align:center"><p style="font-size:10px;color:#888">Sistema</p><p style="font-size:14px;font-weight:700;color:#004E89">${fR(tS)}</p></div>
      <div style="background:#e8f5e9;padding:10px;border-radius:8px;text-align:center"><p style="font-size:10px;color:#888">Entregad.</p><p style="font-size:14px;font-weight:700;color:#00C9A7">${fR(tE)}</p></div>
    </div>
    ${Object.values(pE).map(g=>`
      <div class="secao"><div class="s-title">&#128757; ${g.nome} &mdash; ${fR(g.total)}</div>
      ${g.lista.map((e,i)=>`<div style="padding:7px 0;border-bottom:1px solid #f0f0f0;font-size:13px">
        <div style="display:flex;justify-content:space-between"><strong>${e.numero_pedido?'#'+e.numero_pedido:e.cliente_nome||'Ent '+(i+1)}</strong><span class="badge b-${e.status}">${e.status}</span></div>
        <p style="color:#555;margin:2px 0">&#128205; ${e.endereco_entrega}</p>
        <p style="color:#999;font-size:12px">Sist:${fR(e.valor_sistema)} | Ent:${fR(e.valor_entregador)}</p>
      </div>`).join('')}</div>`).join('')}`;
}

async function abrirGerEnt(){openM('ger');$('ger-cod').textContent=U.codigo_loja||'------';carregarGer();}
async function carregarGer(){
  $('ger-lst').innerHTML='<p>Carregando...</p>';
  const{data:assoc}=await db.from('loja_entregadores').select('*,e:entregador_id(id,nome,telefone,placa_moto,online)').eq('loja_id',U.id);
  if(!assoc||!assoc.length){$('ger-lst').innerHTML='<p style="color:#999;margin-top:10px">Nenhum vinculado ainda.</p>';return;}
  $('ger-lst').innerHTML=assoc.map(a=>`
    <div class="litem">
      <div style="flex:1"><strong>${a.e?a.e.nome:'Removido'}</strong> <span class="badge ${a.e&&a.e.online?'b-online':'b-offline'}">${a.e&&a.e.online?'Online':'Offline'}</span><br>
      <small style="color:#888">Tel:${a.e?a.e.telefone||'-':'-'} | Placa:${a.e?a.e.placa_moto||'-':'-'}</small></div>
      <button class="btn-sm red" onclick="remEnt('${a.id}')">Remover</button>
    </div>`).join('');
}
async function remEnt(id){if(!confirm('Remover?'))return;await db.from('loja_entregadores').delete().eq('id',id);carregarGer();}

async function abrirCfgLj(){
  openM('cfg-lj');
  const{data}=await db.from('usuarios').select('*').eq('id',U.id).single();
  if(data){
    $('cfg-nlj').value=data.nome_loja||'';$('cfg-tel').value=data.telefone||'';$('cfg-cnpj').value=data.cnpj||'';
    $('cfg-rua').value=data.endereco_rua||'';$('cfg-nend').value=data.endereco_numero||'';
    $('cfg-bairro').value=data.endereco_bairro||'';$('cfg-cidade').value=data.endereco_cidade||data.cidade||'Ribeirao Preto';
    $('cfg-comp').value=data.endereco_complemento||'';
    if(data.horario_abertura)$('cfg-ab').value=String(data.horario_abertura).substring(0,5);
    if(data.horario_fechamento)$('cfg-fch').value=String(data.horario_fechamento).substring(0,5);
  }
  clearM('cfg-lj-msg');$('cfg-senha').value='';
}
async function salvarCfgLj(){
  const rua=v('cfg-rua'),num=v('cfg-nend'),bairro=v('cfg-bairro'),cidade=v('cfg-cidade')||'Ribeirao Preto',comp=v('cfg-comp');
  const d={nome_loja:v('cfg-nlj'),telefone:v('cfg-tel'),cnpj:v('cfg-cnpj'),cidade,
    endereco:fEnd(rua,num,bairro,cidade,comp),
    endereco_rua:rua,endereco_numero:num,endereco_bairro:bairro,endereco_cidade:cidade,endereco_complemento:comp,
    horario_abertura:v('cfg-ab')||null,horario_fechamento:v('cfg-fch')||null};
  const ns=v('cfg-senha');if(ns.length>=6)d.senha_hash=ns;
  const{error}=await db.from('usuarios').update(d).eq('id',U.id);
  if(error){showM('cfg-lj-msg','Erro: '+error.message);return;}
  U={...U,...d};localStorage.setItem('u',JSON.stringify(U));
  $('loja-nome').textContent=d.nome_loja||U.nome;showM('cfg-lj-msg','Salvo!',true);setTimeout(()=>closeM('cfg-lj'),1500);
}

// ENTREGADOR
async function initEnt(){
  const{data}=await db.from('usuarios').select('*').eq('id',U.id).single();
  if(data){U={...U,...data};localStorage.setItem('u',JSON.stringify(U));}
  $('ent-nome').textContent=U.nome;atuBtnOn(U.online);
  if(U.foto_url){$('foto-img').src=U.foto_url;$('foto-img').classList.remove('hidden');$('foto-ph').classList.add('hidden');}
  const{data:e}=await db.from('entregas').select('id,valor_entregador').eq('entregador_id',U.id).gte('created_at',iDia()).lte('created_at',fDia());
  $('ent-cnt').textContent=e?e.length:0;
  const g=e?e.reduce((s,x)=>s+parseFloat(x.valor_entregador||0),0):0;
  $('ent-gnh').textContent=fR(g);
  if(U.online)inicRast();
  carregarMinhasLojas();
}
async function carregarMinhasLojas(){
  const{data:assoc}=await db.from('loja_entregadores').select('loja_id,l:loja_id(nome_loja,nome)').eq('entregador_id',U.id).eq('status','ativo');
  const el=$('minhas-lojas');
  if(!assoc||!assoc.length){el.innerHTML='<p style="font-size:13px;color:#999">Nenhuma loja vinculada ainda.</p>';return;}
  el.innerHTML=assoc.map(a=>`<span class="badge b-em_rota" style="margin:3px">&#127978; ${a.l?(a.l.nome_loja||a.l.nome):'Loja'}</span>`).join('');
}
async function conectarCodigo(){
  const cod=v('cod-loja-inp').toUpperCase();const msg=$('msg-cod');
  if(cod.length<4){msg.className='msg-error';msg.textContent='Digite o codigo';return;}
  const{data:loja}=await db.from('usuarios').select('id,nome_loja,nome').eq('codigo_loja',cod).eq('tipo','loja').single();
  if(!loja){msg.className='msg-error';msg.textContent='Codigo nao encontrado. Confirme com a loja.';return;}
  const{error}=await db.from('loja_entregadores').insert([{loja_id:loja.id,entregador_id:U.id}]);
  if(error&&error.code==='23505'){msg.className='msg-error';msg.textContent='Voce ja esta vinculado a esta loja.';return;}
  if(error){msg.className='msg-error';msg.textContent='Erro: '+error.message;return;}
  msg.className='msg-ok';msg.textContent='Conectado a '+(loja.nome_loja||loja.nome)+'!';
  $('cod-loja-inp').value='';setTimeout(()=>{msg.textContent='';},3000);carregarMinhasLojas();
}
function atuBtnOn(on){
  const c=$('btn-on-card');
  if(on){c.style.background='linear-gradient(135deg,#00C9A7,#007a65)';$('ico-on').innerHTML='&#128308;';$('txt-on').textContent='Ficar Offline';$('txt-on').style.color='white';$('ent-st').textContent='&#128994; Online';}
  else{c.style.background='';$('ico-on').innerHTML='&#128994;';$('txt-on').textContent='Ficar Online';$('txt-on').style.color='';$('ent-st').textContent='&#9899; Offline';}
}
async function toggleOnline(){
  const novo=!U.online;
  await db.from('usuarios').update({online:novo}).eq('id',U.id);
  U.online=novo;localStorage.setItem('u',JSON.stringify(U));atuBtnOn(novo);
  if(novo)inicRast();else{if(ivs.rast){clearInterval(ivs.rast);ivs.rast=null;}}
}
function inicRast(){
  if(ivs.rast)clearInterval(ivs.rast);
  const fn=()=>{
    if(!U||!U.online)return;
    navigator.geolocation&&navigator.geolocation.getCurrentPosition(
      p=>db.from('usuarios').update({latitude:p.coords.latitude,longitude:p.coords.longitude}).eq('id',U.id),
      ()=>{},{enableHighAccuracy:true,timeout:12000}
    );
  };
  fn();ivs.rast=setInterval(fn,20000);
}
function abrirFoto(){$('input-foto').click();}
async function uploadFoto(event){
  const file=event.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=async function(e){
    const b=e.target.result;
    await db.from('usuarios').update({foto_url:b}).eq('id',U.id);
    U.foto_url=b;localStorage.setItem('u',JSON.stringify(U));
    $('foto-img').src=b;$('foto-img').classList.remove('hidden');$('foto-ph').classList.add('hidden');
  };
  reader.readAsDataURL(file);
}
async function abrirRotaEnt(){
  openM('rota-ent');
  const{data}=await db.from('entregas').select('*').eq('entregador_id',U.id).eq('status','em_rota').order('ordem_rota');
  if(!data||!data.length){$('rota-ent-lst').innerHTML='<p style="color:#999;text-align:center;padding:20px">Nenhuma entrega atribuida.</p>';return;}
  const ends=data.map(e=>encodeURIComponent(e.endereco_entrega));
  const dest=ends[ends.length-1],wp=ends.slice(0,-1).join('|');
  const url=`https://www.google.com/maps/dir/?api=1&destination=${dest}${wp?'&waypoints='+wp:''}&travelmode=driving`;
  $('rota-ent-lst').innerHTML=`
    <button class="btn btn-green" onclick="window.open('${url}','_blank')" style="margin-bottom:14px">&#127758; Abrir Rota no Maps</button>
    ${data.map((e,i)=>`
      <div class="ecard rota">
        <strong>${i+1}. ${e.numero_pedido?'#'+e.numero_pedido:e.cliente_nome||'Entrega'}</strong><br>
        <p style="font-size:13px;color:#555;margin:3px 0">&#128205; ${e.endereco_entrega}</p>
        ${e.cliente_nome?`<p style="font-size:12px;color:#888">&#128100; ${e.cliente_nome}${e.cliente_telefone?` | <a href="tel:${e.cliente_telefone}" style="color:#004E89;font-weight:600">&#128222; ${e.cliente_telefone}</a>`:''}</p>`:''}
        <div class="row" style="margin-top:7px">
          <button class="btn-sm green" onclick="entMarcaEnt('${e.id}')">&#10003; Entregue</button>
          <a href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(e.endereco_entrega)}&travelmode=driving" target="_blank">
            <button class="btn-sm blue" style="margin:0">&#127758; Ir</button>
          </a>
        </div>
      </div>`).join('')}`;
}
async function entMarcaEnt(id){
  await db.from('entregas').update({status:'entregue',entregue_at:new Date().toISOString()}).eq('id',id);
  abrirRotaEnt();initEnt();
}
async function abrirGanhosEnt(){openM('ganhos');carregarGanhos();}
async function carregarGanhos(){
  const p=$('gnh-f').value,el=$('gnh-dados');el.innerHTML='<p>Carregando...</p>';
  const{data}=await db.from('entregas').select('*,l:loja_id(nome_loja,nome)').eq('entregador_id',U.id).gte('created_at',iPer(p));
  if(!data||!data.length){el.innerHTML='<p style="color:#999;text-align:center;padding:20px">Sem entregas.</p>';return;}
  const tot=data.reduce((s,e)=>s+parseFloat(e.valor_entregador||0),0);
  el.innerHTML=`
    <div style="background:#e8f5e9;padding:16px;border-radius:12px;text-align:center;margin-bottom:14px">
      <p style="font-size:12px;color:#666">Total do periodo</p>
      <p style="font-size:32px;font-weight:700;color:#2e7d32">${fR(tot)}</p>
      <p style="font-size:13px;color:#666">${data.length} entrega(s)</p>
    </div>
    ${data.map((e,i)=>`<div style="padding:9px 0;border-bottom:1px solid #f0f0f0;font-size:13px">
      <div style="display:flex;justify-content:space-between"><strong>${e.numero_pedido?'#'+e.numero_pedido:e.cliente_nome||'Ent '+(i+1)}</strong><strong style="color:#2e7d32">${fR(e.valor_entregador)}</strong></div>
      <p style="color:#888">&#127978; ${e.l?(e.l.nome_loja||e.l.nome):'Loja'}</p>
      <p style="color:#555">&#128205; ${e.endereco_entrega}</p>
      <span class="badge b-${e.status}">${e.status}</span>
    </div>`).join('')}`;
}
async function abrirCfgEnt(){
  openM('cfg-ent');$('ent-nome2').value=U.nome||'';$('ent-tel2').value=U.telefone||'';$('ent-plc').value=U.placa_moto||'';$('ent-pix').value=U.chave_pix||'';$('ent-sen').value='';clearM('ent-cfg-msg');
}
async function salvarCfgEnt(){
  const d={nome:v('ent-nome2'),telefone:v('ent-tel2'),placa_moto:v('ent-plc'),chave_pix:v('ent-pix')};
  const ns=v('ent-sen');if(ns.length>=6)d.senha_hash=ns;
  const{error}=await db.from('usuarios').update(d).eq('id',U.id);
  if(error){showM('ent-cfg-msg','Erro: '+error.message);return;}
  U={...U,...d};localStorage.setItem('u',JSON.stringify(U));$('ent-nome').textContent=d.nome;showM('ent-cfg-msg','Salvo!',true);setTimeout(()=>closeM('cfg-ent'),1500);
}
</script>
</body>
</html>
