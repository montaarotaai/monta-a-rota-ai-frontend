<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Monta a Rota A&iacute;</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f5f5f5;color:#333;}
.login-container{max-width:400px;margin:40px auto;background:white;padding:28px;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,0.1);}
.logo{text-align:center;margin-bottom:25px;}
.logo img{width:100px;height:100px;border-radius:50%;object-fit:cover;}
h2{text-align:center;color:#004E89;margin-bottom:18px;}
.form-group{margin-bottom:13px;}
label{display:block;margin-bottom:4px;color:#666;font-size:13px;}
input[type=text],input[type=email],input[type=password],input[type=tel],input[type=number],input[type=time],select,textarea{width:100%;padding:11px;border:1px solid #ddd;border-radius:8px;font-size:15px;background:white;}
textarea{resize:vertical;min-height:70px;}
input:focus,select:focus,textarea:focus{outline:none;border-color:#FF6B35;}
button{width:100%;padding:13px;background:linear-gradient(135deg,#FF6B35 0%,#004E89 100%);color:white;border:none;border-radius:8px;font-size:15px;cursor:pointer;margin-top:8px;}
button:hover{opacity:0.9;}button:disabled{opacity:0.6;cursor:not-allowed;}
.tabs{display:flex;margin-bottom:18px;}
.tab{flex:1;padding:10px;text-align:center;cursor:pointer;border-bottom:2px solid #ddd;background:none;color:#333;font-size:14px;margin-top:0;}
.tab.active{border-bottom-color:#FF6B35;color:#FF6B35;font-weight:bold;}
.tab-content{display:none;}.tab-content.active{display:block;}
.user-type{display:flex;gap:10px;margin-bottom:13px;}
.user-type label{flex:1;padding:10px;text-align:center;border:2px solid #ddd;border-radius:8px;cursor:pointer;margin-bottom:0;}
.user-type input:checked+label{border-color:#FF6B35;background:#fff5f2;}
.user-type input{display:none;}
.hidden{display:none!important;}
.error-msg{background:#ffebee;color:#c62828;padding:10px;border-radius:8px;margin-bottom:12px;font-size:13px;}
.success-msg{background:#e8f5e9;color:#2e7d32;padding:10px;border-radius:8px;margin-bottom:12px;font-size:13px;}
.header{background:linear-gradient(135deg,#FF6B35 0%,#004E89 100%);color:white;padding:18px;text-align:center;position:relative;}
.container{padding:16px;max-width:1000px;margin:0 auto;}
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:12px;margin-bottom:16px;}
.card{background:white;padding:16px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08);cursor:pointer;transition:transform .2s;}
.card:hover{transform:translateY(-2px);}
.card h3{font-size:12px;color:#888;margin-bottom:8px;}
.card .value{font-size:24px;font-weight:bold;color:#FF6B35;}
.menu{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;}
.menu-item{background:white;padding:18px;border-radius:12px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.08);cursor:pointer;transition:transform .2s;}
.menu-item:hover{transform:translateY(-2px);}
.menu-item .icon{font-size:28px;margin-bottom:7px;}
.menu-item h3{font-size:13px;}
.logout{position:absolute;top:14px;right:14px;background:rgba(255,255,255,0.2);color:white;padding:7px 13px;border-radius:6px;cursor:pointer;border:none;width:auto;font-size:13px;margin-top:0;}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.55);z-index:1000;overflow-y:auto;}
.modal-content{background:white;margin:12px auto;padding:18px;border-radius:12px;max-width:620px;position:relative;}
.close{position:absolute;top:10px;right:14px;font-size:26px;cursor:pointer;color:#666;}
.list-item{padding:13px;border-bottom:1px solid #eee;}
.list-item:last-child{border-bottom:none;}
.btn-sm{background:#FF6B35;color:white;border:none;padding:6px 11px;border-radius:6px;cursor:pointer;font-size:12px;white-space:nowrap;margin-top:0;width:auto;}
.btn-sm.verde{background:#00C9A7;}.btn-sm.vermelho{background:#e74c3c;}.btn-sm.azul{background:#004E89;}.btn-sm.cinza{background:#888;}
.taxa-input{width:72px;padding:6px;border:1px solid #ddd;border-radius:6px;font-size:13px;text-align:center;}
.badge-ativo{background:#e8f5e9;color:#2e7d32;padding:2px 8px;border-radius:10px;font-size:11px;}
.badge-bloqueado{background:#ffebee;color:#c62828;padding:2px 8px;border-radius:10px;font-size:11px;}
.badge-pendente{background:#fff8e1;color:#f57f17;padding:2px 8px;border-radius:10px;font-size:11px;}
.badge-entregue{background:#e8f5e9;color:#2e7d32;padding:2px 8px;border-radius:10px;font-size:11px;}
.badge-em_rota{background:#e3f2fd;color:#1565c0;padding:2px 8px;border-radius:10px;font-size:11px;}
.foto-placeholder{width:82px;height:82px;border-radius:50%;background:rgba(255,255,255,0.3);display:flex;align-items:center;justify-content:center;font-size:32px;cursor:pointer;border:3px dashed rgba(255,255,255,0.6);margin:0 auto 8px;}
.foto-perfil{width:82px;height:82px;border-radius:50%;object-fit:cover;border:3px solid white;margin-bottom:8px;}
#mapa-loja{height:280px;border-radius:10px;margin-top:8px;}
.entrega-card{background:#f9f9f9;border-radius:8px;padding:11px;margin-bottom:9px;border-left:4px solid #FF6B35;}
.entrega-card.em-rota{border-left-color:#004E89;}
.secao{background:white;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.07);padding:14px;margin-bottom:14px;}
.secao h3{font-size:14px;color:#004E89;margin-bottom:11px;font-weight:600;}
.config-section{margin-bottom:18px;padding-bottom:18px;border-bottom:1px solid #eee;}
.config-section:last-child{border-bottom:none;margin-bottom:0;}
.addr-grid{display:grid;grid-template-columns:2fr 1fr;gap:10px;}
.addr-grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen" class="login-container">
  <div class="logo">
    <img src="logo.png" alt="" onerror="this.style.display='none'">
    <h2>Monta a Rota A&iacute;</h2>
  </div>
  <div class="tabs">
    <button class="tab active" onclick="switchTab('login',this)">Entrar</button>
    <button class="tab" onclick="switchTab('register',this)">Cadastrar</button>
  </div>
  <div id="login-tab" class="tab-content active">
    <div id="login-msg"></div>
    <div class="form-group"><label>Email</label><input type="email" id="login-email" placeholder="seu@email.com"></div>
    <div class="form-group"><label>Senha</label><input type="password" id="login-senha" placeholder="..."></div>
    <button onclick="fazerLogin()" id="btn-login">Entrar</button>
  </div>
  <div id="register-tab" class="tab-content">
    <div id="register-msg"></div>
    <div class="user-type">
      <label><input type="radio" name="register-type" value="loja" checked onchange="toggleCadastro()"> <span>&#127978; Loja</span></label>
      <label><input type="radio" name="register-type" value="entregador" onchange="toggleCadastro()"> <span>&#128757; Entregador</span></label>
    </div>
    <div class="form-group"><label>Nome completo</label><input type="text" id="reg-nome"></div>
    <div class="form-group"><label>Email</label><input type="email" id="reg-email"></div>
    <div class="form-group"><label>Telefone</label><input type="tel" id="reg-telefone" placeholder="(16) 99999-9999"></div>
    <div class="form-group"><label>Senha</label><input type="password" id="reg-senha" placeholder="Minimo 6 caracteres"></div>
    <div id="campos-loja">
      <div class="form-group"><label>Nome da Loja</label><input type="text" id="reg-nome-loja"></div>
      <div class="form-group"><label>CNPJ</label><input type="text" id="reg-cnpj" placeholder="00.000.000/0000-00"></div>
      <div class="addr-grid">
        <div class="form-group"><label>Rua / Avenida</label><input type="text" id="reg-rua" placeholder="Rua Benjamin Constant"></div>
        <div class="form-group"><label>Numero</label><input type="text" id="reg-numero" placeholder="241"></div>
      </div>
      <div class="addr-grid2">
        <div class="form-group"><label>Bairro</label><input type="text" id="reg-bairro" placeholder="Centro"></div>
        <div class="form-group"><label>Cidade</label><input type="text" id="reg-cidade" value="Ribeirao Preto"></div>
      </div>
      <div class="form-group"><label>Complemento</label><input type="text" id="reg-complemento" placeholder="Sala 2, Loja A..."></div>
    </div>
    <div id="campos-entregador" class="hidden">
      <div class="form-group"><label>Placa da Moto</label><input type="text" id="reg-placa" placeholder="ABC-1234"></div>
      <div class="form-group"><label>Chave Pix</label><input type="text" id="reg-pix" placeholder="CPF, email ou telefone"></div>
    </div>
    <button onclick="fazerCadastro()" id="btn-cadastrar">Cadastrar</button>
  </div>
</div>

<!-- DASHBOARD ADMIN -->
<div id="dashboard-admin" class="hidden">
  <div class="header">
    <button class="logout" onclick="fazerLogout()">Sair</button>
    <img src="logo.png" alt="" onerror="this.style.display='none'">
    <h1>Monta a Rota A&iacute;</h1>
    <p>Dashboard Administrativo</p>
  </div>
  <div class="container">
    <div class="cards">
      <div class="card" onclick="carregarEntregadores()"><h3>Entregadores</h3><div class="value" id="total-entregadores">-</div></div>
      <div class="card" onclick="carregarLojas()"><h3>Lojas Ativas</h3><div class="value" id="total-lojas">-</div></div>
    </div>
    <div class="menu">
      <div class="menu-item" onclick="carregarEntregadores()"><div class="icon">&#128757;</div><h3>Entregadores</h3></div>
      <div class="menu-item" onclick="carregarLojas()"><div class="icon">&#127978;</div><h3>Lojas</h3></div>
      <div class="menu-item" onclick="abrirFinanceiroAdmin()"><div class="icon">&#128176;</div><h3>Financeiro</h3></div>
      <div class="menu-item" onclick="abrirCobrancas()"><div class="icon">&#128197;</div><h3>Cobrancas</h3></div>
    </div>
  </div>
</div>

<!-- DASHBOARD LOJA -->
<div id="dashboard-loja" class="hidden">
  <div class="header">
    <button class="logout" onclick="fazerLogout()">Sair</button>
    <h1 id="nome-loja-display">Minha Loja</h1>
    <p>Area da Loja</p>
  </div>
  <div class="container">
    <div class="cards">
      <div class="card"><h3>Taxa Sistema</h3><div class="value" id="taxa-sistema-loja">-</div></div>
      <div class="card"><h3>Taxa Entregador</h3><div class="value" id="taxa-entregador-loja">-</div></div>
      <div class="card"><h3>Entregas Hoje</h3><div class="value" id="entregas-hoje-loja">0</div></div>
    </div>
    <div class="secao">
      <h3>&#128176; Taxa por entrega ao entregador</h3>
      <div style="display:flex;gap:10px;align-items:center;">
        <input type="number" id="nova-taxa-entregador" placeholder="R$ 0,00" step="0.10" min="0" style="flex:1;">
        <button onclick="salvarTaxaEntregador()" style="width:auto;padding:10px 16px;margin:0;font-size:13px;">Salvar</button>
      </div>
      <div id="taxa-msg" style="margin-top:5px;font-size:13px;"></div>
    </div>
    <div class="secao">
      <h3>&#128205; Entregadores Online Agora</h3>
      <div id="mapa-loja"></div>
      <div id="lista-online-loja" style="margin-top:10px;"></div>
    </div>
    <div class="menu">
      <div class="menu-item" onclick="abrirScannerComanda()"><div class="icon">&#128247;</div><h3>Scanear Comanda</h3></div>
      <div class="menu-item" onclick="abrirEntregasLoja()"><div class="icon">&#128230;</div><h3>Pedidos / Rota</h3></div>
      <div class="menu-item" onclick="abrirRelatorioLoja()"><div class="icon">&#128202;</div><h3>Relatorio</h3></div>
      <div class="menu-item" onclick="abrirGerenciarEntregadores()"><div class="icon">&#128101;</div><h3>Entregadores</h3></div>
      <div class="menu-item" onclick="abrirConfiguracoesLoja()" style="grid-column:1/-1;"><div class="icon">&#9881;</div><h3>Configuracoes</h3></div>
    </div>
  </div>
</div>

<!-- DASHBOARD ENTREGADOR -->
<div id="dashboard-entregador" class="hidden">
  <div class="header">
    <button class="logout" onclick="event.stopPropagation();fazerLogout()">Sair</button>
    <div onclick="abrirFotoPerfil()" style="cursor:pointer;">
      <div class="foto-placeholder" id="foto-placeholder">&#128100;</div>
      <img id="foto-entregador" class="foto-perfil hidden" src="" alt="">
    </div>
    <h1 id="nome-entregador-display">Entregador</h1>
    <p><span id="status-online-texto">&#9899; Offline</span></p>
    <input type="file" id="input-foto" accept="image/*" class="hidden" onchange="uploadFoto(event)">
  </div>
  <div class="container">
    <div class="cards">
      <div class="card"><h3>Entregas Hoje</h3><div class="value" id="minhas-entregas">0</div></div>
      <div class="card"><h3>Ganhos Hoje</h3><div class="value" id="meus-ganhos">R$ 0</div></div>
    </div>
    <div class="menu">
      <div class="menu-item" id="btn-online-card" onclick="toggleOnline()">
        <div class="icon" id="icone-online">&#128994;</div>
        <h3 id="texto-online">Ficar Online</h3>
      </div>
      <div class="menu-item" onclick="abrirRotaEntregador()"><div class="icon">&#127758;</div><h3>Minha Rota</h3></div>
      <div class="menu-item" onclick="abrirGanhos()"><div class="icon">&#128181;</div><h3>Meus Ganhos</h3></div>
      <div class="menu-item" onclick="abrirConfiguracoes()"><div class="icon">&#9881;</div><h3>Configuracoes</h3></div>
    </div>
  </div>
</div>

<!-- MODAIS -->
<div id="modal-entregadores" class="modal"><div class="modal-content">
  <span class="close" onclick="closeModal('entregadores')">&times;</span>
  <h2>Entregadores</h2>
  <div id="lista-entregadores"><p>Carregando...</p></div>
</div></div>

<div id="modal-lojas" class="modal"><div class="modal-content">
  <span class="close" onclick="closeModal('lojas')">&times;</span>
  <h2>Lojas</h2>
  <div id="lista-lojas"><p>Carregando...</p></div>
</div></div>

<div id="modal-financeiro-admin" class="modal"><div class="modal-content">
  <span class="close" onclick="closeModal('financeiro-admin')">&times;</span>
  <h2>Financeiro Geral</h2>
  <div id="dados-financeiro-admin"></div>
</div></div>

<div id="modal-cobrancas" class="modal"><div class="modal-content">
  <span class="close" onclick="closeModal('cobrancas')">&times;</span>
  <h2>Cobrancas Semanais</h2>
  <div id="lista-cobrancas"></div>
</div></div>

<!-- Scanner -->
<div id="modal-scanner" class="modal"><div class="modal-content">
  <span class="close" onclick="closeModal('scanner')">&times;</span>
  <h2>&#128247; Scanear Comanda</h2>
  <p style="color:#666;font-size:13px;margin-bottom:12px;">Tire foto da comanda. A IA extrai os dados automaticamente.</p>
  <div style="text-align:center;margin-bottom:14px;">
    <button onclick="document.getElementById('foto-comanda').click()" style="width:auto;padding:11px 22px;">&#128247; Tirar / Selecionar Foto</button>
    <input type="file" id="foto-comanda" accept="image/*" capture="environment" class="hidden" onchange="processarComanda(event)">
  </div>
  <div id="scanner-loading" class="hidden" style="text-align:center;padding:20px;"><p>&#129300; Lendo com IA...</p></div>
  <div id="dados-comanda" class="hidden">
    <div class="secao">
      <h3>Dados Extraidos — confirme antes de salvar</h3>
      <div class="form-group"><label>Numero do Pedido</label><input type="text" id="ped-numero"></div>
      <div class="form-group"><label>Nome do Cliente</label><input type="text" id="ped-cliente"></div>
      <div class="form-group"><label>Telefone</label><input type="text" id="ped-telefone"></div>
      <div class="addr-grid">
        <div class="form-group"><label>Rua / Avenida</label><input type="text" id="ped-rua"></div>
        <div class="form-group"><label>Numero</label><input type="text" id="ped-num-end"></div>
      </div>
      <div class="addr-grid2">
        <div class="form-group"><label>Bairro</label><input type="text" id="ped-bairro"></div>
        <div class="form-group"><label>Cidade</label><input type="text" id="ped-cidade"></div>
      </div>
      <div class="form-group"><label>Complemento (apto, bloco, torre...)</label><input type="text" id="ped-complemento" placeholder="Ex: Torre 2 Bloco 4 Apto 12"></div>
      <div class="form-group"><label>Observacoes do Pedido</label><input type="text" id="ped-obs"></div>
    </div>
    <button onclick="salvarEntrega()">&#10004; Confirmar e Adicionar a Rota</button>
  </div>
</div></div>

<!-- Entregas/Rota Loja -->
<div id="modal-entregas-loja" class="modal"><div class="modal-content">
  <span class="close" onclick="closeModal('entregas-loja')">&times;</span>
  <h2>&#128230; Pedidos e Rota</h2>
  <div style="margin-bottom:12px;display:flex;gap:8px;flex-wrap:wrap;">
    <button onclick="otimizarRota()" style="width:auto;padding:8px 14px;background:#004E89;font-size:13px;">&#129302; Otimizar Rota</button>
    <button onclick="enviarRotaEntregador()" style="width:auto;padding:8px 14px;background:#00C9A7;font-size:13px;">&#128757; Enviar ao Entregador</button>
  </div>
  <div id="lista-entregas-loja"></div>
</div></div>

<!-- Relatorio Loja -->
<div id="modal-relatorio-loja" class="modal"><div class="modal-content">
  <span class="close" onclick="closeModal('relatorio-loja')">&times;</span>
  <h2>&#128202; Relatorio Financeiro</h2>
  <select id="filtro-periodo" onchange="carregarRelatorioLoja()" style="margin-bottom:14px;">
    <option value="hoje">Hoje</option>
    <option value="semana">Esta semana</option>
    <option value="mes">Este mes</option>
  </select>
  <div id="dados-relatorio-loja"></div>
</div></div>

<!-- Gerenciar Entregadores -->
<div id="modal-gerenciar-ent" class="modal"><div class="modal-content">
  <span class="close" onclick="closeModal('gerenciar-ent')">&times;</span>
  <h2>&#128101; Meus Entregadores</h2>
  <div class="secao">
    <h3>Adicionar por email</h3>
    <div style="display:flex;gap:8px;">
      <input type="email" id="email-entregador" placeholder="email@entregador.com" style="flex:1;">
      <button onclick="adicionarEntregador()" style="width:auto;padding:10px 13px;margin:0;font-size:13px;">Adicionar</button>
    </div>
    <div id="msg-add-ent" style="margin-top:6px;font-size:13px;"></div>
  </div>
  <div id="lista-meus-ent"></div>
</div></div>

<!-- Config Loja -->
<div id="modal-config-loja" class="modal"><div class="modal-content">
  <span class="close" onclick="closeModal('config-loja')">&times;</span>
  <h2>&#9881; Configuracoes da Loja</h2>
  <div class="config-section">
    <p style="font-weight:600;color:#004E89;margin-bottom:12px;">Dados da Loja</p>
    <div class="form-group"><label>Nome da Loja</label><input type="text" id="cfg-nome-loja"></div>
    <div class="form-group"><label>Telefone</label><input type="tel" id="cfg-tel-loja"></div>
    <div class="form-group"><label>CNPJ</label><input type="text" id="cfg-cnpj-loja"></div>
  </div>
  <div class="config-section">
    <p style="font-weight:600;color:#004E89;margin-bottom:12px;">Endereco</p>
    <div class="addr-grid">
      <div class="form-group"><label>Rua / Avenida</label><input type="text" id="cfg-rua"></div>
      <div class="form-group"><label>Numero</label><input type="text" id="cfg-numero"></div>
    </div>
    <div class="addr-grid2">
      <div class="form-group"><label>Bairro</label><input type="text" id="cfg-bairro"></div>
      <div class="form-group"><label>Cidade</label><input type="text" id="cfg-cidade"></div>
    </div>
    <div class="form-group"><label>Complemento</label><input type="text" id="cfg-complemento" placeholder="Sala, Loja, Bloco..."></div>
  </div>
  <div class="config-section">
    <p style="font-weight:600;color:#004E89;margin-bottom:12px;">Horario de Funcionamento</p>
    <div class="addr-grid2">
      <div class="form-group"><label>Abertura</label><input type="time" id="cfg-abertura"></div>
      <div class="form-group"><label>Fechamento</label><input type="time" id="cfg-fechamento"></div>
    </div>
  </div>
  <div class="config-section">
    <p style="font-weight:600;color:#004E89;margin-bottom:12px;">Seguranca</p>
    <div class="form-group"><label>Nova Senha (em branco = nao alterar)</label><input type="password" id="cfg-senha-loja" placeholder="Nova senha"></div>
  </div>
  <div id="cfg-loja-msg"></div>
  <button onclick="salvarConfigLoja()">Salvar Alteracoes</button>
</div></div>

<!-- Ganhos Entregador -->
<div id="modal-ganhos" class="modal"><div class="modal-content">
  <span class="close" onclick="closeModal('ganhos')">&times;</span>
  <h2>&#128181; Meus Ganhos</h2>
  <select id="filtro-ganhos" onchange="carregarGanhos()" style="margin-bottom:14px;">
    <option value="hoje">Hoje</option>
    <option value="semana">Esta semana</option>
    <option value="mes">Este mes</option>
  </select>
  <div id="dados-ganhos"></div>
</div></div>

<!-- Rota Entregador -->
<div id="modal-rota-ent" class="modal"><div class="modal-content">
  <span class="close" onclick="closeModal('rota-ent')">&times;</span>
  <h2>&#127758; Minhas Entregas</h2>
  <div id="lista-rota-ent"></div>
</div></div>

<!-- Config Entregador -->
<div id="modal-configuracoes" class="modal"><div class="modal-content">
  <span class="close" onclick="closeModal('configuracoes')">&times;</span>
  <h2>&#9881; Meus Dados</h2>
  <div class="form-group"><label>Nome</label><input type="text" id="conf-nome"></div>
  <div class="form-group"><label>Telefone</label><input type="tel" id="conf-telefone"></div>
  <div class="form-group"><label>Placa da Moto</label><input type="text" id="conf-placa"></div>
  <div class="form-group"><label>Chave Pix</label><input type="text" id="conf-pix"></div>
  <div class="form-group"><label>Nova Senha (em branco = nao alterar)</label><input type="password" id="conf-senha"></div>
  <div id="conf-msg"></div>
  <button onclick="salvarConfiguracoes()">Salvar Dados</button>
</div></div>

<script>
const SUPABASE_URL='https://dfvjaweyxfenhjgusekq.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRmdmphd2V5eGZlbmhqZ3VzZWtxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzk4NTMsImV4cCI6MjA4NzYxNTg1M30.MT9pzSQgc3ZNGiIV95DwjVtNvSZI0Lz-SKMkvMys1Kg';
const db=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

// Ribeirao Preto coords
const RP_LAT=-21.1767;
const RP_LNG=-47.8208;

let usuarioLogado=null;
let mapaLoja=null;
let marcadores={};
let intervaloRastreamento=null;
let intervaloMapa=null;

window.onload=()=>{
  const s=localStorage.getItem('usuario');
  if(s){usuarioLogado=JSON.parse(s);mostrarDashboard(usuarioLogado.tipo);}
};

function showMsg(id,msg,isError=true){
  const el=document.getElementById(id);if(!el)return;
  el.className=isError?'error-msg':'success-msg';el.textContent=msg;
}
function switchTab(tab,el){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');document.getElementById(tab+'-tab').classList.add('active');
  document.getElementById('login-msg').innerHTML='';document.getElementById('register-msg').innerHTML='';
}
function toggleCadastro(){
  const t=document.querySelector('input[name="register-type"]:checked').value;
  document.getElementById('campos-loja').classList.toggle('hidden',t!=='loja');
  document.getElementById('campos-entregador').classList.toggle('hidden',t!=='entregador');
}
function openModal(t){document.getElementById('modal-'+t).style.display='block';}
function closeModal(t){document.getElementById('modal-'+t).style.display='none';}
window.onclick=e=>{if(e.target.classList.contains('modal'))e.target.style.display='none';};
function formatReal(v){return'R$ '+parseFloat(v||0).toFixed(2).replace('.',',');}
function dataHoje(){return new Date().toISOString().split('T')[0];}
function inicioDia(){const d=new Date();d.setHours(0,0,0,0);return d.toISOString();}
function fimDia(){const d=new Date();d.setHours(23,59,59,999);return d.toISOString();}
function inicioPeriodo(p){
  const n=new Date();
  if(p==='hoje')n.setHours(0,0,0,0);
  else if(p==='semana'){n.setDate(n.getDate()-n.getDay());n.setHours(0,0,0,0);}
  else{n.setDate(1);n.setHours(0,0,0,0);}
  return n.toISOString();
}
function montarEndereco(rua,num,bairro,cidade,complemento){
  let e=[rua,num,bairro,cidade].filter(Boolean).join(', ');
  if(complemento)e+=' — '+complemento;
  return e||'Sem endereco';
}

// LOGIN
async function fazerLogin(){
  const email=document.getElementById('login-email').value.trim();
  const senha=document.getElementById('login-senha').value;
  const btn=document.getElementById('btn-login');
  if(!email||!senha){showMsg('login-msg','Preencha email e senha');return;}
  btn.disabled=true;btn.textContent='Entrando...';
  try{
    const{data:u,error}=await db.from('usuarios').select('*').eq('email',email).single();
    if(error||!u){showMsg('login-msg','Usuario nao encontrado');return;}
    if(u.status==='bloqueado'){showMsg('login-msg','Acesso bloqueado. Contate o administrador.');return;}
    if(senha!==u.senha_hash){showMsg('login-msg','Senha incorreta');return;}
    usuarioLogado=u;localStorage.setItem('usuario',JSON.stringify(u));
    mostrarDashboard(u.tipo);
  }catch(err){showMsg('login-msg','Erro: '+err.message);}
  finally{btn.disabled=false;btn.textContent='Entrar';}
}

// CADASTRO
async function fazerCadastro(){
  const tipo=document.querySelector('input[name="register-type"]:checked').value;
  const nome=document.getElementById('reg-nome').value.trim();
  const email=document.getElementById('reg-email').value.trim();
  const telefone=document.getElementById('reg-telefone').value.trim();
  const senha=document.getElementById('reg-senha').value;
  const btn=document.getElementById('btn-cadastrar');
  if(!nome||!email||!senha){showMsg('register-msg','Preencha nome, email e senha');return;}
  if(senha.length<6){showMsg('register-msg','Senha minimo 6 caracteres');return;}
  btn.disabled=true;btn.textContent='Cadastrando...';
  try{
    const{data:ex}=await db.from('usuarios').select('id').eq('email',email).single();
    if(ex){showMsg('register-msg','Email ja cadastrado');return;}
    const rua=document.getElementById('reg-rua')?document.getElementById('reg-rua').value:'';
    const num=document.getElementById('reg-numero')?document.getElementById('reg-numero').value:'';
    const bairro=document.getElementById('reg-bairro')?document.getElementById('reg-bairro').value:'';
    const cidade=document.getElementById('reg-cidade')?document.getElementById('reg-cidade').value:'Ribeirao Preto';
    const comp=document.getElementById('reg-complemento')?document.getElementById('reg-complemento').value:'';
    const dados={tipo,nome,email,telefone,senha_hash:senha,status:'ativo',taxa_sistema:0.50,taxa_entrega:0,online:false,
      cidade,endereco:montarEndereco(rua,num,bairro,cidade,comp)};
    if(tipo==='loja'){
      dados.nome_loja=document.getElementById('reg-nome-loja').value;
      dados.cnpj=document.getElementById('reg-cnpj').value;
    }else{
      dados.placa_moto=document.getElementById('reg-placa').value;
      dados.chave_pix=document.getElementById('reg-pix').value;
    }
    const{error}=await db.from('usuarios').insert([dados]);
    if(error){showMsg('register-msg','Erro: '+error.message);return;}
    showMsg('register-msg','Cadastro realizado! Faca login.',false);
    setTimeout(()=>{document.querySelectorAll('.tab')[0].click();},1500);
  }catch(err){showMsg('register-msg','Erro: '+err.message);}
  finally{btn.disabled=false;btn.textContent='Cadastrar';}
}

// DASHBOARD
function mostrarDashboard(tipo){
  ['login-screen','dashboard-admin','dashboard-loja','dashboard-entregador'].forEach(id=>document.getElementById(id).classList.add('hidden'));
  document.getElementById('dashboard-'+tipo).classList.remove('hidden');
  if(tipo==='loja'){document.getElementById('nome-loja-display').textContent=usuarioLogado.nome_loja||usuarioLogado.nome;carregarDadosLoja();}
  else if(tipo==='entregador'){document.getElementById('nome-entregador-display').textContent=usuarioLogado.nome;carregarDadosEntregador();}
  else if(tipo==='admin')carregarDadosAdmin();
}

function fazerLogout(){
  if(intervaloRastreamento)clearInterval(intervaloRastreamento);
  if(intervaloMapa)clearInterval(intervaloMapa);
  if(usuarioLogado&&usuarioLogado.online)db.from('usuarios').update({online:false}).eq('id',usuarioLogado.id);
  usuarioLogado=null;localStorage.removeItem('usuario');
  ['dashboard-admin','dashboard-loja','dashboard-entregador'].forEach(id=>document.getElementById(id).classList.add('hidden'));
  document.getElementById('login-screen').classList.remove('hidden');
  document.getElementById('login-email').value='';document.getElementById('login-senha').value='';
}

// ===== ADMIN =====
async function carregarDadosAdmin(){
  const{data:e}=await db.from('usuarios').select('id').eq('tipo','entregador').eq('status','ativo');
  const{data:l}=await db.from('usuarios').select('id').eq('tipo','loja').eq('status','ativo');
  document.getElementById('total-entregadores').textContent=e?e.length:0;
  document.getElementById('total-lojas').textContent=l?l.length:0;
}

async function carregarEntregadores(){
  openModal('entregadores');
  const lista=document.getElementById('lista-entregadores');
  lista.innerHTML='<p>Carregando...</p>';
  const{data}=await db.from('usuarios').select('*').eq('tipo','entregador');
  if(!data||!data.length){lista.innerHTML='<p>Nenhum entregador</p>';return;}
  lista.innerHTML=data.map(e=>`
    <div class="list-item">
      <div style="flex:1;">
        <strong>${e.nome}</strong><br>
        <small>Tel: ${e.telefone||'-'} | Placa: ${e.placa_moto||'-'}</small><br>
        <small>Pix: ${e.chave_pix||'-'} | ${e.online?'&#128994; Online':'&#9899; Offline'}</small>
      </div>
      <div style="display:flex;flex-direction:column;gap:5px;align-items:flex-end;">
        <span class="${e.status==='ativo'?'badge-ativo':'badge-bloqueado'}">${e.status}</span>
        <button class="btn-sm ${e.status==='ativo'?'vermelho':'verde'}" onclick="toggleStatus('${e.id}','${e.status}','entregadores')">
          ${e.status==='ativo'?'Bloquear':'Ativar'}
        </button>
      </div>
    </div>`).join('');
}

async function carregarLojas(){
  openModal('lojas');
  const lista=document.getElementById('lista-lojas');
  lista.innerHTML='<p>Carregando...</p>';
  const{data}=await db.from('usuarios').select('*').eq('tipo','loja');
  if(!data||!data.length){lista.innerHTML='<p>Nenhuma loja</p>';return;}
  lista.innerHTML=data.map(l=>`
    <div class="list-item" style="flex-direction:column;">
      <div style="display:flex;justify-content:space-between;width:100%;margin-bottom:8px;">
        <div>
          <strong>${l.nome_loja||l.nome}</strong><br>
          <small>${l.endereco||''} | Tel: ${l.telefone||'-'}</small>
        </div>
        <span class="${l.status==='ativo'?'badge-ativo':'badge-bloqueado'}">${l.status}</span>
      </div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
        <label style="font-size:12px;color:#666;">Taxa R$</label>
        <input type="number" class="taxa-input" id="taxa-${l.id}" value="${parseFloat(l.taxa_sistema||0.50).toFixed(2)}" step="0.01" min="0">
        <button class="btn-sm azul" onclick="salvarTaxaLoja('${l.id}')">Salvar</button>
        <button class="btn-sm ${l.status==='ativo'?'vermelho':'verde'}" onclick="toggleStatus('${l.id}','${l.status}','lojas')">
          ${l.status==='ativo'?'Bloquear':'Ativar'}
        </button>
      </div>
      <small id="msg-taxa-${l.id}" style="color:#27ae60;margin-top:3px;"></small>
    </div>`).join('');
}

async function toggleStatus(id,st,modal){
  const novo=st==='ativo'?'bloqueado':'ativo';
  await db.from('usuarios').update({status:novo}).eq('id',id);
  if(modal==='lojas')carregarLojas();else carregarEntregadores();
  carregarDadosAdmin();
}

async function salvarTaxaLoja(id){
  const val=parseFloat(document.getElementById('taxa-'+id).value);
  await db.from('usuarios').update({taxa_sistema:val}).eq('id',id);
  const m=document.getElementById('msg-taxa-'+id);
  m.textContent='Salvo!';setTimeout(()=>{m.textContent='';},2000);
}

async function abrirFinanceiroAdmin(){
  openModal('financeiro-admin');
  const el=document.getElementById('dados-financeiro-admin');
  const{data:lojas}=await db.from('usuarios').select('*').eq('tipo','loja');
  if(!lojas||!lojas.length){el.innerHTML='<p>Nenhuma loja</p>';return;}
  el.innerHTML=lojas.map(l=>`
    <div class="list-item">
      <div><strong>${l.nome_loja||l.nome}</strong><br><small>Taxa: ${formatReal(l.taxa_sistema)}/entrega</small></div>
      <span class="${l.status==='ativo'?'badge-ativo':'badge-bloqueado'}">${l.status}</span>
    </div>`).join('');
}

async function abrirCobrancas(){
  openModal('cobrancas');
  const el=document.getElementById('lista-cobrancas');
  const{data:lojas}=await db.from('usuarios').select('*').eq('tipo','loja');
  const hoje=new Date();
  const d=(3-hoje.getDay()+7)%7||7;
  const prox=new Date(hoje);prox.setDate(hoje.getDate()+d);
  el.innerHTML=`<p style="margin-bottom:12px;">Proxima cobranca: <strong>${prox.toLocaleDateString('pt-BR')}</strong></p>`+
    (lojas||[]).map(l=>`
      <div class="list-item">
        <div><strong>${l.nome_loja||l.nome}</strong><br><small>Taxa: ${formatReal(l.taxa_sistema)}/entrega</small></div>
        <span class="${l.status==='ativo'?'badge-ativo':'badge-bloqueado'}">${l.status}</span>
      </div>`).join('');
}

// ===== LOJA =====
async function carregarDadosLoja(){
  const{data}=await db.from('usuarios').select('*').eq('id',usuarioLogado.id).single();
  if(data){
    document.getElementById('taxa-sistema-loja').textContent=formatReal(data.taxa_sistema);
    document.getElementById('taxa-entregador-loja').textContent=formatReal(data.taxa_entrega);
    document.getElementById('nova-taxa-entregador').value=parseFloat(data.taxa_entrega||0).toFixed(2);
    usuarioLogado={...usuarioLogado,...data};
    localStorage.setItem('usuario',JSON.stringify(usuarioLogado));
  }
  const{data:ent}=await db.from('entregas').select('id').eq('loja_id',usuarioLogado.id).gte('created_at',inicioDia()).lte('created_at',fimDia());
  document.getElementById('entregas-hoje-loja').textContent=ent?ent.length:0;
  inicializarMapaLoja();
  atualizarMapaLoja();
  if(intervaloMapa)clearInterval(intervaloMapa);
  intervaloMapa=setInterval(atualizarMapaLoja,15000);
}

async function salvarTaxaEntregador(){
  const val=parseFloat(document.getElementById('nova-taxa-entregador').value);
  if(isNaN(val)||val<0){document.getElementById('taxa-msg').textContent='Valor invalido';return;}
  await db.from('usuarios').update({taxa_entrega:val}).eq('id',usuarioLogado.id);
  document.getElementById('taxa-msg').style.color='#27ae60';
  document.getElementById('taxa-msg').textContent='Taxa salva!';
  document.getElementById('taxa-entregador-loja').textContent=formatReal(val);
  usuarioLogado.taxa_entrega=val;
  setTimeout(()=>{document.getElementById('taxa-msg').textContent='';},2000);
}

function inicializarMapaLoja(){
  if(mapaLoja)return;
  const el=document.getElementById('mapa-loja');if(!el)return;
  // Centraliza em Ribeirao Preto
  mapaLoja=L.map('mapa-loja').setView([RP_LAT,RP_LNG],13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'OSM'}).addTo(mapaLoja);
}

async function atualizarMapaLoja(){
  if(!mapaLoja)return;
  const{data:assoc}=await db.from('loja_entregadores').select('entregador_id').eq('loja_id',usuarioLogado.id).eq('status','ativo');
  const listaEl=document.getElementById('lista-online-loja');
  if(!assoc||!assoc.length){listaEl.innerHTML='<p style="color:#999;font-size:13px;margin-top:8px;">Nenhum entregador associado.</p>';return;}
  const ids=assoc.map(a=>a.entregador_id);
  const{data:ents}=await db.from('usuarios').select('id,nome,telefone,latitude,longitude,online').in('id',ids).eq('online',true);
  Object.values(marcadores).forEach(m=>m.remove());marcadores={};
  if(!ents||!ents.length){listaEl.innerHTML='<p style="color:#999;font-size:13px;margin-top:8px;">Nenhum entregador online agora.</p>';return;}
  listaEl.innerHTML=ents.map(e=>`
    <div style="display:flex;gap:8px;align-items:center;padding:6px 0;border-bottom:1px solid #eee;">
      <span style="color:#00C9A7;font-size:16px;">&#128994;</span>
      <div><strong>${e.nome}</strong><br><small>Tel: ${e.telefone||'-'}</small></div>
    </div>`).join('');
  const bounds=[];
  ents.forEach(e=>{
    if(e.latitude&&e.longitude){
      const icon=L.divIcon({html:`<div style="background:#FF6B35;color:white;border-radius:50%;width:34px;height:34px;display:flex;align-items:center;justify-content:center;font-size:17px;border:2px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.3);">&#128757;</div>`,iconSize:[34,34],iconAnchor:[17,17],className:''});
      marcadores[e.id]=L.marker([e.latitude,e.longitude],{icon}).addTo(mapaLoja).bindPopup(`<strong>${e.nome}</strong><br>${e.telefone||''}`);
      bounds.push([e.latitude,e.longitude]);
    }
  });
  if(bounds.length)mapaLoja.fitBounds(bounds,{padding:[40,40]});
  else mapaLoja.setView([RP_LAT,RP_LNG],13);
  setTimeout(()=>mapaLoja.invalidateSize(),200);
}

// Scanner
async function abrirScannerComanda(){
  openModal('scanner');
  document.getElementById('dados-comanda').classList.add('hidden');
  document.getElementById('scanner-loading').classList.add('hidden');
  document.getElementById('foto-comanda').value='';
}

async function processarComanda(event){
  const file=event.target.files[0];if(!file)return;
  document.getElementById('scanner-loading').classList.remove('hidden');
  document.getElementById('dados-comanda').classList.add('hidden');
  const reader=new FileReader();
  reader.onload=async function(e){
    const base64=e.target.result.split(',')[1];
    const mediaType=file.type||'image/jpeg';
    try{
      const resp=await fetch('https://api.anthropic.com/v1/messages',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
          model:'claude-sonnet-4-20250514',max_tokens:1000,
          messages:[{role:'user',content:[
            {type:'image',source:{type:'base64',media_type:mediaType,data:base64}},
            {type:'text',text:'Analise esta comanda/pedido. Extraia em JSON: {"numero_pedido":"","cliente_nome":"","cliente_telefone":"","endereco_rua":"","endereco_numero":"","endereco_bairro":"","endereco_cidade":"Ribeirao Preto","endereco_complemento":"","observacoes":""}. Responda APENAS o JSON.'}
          ]}]
        })
      });
      const result=await resp.json();
      let txt=result.content[0].text.trim().replace(/```json|```/g,'').trim();
      const d=JSON.parse(txt);
      document.getElementById('ped-numero').value=d.numero_pedido||'';
      document.getElementById('ped-cliente').value=d.cliente_nome||'';
      document.getElementById('ped-telefone').value=d.cliente_telefone||'';
      document.getElementById('ped-rua').value=d.endereco_rua||'';
      document.getElementById('ped-num-end').value=d.endereco_numero||'';
      document.getElementById('ped-bairro').value=d.endereco_bairro||'';
      document.getElementById('ped-cidade').value=d.endereco_cidade||'Ribeirao Preto';
      document.getElementById('ped-complemento').value=d.endereco_complemento||'';
      document.getElementById('ped-obs').value=d.observacoes||'';
      document.getElementById('dados-comanda').classList.remove('hidden');
    }catch(err){
      // Fallback: campos em branco para preenchimento manual
      ['ped-numero','ped-cliente','ped-telefone','ped-rua','ped-num-end','ped-bairro','ped-obs','ped-complemento'].forEach(id=>document.getElementById(id).value='');
      document.getElementById('ped-cidade').value='Ribeirao Preto';
      document.getElementById('dados-comanda').classList.remove('hidden');
      alert('Nao foi possivel ler automaticamente. Preencha manualmente.');
    }finally{
      document.getElementById('scanner-loading').classList.add('hidden');
    }
  };
  reader.readAsDataURL(file);
}

async function salvarEntrega(){
  const rua=document.getElementById('ped-rua').value.trim();
  const num=document.getElementById('ped-num-end').value.trim();
  const bairro=document.getElementById('ped-bairro').value.trim();
  const cidade=document.getElementById('ped-cidade').value.trim()||'Ribeirao Preto';
  const comp=document.getElementById('ped-complemento').value.trim();
  if(!rua){alert('Informe pelo menos a rua de entrega');return;}
  const endFull=montarEndereco(rua,num,bairro,cidade,comp);
  const dados={
    loja_id:usuarioLogado.id,
    numero_pedido:document.getElementById('ped-numero').value,
    cliente_nome:document.getElementById('ped-cliente').value,
    cliente_telefone:document.getElementById('ped-telefone').value,
    endereco_entrega:endFull,
    endereco_rua:rua,endereco_numero:num,endereco_bairro:bairro,
    endereco_cidade:cidade,endereco_complemento:comp,
    valor_sistema:parseFloat(usuarioLogado.taxa_sistema||0),
    valor_entregador:parseFloat(usuarioLogado.taxa_entrega||0),
    status:'pendente',ordem_rota:99
  };
  const{error}=await db.from('entregas').insert([dados]);
  if(error){alert('Erro ao salvar: '+error.message);return;}
  alert('Entrega adicionada!');
  closeModal('scanner');
  document.getElementById('foto-comanda').value='';
  document.getElementById('dados-comanda').classList.add('hidden');
  const{data:ent}=await db.from('entregas').select('id').eq('loja_id',usuarioLogado.id).gte('created_at',inicioDia()).lte('created_at',fimDia());
  document.getElementById('entregas-hoje-loja').textContent=ent?ent.length:0;
}

async function abrirEntregasLoja(){
  openModal('entregas-loja');
  carregarEntregasLoja();
}

async function carregarEntregasLoja(){
  const lista=document.getElementById('lista-entregas-loja');
  lista.innerHTML='<p>Carregando...</p>';
  const{data}=await db.from('entregas').select('*,entregador:entregador_id(nome)').eq('loja_id',usuarioLogado.id).neq('status','entregue').order('ordem_rota');
  if(!data||!data.length){lista.innerHTML='<p style="color:#999;text-align:center;padding:20px;">Nenhum pedido pendente.</p>';return;}
  lista.innerHTML=data.map((e,i)=>`
    <div class="entrega-card ${e.status==='em_rota'?'em-rota':''}">
      <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
        <strong>${i+1}. ${e.numero_pedido?'#'+e.numero_pedido:e.cliente_nome||'Entrega'}</strong>
        <span class="badge-${e.status}">${e.status}</span>
      </div>
      <p style="font-size:13px;color:#555;">&#128205; ${e.endereco_entrega}</p>
      ${e.cliente_nome?`<p style="font-size:12px;color:#888;">&#128100; ${e.cliente_nome}${e.cliente_telefone?' | &#128222; '+e.cliente_telefone:''}</p>`:''}
      ${e.entregador?`<p style="font-size:12px;color:#004E89;">&#128757; ${e.entregador.nome}</p>`:''}
      <div style="margin-top:7px;display:flex;gap:6px;flex-wrap:wrap;">
        <button class="btn-sm verde" onclick="marcarEntregue('${e.id}')">&#10003; Entregue</button>
        <button class="btn-sm vermelho" onclick="cancelarEntrega('${e.id}')">Cancelar</button>
      </div>
    </div>`).join('');
}

async function otimizarRota(){
  const{data}=await db.from('entregas').select('id').eq('loja_id',usuarioLogado.id).eq('status','pendente');
  if(!data||!data.length){alert('Sem pedidos pendentes.');return;}
  for(let i=0;i<data.length;i++)await db.from('entregas').update({ordem_rota:i+1}).eq('id',data[i].id);
  alert('Rota otimizada!');carregarEntregasLoja();
}

async function enviarRotaEntregador(){
  const{data:assoc}=await db.from('loja_entregadores').select('entregador_id,entregador:entregador_id(nome,online)').eq('loja_id',usuarioLogado.id).eq('status','ativo');
  const online=(assoc||[]).filter(a=>a.entregador&&a.entregador.online);
  if(!online.length){alert('Nenhum entregador online disponivel.');return;}
  const{data:ents}=await db.from('entregas').select('id').eq('loja_id',usuarioLogado.id).eq('status','pendente');
  if(!ents||!ents.length){alert('Sem pedidos pendentes.');return;}
  const entId=online[0].entregador_id;
  for(const e of ents)await db.from('entregas').update({entregador_id:entId,status:'em_rota'}).eq('id',e.id);
  alert(`Rota enviada para ${online[0].entregador.nome}!`);carregarEntregasLoja();
}

async function marcarEntregue(id){
  await db.from('entregas').update({status:'entregue',entregue_at:new Date().toISOString()}).eq('id',id);
  carregarEntregasLoja();
  const{data:ent}=await db.from('entregas').select('id').eq('loja_id',usuarioLogado.id).gte('created_at',inicioDia()).lte('created_at',fimDia());
  document.getElementById('entregas-hoje-loja').textContent=ent?ent.length:0;
}

async function cancelarEntrega(id){
  if(!confirm('Cancelar esta entrega?'))return;
  await db.from('entregas').delete().eq('id',id);carregarEntregasLoja();
}

async function abrirRelatorioLoja(){openModal('relatorio-loja');carregarRelatorioLoja();}

async function carregarRelatorioLoja(){
  const periodo=document.getElementById('filtro-periodo').value;
  const inicio=inicioPeriodo(periodo);
  const el=document.getElementById('dados-relatorio-loja');
  el.innerHTML='<p>Carregando...</p>';
  const{data:entregas}=await db.from('entregas').select('*,entregador:entregador_id(nome)').eq('loja_id',usuarioLogado.id).gte('created_at',inicio);
  if(!entregas||!entregas.length){el.innerHTML='<p style="color:#999;text-align:center;padding:20px;">Nenhuma entrega no periodo.</p>';return;}
  const totSis=entregas.reduce((s,e)=>s+parseFloat(e.valor_sistema||0),0);
  const totEnt=entregas.reduce((s,e)=>s+parseFloat(e.valor_entregador||0),0);
  const porEnt={};
  entregas.forEach(e=>{
    const k=e.entregador_id||'sem';
    if(!porEnt[k]){porEnt[k]={nome:e.entregador?e.entregador.nome:'Sem entregador',lista:[],total:0};}
    porEnt[k].lista.push(e);porEnt[k].total+=parseFloat(e.valor_entregador||0);
  });
  el.innerHTML=`
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:14px;">
      <div style="background:#fff3e0;padding:11px;border-radius:8px;text-align:center;">
        <p style="font-size:11px;color:#888;">Entregas</p>
        <p style="font-size:22px;font-weight:bold;color:#FF6B35;">${entregas.length}</p>
      </div>
      <div style="background:#e3f2fd;padding:11px;border-radius:8px;text-align:center;">
        <p style="font-size:11px;color:#888;">Sistema</p>
        <p style="font-size:16px;font-weight:bold;color:#004E89;">${formatReal(totSis)}</p>
      </div>
      <div style="background:#e8f5e9;padding:11px;border-radius:8px;text-align:center;">
        <p style="font-size:11px;color:#888;">Entregadores</p>
        <p style="font-size:16px;font-weight:bold;color:#00C9A7;">${formatReal(totEnt)}</p>
      </div>
    </div>
    ${Object.values(porEnt).map(g=>`
      <div class="secao">
        <h3>&#128757; ${g.nome} &mdash; ${formatReal(g.total)}</h3>
        ${g.lista.map((e,i)=>`
          <div style="padding:7px 0;border-bottom:1px solid #eee;font-size:13px;">
            <div style="display:flex;justify-content:space-between;">
              <strong>${e.numero_pedido?'#'+e.numero_pedido:e.cliente_nome||'Entrega '+(i+1)}</strong>
              <span class="badge-${e.status}">${e.status}</span>
            </div>
            <p style="color:#555;margin:2px 0;">&#128205; ${e.endereco_entrega}</p>
            <p style="color:#888;">Sist: ${formatReal(e.valor_sistema)} | Ent: ${formatReal(e.valor_entregador)}</p>
          </div>`).join('')}
      </div>`).join('')}`;
}

async function abrirGerenciarEntregadores(){
  openModal('gerenciar-ent');carregarMeusEntregadores();
}

async function carregarMeusEntregadores(){
  const lista=document.getElementById('lista-meus-ent');
  lista.innerHTML='<p>Carregando...</p>';
  const{data:assoc}=await db.from('loja_entregadores').select('*,entregador:entregador_id(id,nome,telefone,placa_moto,online,status)').eq('loja_id',usuarioLogado.id);
  if(!assoc||!assoc.length){lista.innerHTML='<p style="color:#999;margin-top:10px;">Nenhum entregador vinculado ainda.</p>';return;}
  lista.innerHTML=assoc.map(a=>`
    <div class="list-item" style="display:flex;justify-content:space-between;align-items:center;">
      <div>
        <strong>${a.entregador?a.entregador.nome:'Removido'}</strong><br>
        <small>Tel: ${a.entregador?a.entregador.telefone||'-':'-'} | Placa: ${a.entregador?a.entregador.placa_moto||'-':'-'}</small><br>
        <small>${a.entregador&&a.entregador.online?'&#128994; Online':'&#9899; Offline'}</small>
      </div>
      <button class="btn-sm vermelho" onclick="removerEntregador('${a.id}')">Remover</button>
    </div>`).join('');
}

async function adicionarEntregador(){
  const email=document.getElementById('email-entregador').value.trim();
  const msg=document.getElementById('msg-add-ent');
  if(!email){msg.textContent='Digite o email';return;}
  const{data:ent}=await db.from('usuarios').select('id,nome').eq('email',email).eq('tipo','entregador').single();
  if(!ent){msg.style.color='#c62828';msg.textContent='Entregador nao encontrado com este email.';return;}
  const{error}=await db.from('loja_entregadores').insert([{loja_id:usuarioLogado.id,entregador_id:ent.id}]);
  if(error&&error.code==='23505'){msg.style.color='#f57f17';msg.textContent='Ja associado.';return;}
  if(error){msg.style.color='#c62828';msg.textContent='Erro: '+error.message;return;}
  msg.style.color='#2e7d32';msg.textContent=ent.nome+' adicionado!';
  document.getElementById('email-entregador').value='';
  setTimeout(()=>{msg.textContent='';},3000);
  carregarMeusEntregadores();
}

async function removerEntregador(id){
  if(!confirm('Remover?'))return;
  await db.from('loja_entregadores').delete().eq('id',id);carregarMeusEntregadores();
}

async function abrirConfiguracoesLoja(){
  openModal('config-loja');
  const{data}=await db.from('usuarios').select('*').eq('id',usuarioLogado.id).single();
  if(data){
    document.getElementById('cfg-nome-loja').value=data.nome_loja||'';
    document.getElementById('cfg-tel-loja').value=data.telefone||'';
    document.getElementById('cfg-cnpj-loja').value=data.cnpj||'';
    // Parse endereco se tiver
    document.getElementById('cfg-rua').value=data.endereco_rua||'';
    document.getElementById('cfg-numero').value=data.endereco_numero||'';
    document.getElementById('cfg-bairro').value=data.endereco_bairro||'';
    document.getElementById('cfg-cidade').value=data.cidade||data.endereco_cidade||'Ribeirao Preto';
    document.getElementById('cfg-complemento').value=data.endereco_complemento||'';
    if(data.horario_abertura)document.getElementById('cfg-abertura').value=data.horario_abertura.substring(0,5);
    if(data.horario_fechamento)document.getElementById('cfg-fechamento').value=data.horario_fechamento.substring(0,5);
  }
  document.getElementById('cfg-loja-msg').innerHTML='';
  document.getElementById('cfg-senha-loja').value='';
}

async function salvarConfigLoja(){
  const rua=document.getElementById('cfg-rua').value;
  const num=document.getElementById('cfg-numero').value;
  const bairro=document.getElementById('cfg-bairro').value;
  const cidade=document.getElementById('cfg-cidade').value||'Ribeirao Preto';
  const comp=document.getElementById('cfg-complemento').value;
  const dados={
    nome_loja:document.getElementById('cfg-nome-loja').value,
    telefone:document.getElementById('cfg-tel-loja').value,
    cnpj:document.getElementById('cfg-cnpj-loja').value,
    endereco:montarEndereco(rua,num,bairro,cidade,comp),
    endereco_rua:rua,endereco_numero:num,endereco_bairro:bairro,
    endereco_cidade:cidade,cidade,endereco_complemento:comp,
    horario_abertura:document.getElementById('cfg-abertura').value||null,
    horario_fechamento:document.getElementById('cfg-fechamento').value||null,
  };
  const novaSenha=document.getElementById('cfg-senha-loja').value;
  if(novaSenha.length>=6)dados.senha_hash=novaSenha;
  const{error}=await db.from('usuarios').update(dados).eq('id',usuarioLogado.id);
  if(error){showMsg('cfg-loja-msg','Erro: '+error.message);return;}
  usuarioLogado={...usuarioLogado,...dados};
  localStorage.setItem('usuario',JSON.stringify(usuarioLogado));
  document.getElementById('nome-loja-display').textContent=dados.nome_loja||usuarioLogado.nome;
  showMsg('cfg-loja-msg','Salvo!',false);
  setTimeout(()=>closeModal('config-loja'),1500);
}

// ===== ENTREGADOR =====
async function carregarDadosEntregador(){
  const{data}=await db.from('usuarios').select('*').eq('id',usuarioLogado.id).single();
  if(data){
    usuarioLogado={...usuarioLogado,...data};
    localStorage.setItem('usuario',JSON.stringify(usuarioLogado));
    atualizarBotaoOnline(data.online);
    if(data.foto_url){
      document.getElementById('foto-entregador').src=data.foto_url;
      document.getElementById('foto-entregador').classList.remove('hidden');
      document.getElementById('foto-placeholder').classList.add('hidden');
    }
  }
  const{data:e}=await db.from('entregas').select('id,valor_entregador').eq('entregador_id',usuarioLogado.id).gte('created_at',inicioDia()).lte('created_at',fimDia());
  document.getElementById('minhas-entregas').textContent=e?e.length:0;
  const ganho=e?e.reduce((s,x)=>s+parseFloat(x.valor_entregador||0),0):0;
  document.getElementById('meus-ganhos').textContent=formatReal(ganho);
}

function atualizarBotaoOnline(online){
  const card=document.getElementById('btn-online-card');
  const icone=document.getElementById('icone-online');
  const texto=document.getElementById('texto-online');
  const st=document.getElementById('status-online-texto');
  if(online){
    card.style.background='linear-gradient(135deg,#00C9A7,#009688)';
    icone.innerHTML='&#128308;';texto.textContent='Ficar Offline';texto.style.color='white';
    st.textContent='&#128994; Online';
  }else{
    card.style.background='';icone.innerHTML='&#128994;';texto.textContent='Ficar Online';texto.style.color='';
    st.textContent='&#9899; Offline';
  }
}

async function toggleOnline(){
  const novo=!usuarioLogado.online;
  await db.from('usuarios').update({online:novo}).eq('id',usuarioLogado.id);
  usuarioLogado.online=novo;localStorage.setItem('usuario',JSON.stringify(usuarioLogado));
  atualizarBotaoOnline(novo);
  if(novo)iniciarRastreamento();
  else if(intervaloRastreamento)clearInterval(intervaloRastreamento);
}

function iniciarRastreamento(){
  if(intervaloRastreamento)clearInterval(intervaloRastreamento);
  const enviar=()=>{
    if(!usuarioLogado||!usuarioLogado.online)return;
    navigator.geolocation&&navigator.geolocation.getCurrentPosition(pos=>{
      db.from('usuarios').update({latitude:pos.coords.latitude,longitude:pos.coords.longitude}).eq('id',usuarioLogado.id);
    },{},{ enableHighAccuracy:true,timeout:10000 });
  };
  enviar();
  intervaloRastreamento=setInterval(enviar,20000);
}

function abrirFotoPerfil(){document.getElementById('input-foto').click();}

async function uploadFoto(event){
  const file=event.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=async function(e){
    const base64=e.target.result;
    await db.from('usuarios').update({foto_url:base64}).eq('id',usuarioLogado.id);
    usuarioLogado.foto_url=base64;localStorage.setItem('usuario',JSON.stringify(usuarioLogado));
    document.getElementById('foto-entregador').src=base64;
    document.getElementById('foto-entregador').classList.remove('hidden');
    document.getElementById('foto-placeholder').classList.add('hidden');
  };
  reader.readAsDataURL(file);
}

async function abrirRotaEntregador(){
  openModal('rota-ent');
  const lista=document.getElementById('lista-rota-ent');
  lista.innerHTML='<p>Carregando...</p>';
  const{data}=await db.from('entregas').select('*').eq('entregador_id',usuarioLogado.id).eq('status','em_rota').order('ordem_rota');
  if(!data||!data.length){lista.innerHTML='<p style="color:#999;text-align:center;padding:20px;">Nenhuma entrega atribuida no momento.</p>';return;}
  const enderecos=data.map(e=>encodeURIComponent(e.endereco_entrega));
  const destino=enderecos[enderecos.length-1];
  const wp=enderecos.slice(0,-1).join('|');
  const mapsUrl=`https://www.google.com/maps/dir/?api=1&destination=${destino}${wp?'&waypoints='+wp:''}&travelmode=driving`;
  lista.innerHTML=`
    <button onclick="window.open('${mapsUrl}','_blank')" style="margin-bottom:14px;background:#00C9A7;">
      &#127758; Abrir Rota Completa no Maps
    </button>
    ${data.map((e,i)=>`
      <div class="entrega-card em-rota">
        <strong>${i+1}. ${e.numero_pedido?'Pedido #'+e.numero_pedido:e.cliente_nome||'Entrega'}</strong><br>
        <p style="font-size:13px;color:#555;margin:3px 0;">&#128205; ${e.endereco_entrega}</p>
        ${e.cliente_nome?`<p style="font-size:12px;color:#888;">&#128100; ${e.cliente_nome}${e.cliente_telefone?` | <a href="tel:${e.cliente_telefone}" style="color:#004E89;">&#128222; ${e.cliente_telefone}</a>`:''}</p>`:''}
        <div style="display:flex;gap:6px;margin-top:7px;">
          <button class="btn-sm verde" onclick="entregadorMarcaEntregue('${e.id}')">&#10003; Entregue</button>
          <a href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(e.endereco_entrega)}&travelmode=driving" target="_blank">
            <button class="btn-sm azul" style="margin:0;">&#127758; Ir</button>
          </a>
        </div>
      </div>`).join('')}`;
}

async function entregadorMarcaEntregue(id){
  await db.from('entregas').update({status:'entregue',entregue_at:new Date().toISOString()}).eq('id',id);
  abrirRotaEntregador();carregarDadosEntregador();
}

async function abrirGanhos(){openModal('ganhos');carregarGanhos();}

async function carregarGanhos(){
  const periodo=document.getElementById('filtro-ganhos').value;
  const inicio=inicioPeriodo(periodo);
  const el=document.getElementById('dados-ganhos');
  el.innerHTML='<p>Carregando...</p>';
  const{data}=await db.from('entregas').select('*,loja:loja_id(nome_loja,nome)').eq('entregador_id',usuarioLogado.id).gte('created_at',inicio);
  if(!data||!data.length){el.innerHTML='<p style="color:#999;text-align:center;padding:20px;">Nenhuma entrega no periodo.</p>';return;}
  const total=data.reduce((s,e)=>s+parseFloat(e.valor_entregador||0),0);
  el.innerHTML=`
    <div style="background:#e8f5e9;padding:14px;border-radius:10px;text-align:center;margin-bottom:14px;">
      <p style="font-size:12px;color:#666;">Total do periodo</p>
      <p style="font-size:30px;font-weight:bold;color:#2e7d32;">${formatReal(total)}</p>
      <p style="font-size:13px;color:#666;">${data.length} entrega(s)</p>
    </div>
    ${data.map((e,i)=>`
      <div style="padding:9px 0;border-bottom:1px solid #eee;font-size:13px;">
        <div style="display:flex;justify-content:space-between;">
          <strong>${e.numero_pedido?'#'+e.numero_pedido:e.cliente_nome||'Entrega '+(i+1)}</strong>
          <strong style="color:#2e7d32;">${formatReal(e.valor_entregador)}</strong>
        </div>
        <p style="color:#888;">&#127978; ${e.loja?(e.loja.nome_loja||e.loja.nome):'Loja'}</p>
        <p style="color:#555;">&#128205; ${e.endereco_entrega}</p>
        <span class="badge-${e.status}">${e.status}</span>
      </div>`).join('')}`;
}

async function abrirConfiguracoes(){
  openModal('configuracoes');
  document.getElementById('conf-nome').value=usuarioLogado.nome||'';
  document.getElementById('conf-telefone').value=usuarioLogado.telefone||'';
  document.getElementById('conf-placa').value=usuarioLogado.placa_moto||'';
  document.getElementById('conf-pix').value=usuarioLogado.chave_pix||'';
  document.getElementById('conf-senha').value='';
  document.getElementById('conf-msg').innerHTML='';
}

async function salvarConfiguracoes(){
  const dados={
    nome:document.getElementById('conf-nome').value,
    telefone:document.getElementById('conf-telefone').value,
    placa_moto:document.getElementById('conf-placa').value,
    chave_pix:document.getElementById('conf-pix').value,
  };
  const novaSenha=document.getElementById('conf-senha').value;
  if(novaSenha.length>=6)dados.senha_hash=novaSenha;
  const{error}=await db.from('usuarios').update(dados).eq('id',usuarioLogado.id);
  if(error){showMsg('conf-msg','Erro: '+error.message);return;}
  usuarioLogado={...usuarioLogado,...dados};localStorage.setItem('usuario',JSON.stringify(usuarioLogado));
  document.getElementById('nome-entregador-display').textContent=dados.nome;
  showMsg('conf-msg','Dados salvos!',false);
  setTimeout(()=>closeModal('configuracoes'),1500);
}
</script>
</body>
</html>
