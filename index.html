<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Monta a Rota Ai</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f0f2f5;color:#333;}
.login-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;background:linear-gradient(135deg,#FF6B35 0%,#004E89 100%);}
.login-box{background:white;padding:28px;border-radius:16px;width:100%;max-width:390px;box-shadow:0 8px 30px rgba(0,0,0,.2);}
.tabs{display:flex;margin-bottom:16px;border-radius:8px;overflow:hidden;border:1px solid #eee;}
.tab{flex:1;padding:10px;text-align:center;cursor:pointer;background:#f5f5f5;color:#666;font-size:14px;border:none;}
.tab.active{background:linear-gradient(135deg,#FF6B35,#004E89);color:white;font-weight:600;}
.fg{margin-bottom:11px;}
.fg label{display:block;font-size:11px;font-weight:700;color:#666;margin-bottom:3px;text-transform:uppercase;letter-spacing:.5px;}
.fg input,.fg select,.fg textarea{width:100%;padding:10px 12px;border:1.5px solid #e0e0e0;border-radius:8px;font-size:14px;}
.fg input:focus,.fg select:focus{outline:none;border-color:#FF6B35;}
.g2{display:grid;grid-template-columns:2fr 1fr;gap:8px;}
.g2b{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;}
.btn{width:100%;padding:12px;border:none;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer;}
.btn:hover{opacity:.88;}.btn:disabled{opacity:.5;cursor:not-allowed;}
.btn-primary{background:linear-gradient(135deg,#FF6B35,#004E89);color:white;}
.btn-green{background:#00C9A7;color:white;}
.btn-blue{background:#004E89;color:white;}
.btn-orange{background:#FF6B35;color:white;}
.btn-red{background:#e74c3c;color:white;}
.btn-gray{background:#888;color:white;}
.btn-purple{background:#8e44ad;color:white;}
.user-type{display:flex;gap:10px;margin-bottom:12px;}
.user-type label{flex:1;padding:10px;text-align:center;border:2px solid #e0e0e0;border-radius:10px;cursor:pointer;font-size:13px;}
.user-type input:checked+label{border-color:#FF6B35;background:#fff5f2;color:#FF6B35;font-weight:600;}
.user-type input{display:none;}
.msg-error{background:#ffebee;color:#c62828;padding:9px 12px;border-radius:8px;font-size:13px;margin-bottom:9px;}
.msg-ok{background:#e8f5e9;color:#2e7d32;padding:9px 12px;border-radius:8px;font-size:13px;margin-bottom:9px;}
.msg-warn{background:#fff8e1;color:#e65100;padding:9px 12px;border-radius:8px;font-size:13px;margin-bottom:9px;}
.header{background:linear-gradient(135deg,#FF6B35 0%,#004E89 100%);color:white;padding:18px 16px 14px;text-align:center;position:relative;}
.header h1{font-size:19px;font-weight:700;}
.header p{font-size:12px;opacity:.85;margin-top:2px;}
.btn-logout{position:absolute;top:13px;right:13px;background:rgba(255,255,255,.18);color:white;border:none;padding:6px 12px;border-radius:7px;font-size:12px;cursor:pointer;font-weight:600;}
.container{padding:12px;max-width:900px;margin:0 auto;}
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:9px;margin-bottom:12px;}
.card{background:white;padding:12px;border-radius:11px;box-shadow:0 1px 6px rgba(0,0,0,.07);cursor:pointer;}
.card h3{font-size:10px;color:#999;font-weight:500;margin-bottom:4px;text-transform:uppercase;}
.card .val{font-size:22px;font-weight:700;color:#FF6B35;}
.menu{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;}
.mitem{background:white;padding:18px 10px;border-radius:11px;text-align:center;box-shadow:0 1px 6px rgba(0,0,0,.07);cursor:pointer;transition:transform .15s;}
.mitem:hover{transform:translateY(-2px);}
.mitem .ico{font-size:28px;margin-bottom:6px;}
.mitem h3{font-size:12px;color:#444;font-weight:600;}
.secao{background:white;border-radius:11px;box-shadow:0 1px 6px rgba(0,0,0,.07);padding:13px;margin-bottom:11px;}
.s-title{font-size:13px;font-weight:700;color:#004E89;margin-bottom:9px;}
.badge{display:inline-block;padding:2px 8px;border-radius:20px;font-size:10px;font-weight:700;}
.b-ativo,.b-entregue{background:#e8f5e9;color:#2e7d32;}
.b-bloqueado,.b-cancelado{background:#ffebee;color:#c62828;}
.b-pendente{background:#fff8e1;color:#e65100;}
.b-em_rota,.b-aceito{background:#e3f2fd;color:#1565c0;}
.b-chegou_loja{background:#f3e5f5;color:#6a1b9a;}
.b-saiu_entrega{background:#e0f7fa;color:#00695c;}
.b-online{background:#e8f5e9;color:#2e7d32;}
.b-offline{background:#f5f5f5;color:#777;}
.mapa-box{border-radius:10px;overflow:hidden;position:relative;}
.mapa-ctrl{position:absolute;top:8px;right:8px;z-index:999;display:flex;flex-direction:column;gap:5px;}
.mapa-btn{background:white;border:none;width:34px;height:34px;border-radius:7px;font-size:16px;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.2);display:flex;align-items:center;justify-content:center;}
.mapa-btn.seguindo{background:#FF6B35;color:white;}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:1000;overflow-y:auto;-webkit-overflow-scrolling:touch;}
.modal.open{display:flex;align-items:flex-start;justify-content:center;padding:8px;}
.modal-box{background:white;border-radius:13px;width:100%;max-width:640px;padding:16px;position:relative;margin:auto;}
.modal-close{position:absolute;top:11px;right:13px;font-size:22px;cursor:pointer;color:#999;background:none;border:none;line-height:1;}
.litem{padding:11px 0;border-bottom:1px solid #f0f0f0;display:flex;gap:9px;align-items:flex-start;}
.litem:last-child{border-bottom:none;}
.btn-sm{color:white;border:none;padding:6px 11px;border-radius:6px;cursor:pointer;font-size:11px;white-space:nowrap;margin:0;width:auto;font-weight:700;}
.btn-sm.green{background:#00C9A7;}.btn-sm.blue{background:#004E89;}.btn-sm.red{background:#e74c3c;}.btn-sm.gray{background:#888;}.btn-sm.orange{background:#FF6B35;}.btn-sm.purple{background:#8e44ad;}
.foto-circle{width:78px;height:78px;border-radius:50%;background:rgba(255,255,255,.25);border:3px dashed rgba(255,255,255,.5);display:flex;align-items:center;justify-content:center;font-size:32px;margin:0 auto 6px;cursor:pointer;}
.foto-img{width:78px;height:78px;border-radius:50%;object-fit:cover;border:3px solid white;margin:0 auto 6px;display:block;cursor:pointer;}
.codigo-box{background:rgba(255,255,255,.15);border-radius:9px;padding:7px 14px;margin-top:7px;display:inline-block;}
.codigo-num{font-size:26px;font-weight:700;letter-spacing:6px;color:white;}
.codigo-label{font-size:10px;opacity:.8;text-align:center;}
.ecard{background:#f8f9fa;border-radius:9px;padding:11px;margin-bottom:7px;border-left:4px solid #FF6B35;}
.ecard.rota{border-left-color:#004E89;background:#f0f4ff;}
.ecard.entregue-card{border-left-color:#00C9A7;opacity:.7;}
.ocr-progress{background:#e3f2fd;border-radius:8px;padding:13px;text-align:center;margin:10px 0;}
.ocr-bar{height:5px;background:#e0e0e0;border-radius:3px;margin-top:7px;overflow:hidden;}
.ocr-fill{height:100%;background:linear-gradient(90deg,#FF6B35,#004E89);border-radius:3px;transition:width .3s;width:0%;}
.hidden{display:none!important;}
.row{display:flex;gap:7px;align-items:center;}
.status-flow{display:flex;gap:4px;margin:8px 0;flex-wrap:wrap;}
.sf-step{flex:1;padding:6px 4px;border-radius:6px;text-align:center;font-size:10px;font-weight:700;border:2px solid #e0e0e0;color:#999;min-width:60px;}
.sf-step.done{background:#e8f5e9;border-color:#00C9A7;color:#2e7d32;}
.sf-step.active{background:#004E89;border-color:#004E89;color:white;}
.sf-step.current{background:#FF6B35;border-color:#FF6B35;color:white;animation:pulse2 1s infinite;}
@keyframes pulse2{0%,100%{opacity:1;}50%{opacity:.7;}}
.gps-banner{background:#ffebee;padding:10px 14px;border-radius:8px;margin-bottom:10px;font-size:13px;color:#c62828;display:flex;align-items:center;gap:8px;}
.entrega-valor{background:#e8f5e9;border-radius:6px;padding:5px 10px;font-size:13px;font-weight:700;color:#2e7d32;display:inline-block;}
.chip{background:#e3f2fd;color:#1565c0;border-radius:20px;padding:3px 10px;font-size:11px;display:inline-flex;align-items:center;gap:4px;margin:2px;}
.chip.green{background:#e8f5e9;color:#2e7d32;}
.notif-dot{width:10px;height:10px;background:#e74c3c;border-radius:50%;display:inline-block;margin-left:5px;animation:pulse2 .8s infinite;}
select.ent-select{width:100%;padding:8px;border:1.5px solid #e0e0e0;border-radius:7px;font-size:13px;margin-top:5px;}
.adm-tabs{display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap;}
.adm-tab{padding:8px 14px;border-radius:8px;border:none;cursor:pointer;font-size:13px;font-weight:600;background:#e0e0e0;color:#555;}
.adm-tab.active{background:#004E89;color:white;}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="pg-login" class="login-wrap">
  <div class="login-box">
    <div style="text-align:center;margin-bottom:18px;">
      <img id="login-logo" src="" alt="Monta a Rota Ai" style="width:130px;height:130px;object-fit:contain;margin:0 auto;display:block;">
    </div>
    <div class="tabs">
      <button class="tab active" onclick="switchTab('login',this)">Entrar</button>
      <button class="tab" onclick="switchTab('register',this)">Cadastrar</button>
    </div>
    <div id="login-tab">
      <div id="login-msg"></div>
      <div class="fg"><label>Email</label><input type="email" id="l-email" placeholder="seu@email.com" autocomplete="email"></div>
      <div class="fg"><label>Senha</label><input type="password" id="l-senha" placeholder="..." autocomplete="current-password"></div>
      <button class="btn btn-primary" onclick="fazerLogin()" id="btn-login">Entrar</button>
    </div>
    <div id="register-tab" class="hidden">
      <div id="reg-msg"></div>
      <div class="user-type">
        <label><input type="radio" name="rtype" value="loja" checked onchange="toggleCad()"><span>&#127978; Loja</span></label>
        <label><input type="radio" name="rtype" value="entregador" onchange="toggleCad()"><span>&#128757; Entregador</span></label>
      </div>
      <div class="fg"><label>Nome (CAIXA ALTA autom√°tico)</label><input type="text" id="r-nome" oninput="this.value=this.value.toUpperCase()"></div>
      <div class="fg">
        <label>Login (usu√°rio do sistema)</label>
        <div style="display:flex;align-items:center;gap:0;">
          <input type="text" id="r-email-user" placeholder="seunome" oninput="this.value=this.value.toLowerCase().replace(/[^a-z0-9._-]/g,'')"
            style="flex:1;padding:10px 12px;border:1.5px solid #e0e0e0;border-radius:8px 0 0 8px;font-size:14px;border-right:none;">
          <span style="background:#f5f5f5;border:1.5px solid #e0e0e0;border-left:none;padding:10px 10px;border-radius:0 8px 8px 0;font-size:13px;color:#666;white-space:nowrap;">@montarotaai.com</span>
        </div>
        <input type="hidden" id="r-email">
      </div>
      <div class="fg"><label>Telefone</label><input type="tel" id="r-tel" placeholder="(16) 99999-9999"></div>
      <div class="fg"><label>Senha</label><input type="password" id="r-senha" placeholder="Minimo 6 caracteres"></div>
      <div id="c-loja">
        <div class="fg"><label>Nome da Loja (CAIXA ALTA autom√°tico)</label><input type="text" id="r-nloja" oninput="this.value=this.value.toUpperCase()"></div>
        <div class="fg"><label>CNPJ</label><input type="text" id="r-cnpj" placeholder="00.000.000/0000-00"></div>
        <div class="g2"><div class="fg"><label>Rua</label><input type="text" id="r-rua"></div><div class="fg"><label>Numero</label><input type="text" id="r-num"></div></div>
        <div class="g2b"><div class="fg"><label>Bairro</label><input type="text" id="r-bairro"></div><div class="fg"><label>Cidade</label><input type="text" id="r-cidade" value="Ribeirao Preto"></div></div>
      </div>
      <div id="c-ent" class="hidden">
        <div class="fg"><label>Placa</label><input type="text" id="r-placa" placeholder="ABC-1234"></div>
        <div class="fg"><label>Chave Pix</label><input type="text" id="r-pix"></div>
      </div>
      <button class="btn btn-primary" onclick="fazerCadastro()" id="btn-cad">Cadastrar</button>
    </div>
  </div>
</div>

<!-- ADMIN -->
<div id="pg-admin" class="hidden">
  <div class="header">
    <button class="btn-logout" onclick="sair()">Sair</button>
    <div style="text-align:center;padding-top:10px;"><img src="" id="adm-logo-img" style="height:80px;object-fit:contain;"></div>
    <p style="text-align:center;font-size:12px;opacity:.75;">Painel Administrativo</p>
  </div>
  <div class="container">
    <div class="adm-tabs">
      <button class="adm-tab active" onclick="admTab('painel',this)">&#127968; Painel</button>
      <button class="adm-tab" onclick="admTab('lojas',this)">&#127978; Lojas</button>
      <button class="adm-tab" onclick="admTab('entregadores',this)">&#128757; Entregadores</button>
      <button class="adm-tab" onclick="admTab('financeiro',this)">&#128176; Financeiro</button>
      <button class="adm-tab" onclick="admTab('impersonar',this)">&#128065; Ver Painel</button>
    </div>
    <!-- Painel -->
    <div id="adm-painel">
      <div class="cards">
        <div class="card"><h3>Entregadores</h3><div class="val" id="adm-cnt-ent">0</div></div>
        <div class="card"><h3>Lojas</h3><div class="val" id="adm-cnt-loj">0</div></div>
        <div class="card"><h3>Online</h3><div class="val" id="adm-cnt-on">0</div></div>
        <div class="card"><h3>Em Rota</h3><div class="val" id="adm-cnt-rota">0</div></div>
      </div>
      <div class="secao">
        <div class="s-title">&#128205; Mapa Geral ‚Äî Entregadores Online</div>
        <div class="mapa-box">
          <div id="mapa-admin" style="height:280px;"></div>
          <div class="mapa-ctrl">
            <button class="mapa-btn" id="btn-fol-adm" onclick="toggleFollowEnt('admin')" title="Seguir entregador">&#128757;</button>
          </div>
        </div>
        <div id="lista-on-adm" style="margin-top:8px;display:flex;flex-wrap:wrap;gap:5px;"></div>
      </div>
      <!-- GPS Validacao - controle global do admin -->
      <div class="secao" id="adm-gps-toggle-box" style="display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:#fff3e0;border:1.5px solid #ffcc80;">
        <div>
          <div style="font-size:13px;font-weight:700;color:#e65100;">üìç Validacao de GPS (Global)</div>
          <div style="font-size:11px;color:#888;" id="adm-gps-toggle-desc">Entregadores confirmam sem validacao (modo livre)</div>
        </div>
        <div id="adm-gps-toggle-sw" onclick="admToggleGpsGlobal()" style="cursor:pointer;width:50px;height:26px;border-radius:13px;background:#ccc;position:relative;transition:background .3s;flex-shrink:0;">
          <div id="adm-gps-toggle-knob" style="position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:50%;background:white;transition:left .3s;box-shadow:0 1px 3px rgba(0,0,0,.3);"></div>
        </div>
      </div>

      <div class="secao">
        <div class="s-title">&#128230; Entregas em Tempo Real</div>
        <div id="adm-entregas-realtime"></div>
      </div>
    </div>
    <!-- Lojas -->
    <div id="adm-lojas" class="hidden">
      <div id="adm-loj-lst"></div>
    </div>
    <!-- Entregadores -->
    <div id="adm-entregadores" class="hidden">
      <div id="adm-ent-lst"></div>
    </div>
    <!-- Financeiro -->
    <div id="adm-financeiro" class="hidden">
      <div class="secao">
        <div class="s-title">üìä Relat√≥rio Financeiro ‚Äî Admin</div>
        <div class="g2b" style="gap:8px;margin-bottom:8px;">
          <select id="adm-fin-per" onchange="carregarFinAdm()" style="padding:9px;border:1.5px solid #e0e0e0;border-radius:8px;font-size:13px;">
            <option value="hoje">Hoje</option>
            <option value="semana" selected>Esta semana (Seg-Dom)</option>
            <option value="mes">Este m√™s</option>
            <option value="semana_passada">Semana passada</option>
            <option value="mes_passado">M√™s passado</option>
          </select>
          <select id="adm-fin-loja" onchange="carregarFinAdm()" style="padding:9px;border:1.5px solid #e0e0e0;border-radius:8px;font-size:13px;">
            <option value="">Todas as lojas</option>
          </select>
        </div>
        <button onclick="carregarFinAdm()" class="btn btn-blue" style="margin-bottom:4px;">üîÑ Atualizar</button>
      </div>
      <div id="adm-fin-dados"></div>
    </div>
    <!-- Impersonar -->
    <div id="adm-impersonar" class="hidden">
      <div class="secao">
        <div class="s-title">Ver como Loja</div>
        <select id="adm-sel-loja" onchange="admVerLoja()" style="width:100%;padding:9px;border:1.5px solid #e0e0e0;border-radius:8px;margin-bottom:8px;">
          <option value="">Selecione uma loja...</option>
        </select>
        <div id="adm-loja-view"></div>
      </div>
      <div class="secao">
        <div class="s-title">Ver como Entregador</div>
        <select id="adm-sel-ent" onchange="admVerEnt()" style="width:100%;padding:9px;border:1.5px solid #e0e0e0;border-radius:8px;margin-bottom:8px;">
          <option value="">Selecione um entregador...</option>
        </select>
        <div id="adm-ent-view"></div>
      </div>
    </div>
  </div>
</div>

<!-- LOJA -->
<div id="pg-loja" class="hidden">
  <div class="header">
    <button class="btn-logout" onclick="sair()">Sair</button>
    <div style="text-align:center;margin-bottom:4px;"><img src="" id="lj-app-logo" style="height:70px;object-fit:contain;"></div>
    <div id="loja-logo-box" style="margin-bottom:6px;"></div>
    <h1 id="loja-nome">Minha Loja</h1><p>Painel da Loja</p>
    <div class="codigo-box">
      <div class="codigo-label">Codigo para Entregadores</div>
      <div class="codigo-num" id="loja-cod">------</div>
    </div>
  </div>
  <div class="container">
    <div class="cards">
      <div class="card"><h3>Taxa Sistema</h3><div class="val" id="lj-ts">-</div></div>
      <div class="card"><h3>Hoje</h3><div class="val" id="lj-hj">0</div></div>
      <div class="card"><h3>Online</h3><div class="val" id="lj-online-cnt">0</div></div>
    </div>
    <!-- Taxa config -->
    <div class="secao">
      <div class="s-title">&#128176; Configuracao de Taxa ao Entregador</div>
      <div class="fg">
        <label>Tipo de taxa</label>
        <select id="lj-taxa-tipo" onchange="toggleTaxaTipo()">
          <option value="fixo">Valor fixo (mesmo valor para qualquer distancia)</option>
          <option value="por_km">Por distancia (ate X km fixo, acima diferente)</option>
          <option value="fixo_mais_km">Fixo base + valor por entrega (ate X km) + acima diferente</option>
        </select>
      </div>
      <div id="taxa-fixo-area">
        <div class="fg"><label>Valor fixo por entrega (R$)</label>
          <div class="row"><input type="number" id="lj-taxa-new" step="0.50" min="0" placeholder="0.00" style="flex:1;padding:9px;border:1.5px solid #e0e0e0;border-radius:8px;font-size:14px;">
          <button class="btn-sm blue" onclick="salvarTaxaLj()">Salvar</button></div>
        </div>
      </div>
      <div id="taxa-km-area" class="hidden">
        <div class="g3">
          <div class="fg"><label>Valor ate X km</label><input type="number" id="lj-taxa-base" step="0.50" min="0" placeholder="8.00" style="padding:9px;border:1.5px solid #e0e0e0;border-radius:8px;font-size:14px;width:100%;"></div>
          <div class="fg"><label>Limite (km)</label><input type="number" id="lj-km-limite" step="0.5" min="1" placeholder="5" style="padding:9px;border:1.5px solid #e0e0e0;border-radius:8px;font-size:14px;width:100%;"></div>
          <div class="fg"><label>Acima do limite</label><input type="number" id="lj-taxa-km-exc" step="0.50" min="0" placeholder="12.00" style="padding:9px;border:1.5px solid #e0e0e0;border-radius:8px;font-size:14px;width:100%;"></div>
        </div>
        <button class="btn btn-blue" onclick="salvarTaxaLj()" style="margin-top:4px;">Salvar Configuracao de Taxa</button>
      </div>
      <!-- Novo tipo: fixo base + por km -->
      <div id="taxa-fixo-km-area" class="hidden">
        <p style="font-size:11px;color:#888;margin-bottom:8px;">Ex: R$5 fixo + R$8 por entrega ate 7km, acima R$10</p>
        <div class="g2b">
          <div class="fg"><label>Fixo mensal/semanal (R$)</label><input type="number" id="lj-taxa-fixo-base" step="0.50" min="0" placeholder="0.00" style="padding:9px;border:1.5px solid #e0e0e0;border-radius:8px;font-size:14px;width:100%;"></div>
          <div class="fg"><label>Por entrega ate X km</label><input type="number" id="lj-taxa-por-ent" step="0.50" min="0" placeholder="8.00" style="padding:9px;border:1.5px solid #e0e0e0;border-radius:8px;font-size:14px;width:100%;"></div>
        </div>
        <div class="g2b">
          <div class="fg"><label>Limite (km)</label><input type="number" id="lj-km-limite2" step="0.5" min="1" placeholder="7" style="padding:9px;border:1.5px solid #e0e0e0;border-radius:8px;font-size:14px;width:100%;"></div>
          <div class="fg"><label>Acima do limite</label><input type="number" id="lj-taxa-km-exc2" step="0.50" min="0" placeholder="10.00" style="padding:9px;border:1.5px solid #e0e0e0;border-radius:8px;font-size:14px;width:100%;"></div>
        </div>
        <button class="btn btn-blue" onclick="salvarTaxaLj()" style="margin-top:4px;">Salvar Configuracao de Taxa</button>
      </div>
      <div id="taxa-msg" style="font-size:12px;margin-top:5px;"></div>
    </div>
    <!-- Mapa -->
    <div class="secao">
      <div class="s-title">&#128205; Entregadores Online</div>
      <div class="mapa-box">
        <div id="mapa-loja" style="height:230px;"></div>
        <div class="mapa-ctrl">
          <button class="mapa-btn" id="btn-fol-lj" onclick="toggleFollowEnt('loja')" title="Seguir entregador automaticamente">&#128757;</button>
        </div>
      </div>
      <div id="lista-on-lj" style="margin-top:7px;display:flex;flex-wrap:wrap;gap:5px;"></div>
    </div>
    <div class="menu">
      <div class="mitem" onclick="abrirNovoPedido()"><div class="ico">&#128247;</div><h3>Novo Pedido</h3></div>
      <div class="mitem" onclick="abrirPedidosLj()"><div class="ico">&#128230;</div><h3>Pedidos / Rota</h3></div>
      <div class="mitem" onclick="abrirRelLj()"><div class="ico">&#128202;</div><h3>Relatorio</h3></div>
      <div class="mitem" onclick="abrirGerEnt()"><div class="ico">&#128101;</div><h3>Entregadores</h3></div>
      <div class="mitem" onclick="abrirCfgLj()" style="grid-column:1/-1;max-width:170px;margin:0 auto;"><div class="ico">&#9881;</div><h3>Configuracoes</h3></div>
    </div>
  </div>
</div>

<!-- ENTREGADOR -->
<div id="pg-entregador" class="hidden">
  <div class="header" style="cursor:pointer;" onclick="abrirFoto()">
    <button class="btn-logout" onclick="event.stopPropagation();sair()">Sair</button>
    <div style="text-align:center;margin-bottom:4px;"><img src="" id="ent-app-logo" style="height:60px;object-fit:contain;" onclick="event.stopPropagation()"></div>
    <div id="ent-loja-logo" style="min-height:0;"></div>
    <div id="foto-ph" class="foto-circle">&#128100;</div>
    <img id="foto-img" class="foto-img hidden" src="" alt="">
    <h1 id="ent-nome">Entregador</h1>
    <p id="ent-st">&#9899; Offline</p>
    <input type="file" id="input-foto" accept="image/*" class="hidden" onchange="uploadFoto(event)">
  </div>
  <div class="container">
    <!-- Banner GPS: s√≥ aparece aqui dentro, s√≥ para entregador -->
    <div id="gps-banner" class="hidden" style="background:#e65100;color:white;padding:9px 14px;border-radius:9px;margin-bottom:10px;font-size:12px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
      <span style="flex:1;">üìç Localiza√ß√£o desligada. Ative o GPS do aparelho para rastrear sua posi√ß√£o.</span>
      <button onclick="pedirGPS()" style="background:white;color:#e65100;border:none;padding:5px 11px;border-radius:6px;font-weight:700;cursor:pointer;font-size:11px;">Ativar</button>
      <button onclick="$('gps-banner').classList.add('hidden')" style="background:transparent;color:white;border:none;font-size:18px;cursor:pointer;line-height:1;">&times;</button>
    </div>
    <!-- Aviso background GPS -->
    <div id="gps-bg-aviso" class="hidden" style="background:#fff3e0;border:1.5px solid #FF6B35;border-radius:9px;padding:9px 13px;margin-bottom:10px;font-size:11px;color:#e65100;">
      üì± <strong>GPS em background:</strong> Mantenha a tela do app vis√≠vel ou a tela do celular ligada enquanto estiver em rota. Se fechar o app, a localiza√ß√£o pode n√£o atualizar.
      <button onclick="$('gps-bg-aviso').classList.add('hidden')" style="float:right;background:none;border:none;font-size:16px;cursor:pointer;color:#e65100;line-height:1;">&times;</button>
    </div>
    <div id="gps-debug" style="font-size:10px;color:#888;text-align:center;margin-bottom:4px;"></div>
    <div id="ent-pedido-alerta" class="hidden" style="background:#FF6B35;color:white;padding:12px;border-radius:10px;margin-bottom:10px;text-align:center;font-weight:700;font-size:14px;cursor:pointer;" onclick="abrirRotaEnt()">
      &#128226; PEDIDO PRONTO NA LOJA! Toque para ver
    </div>
    <div class="cards">
      <div class="card"><h3>Entregas Hoje</h3><div class="val" id="ent-cnt">0</div></div>
      <div class="card"><h3>Ganhos Hoje</h3><div class="val" id="ent-gnh" style="font-size:16px;">R$0</div></div>
    </div>
    <!-- Loja ativa -->
    <div class="secao">
      <div class="s-title">&#127978; Loja Ativa</div>
      <div id="ent-loja-ativa-info" style="margin-bottom:8px;"></div>
      <div id="ent-selecionar-loja-box" class="hidden">
        <p style="font-size:12px;color:#666;margin-bottom:6px;">Selecione com qual loja vai trabalhar hoje:</p>
        <select id="ent-sel-loja-ativa" style="width:100%;padding:9px;border:1.5px solid #e0e0e0;border-radius:8px;"></select>
        <button class="btn btn-green" onclick="confirmarLojaAtiva()" style="margin-top:7px;">Confirmar e Ficar Online</button>
      </div>
      <div id="ent-conectar-box">
        <p style="font-size:11px;color:#888;margin-bottom:8px;">Adicionar outra loja:</p>
        <div style="display:flex;gap:7px;align-items:stretch;">
          <input type="text" id="cod-loja-inp" placeholder="Codigo da loja" maxlength="6"
            style="flex:1;padding:10px 12px;border:1.5px solid #e0e0e0;border-radius:8px;font-size:18px;text-transform:uppercase;letter-spacing:5px;text-align:center;font-weight:700;">
          <button onclick="conectarCodigo()" style="background:linear-gradient(135deg,#FF6B35,#e65100);color:white;border:none;padding:10px 16px;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;white-space:nowrap;">&#128273; Conectar</button>
        </div>
        <div id="msg-cod" style="font-size:12px;margin-top:5px;"></div>
      </div>
    </div>
    <div class="menu">
      <div class="mitem" id="btn-on-card" onclick="toggleOnline()">
        <div class="ico" id="ico-on">&#128994;</div>
        <h3 id="txt-on">Ficar Online</h3>
      </div>
      <div class="mitem" onclick="abrirRotaEnt()"><div class="ico">&#127758;</div><h3>Minha Rota <span id="rota-notif" class="hidden notif-dot"></span></h3></div>
      <div class="mitem" onclick="abrirGanhosEnt()"><div class="ico">&#128181;</div><h3>Meus Ganhos</h3></div>
      <div class="mitem" onclick="abrirCfgEnt()"><div class="ico">&#9881;</div><h3>Configuracoes</h3></div>
    </div>
  </div>
</div>

<!-- MODAIS -->
<!-- Novo Pedido -->
<div id="m-pedido" class="modal"><div class="modal-box">
  <button class="modal-close" onclick="closeM('pedido')">&times;</button>
  <h2 style="margin-bottom:4px;">&#128247; Novo Pedido</h2>
  <p style="font-size:12px;color:#888;margin-bottom:12px;">Fotografe a comanda para leitura automatica ou preencha manualmente</p>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:11px;">
    <div onclick="abrirCamera()" style="background:linear-gradient(135deg,#FF6B35,#004E89);border-radius:11px;padding:16px;text-align:center;cursor:pointer;color:white;">
      <div style="font-size:28px;margin-bottom:4px;">&#128247;</div>
      <div style="font-weight:700;font-size:13px;">Tirar Foto</div>
      <div style="font-size:10px;opacity:.8;">Abrir camera</div>
    </div>
    <div onclick="abrirGaleria()" style="background:linear-gradient(135deg,#004E89,#1a237e);border-radius:11px;padding:16px;text-align:center;cursor:pointer;color:white;">
      <div style="font-size:28px;margin-bottom:4px;">&#128444;</div>
      <div style="font-weight:700;font-size:13px;">Da Galeria</div>
      <div style="font-size:10px;opacity:.8;">Escolher foto</div>
    </div>
  </div>
  <input type="file" id="ocr-camera" accept="image/*" capture="environment" class="hidden" onchange="lerComanda(event)">
  <input type="file" id="ocr-galeria" accept="image/*" class="hidden" onchange="lerComanda(event)">
  <div id="ocr-prev" class="hidden" style="margin-bottom:11px;text-align:center;">
    <img id="ocr-img" style="max-width:100%;max-height:160px;border-radius:8px;border:1px solid #eee;">
    <div style="margin-top:5px;display:flex;gap:6px;justify-content:center;">
      <button onclick="abrirCamera()" class="btn-sm orange">&#128247; Camera</button>
      <button onclick="abrirGaleria()" class="btn-sm blue">&#128444; Galeria</button>
    </div>
  </div>
  <div id="ocr-load" class="hidden" style="background:#e3f2fd;border-radius:10px;padding:14px;text-align:center;margin-bottom:11px;">
    <div style="font-size:22px;margin-bottom:5px;">&#129302;</div>
    <div style="font-weight:700;font-size:13px;color:#004E89;">Lendo comanda com IA...</div>
    <div style="font-size:11px;color:#666;margin-top:3px;">Aguarde alguns segundos</div>
  </div>
  <div class="fg"><label>Numero do Pedido / Codigo Ifood</label><input type="text" id="p-num" placeholder="Ex: 4321 ou #IFD-ABC123"></div>
  <div class="fg"><label>Nome do Cliente</label><input type="text" id="p-cli"></div>
  <div class="fg"><label>Telefone</label><input type="tel" id="p-tel"></div>
  <div class="g2"><div class="fg"><label>Rua / Avenida</label><input type="text" id="p-rua" oninput="atualizarValorCorrida()"></div><div class="fg"><label>Numero</label><input type="text" id="p-nend" oninput="atualizarValorCorrida()"></div></div>
  <div class="g2b"><div class="fg"><label>Bairro</label><input type="text" id="p-bairro" oninput="atualizarValorCorrida()"></div><div class="fg"><label>Cidade</label><input type="text" id="p-cidade" value="Ribeirao Preto"></div></div>
  <div class="fg"><label>Complemento</label><input type="text" id="p-comp" placeholder="Ex: Apto 12 Torre 2"></div>
  <div class="fg"><label>Observacoes</label><input type="text" id="p-obs"></div>
  <div id="p-codconf-area" class="hidden" style="margin-bottom:11px;background:#f3e5f5;border-radius:8px;padding:10px;">
    <label style="font-size:11px;font-weight:700;color:#6a1b9a;text-transform:uppercase;letter-spacing:.5px;">&#128273; Codigo iFood detectado</label>
    <input type="text" id="p-cod-conf" placeholder="" style="width:100%;margin-top:5px;padding:9px;border:1.5px solid #ce93d8;border-radius:8px;font-size:16px;letter-spacing:4px;font-weight:700;color:#6a1b9a;">
    <p style="font-size:10px;color:#888;margin-top:3px;">Este codigo sera exibido ao entregador para confirmacao.</p>
  </div>
  <div id="p-valor-corrida" class="hidden" style="margin:10px 0;padding:10px;background:#e8f5e9;border-radius:8px;text-align:center;">
    <p style="font-size:11px;color:#666;">Valor estimado da corrida</p>
    <p id="p-valor-txt" style="font-size:22px;font-weight:700;color:#2e7d32;"></p>
    <p id="p-dist-txt" style="font-size:11px;color:#888;"></p>
  </div>
  <div id="ped-msg" style="margin-top:5px;"></div>
  <button class="btn btn-green" onclick="salvarPedido()" style="margin-top:9px;">&#10004; Salvar e Adicionar a Rota</button>
</div></div>

<!-- Pedidos/Rota Loja -->
<!-- Modal Plano de Rota -->
<!-- Modal: Definir Quantidade por Entregador -->
<div id="m-qtd-ent" class="modal"><div class="modal-box">
  <button class="modal-close" onclick="closeM('qtd-ent')">&times;</button>
  <h2 style="margin-bottom:4px;">üî¢ Distribui√ß√£o de Pedidos</h2>
  <p style="font-size:12px;color:#888;margin-bottom:4px;">Defina o m√°ximo de pedidos por entregador. A IA distribui automaticamente.</p>
  <p style="font-size:11px;color:#e65100;margin-bottom:12px;">A IA agrupa pedidos no mesmo sentido/bairro, com o mais perto da loja primeiro.</p>

  <!-- Limite global por entregador -->
  <div style="background:#f0f4ff;border:2px solid #004E89;border-radius:11px;padding:14px;margin-bottom:14px;text-align:center;">
    <p style="font-size:11px;font-weight:700;color:#004E89;text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px;">üì¶ M√°ximo de pedidos por entregador</p>
    <div style="display:flex;align-items:center;justify-content:center;gap:14px;">
      <button onclick="ajustarLimiteGlobal(-1)" style="width:40px;height:40px;border-radius:50%;border:2px solid #e0e0e0;background:white;font-size:24px;font-weight:700;cursor:pointer;line-height:1;">‚àí</button>
      <div id="qtd-limite-val" style="min-width:50px;text-align:center;font-size:36px;font-weight:800;color:#004E89;">4</div>
      <button onclick="ajustarLimiteGlobal(1)" style="width:40px;height:40px;border-radius:50%;border:2px solid #004E89;background:#004E89;color:white;font-size:24px;font-weight:700;cursor:pointer;line-height:1;">+</button>
    </div>
    <p style="font-size:10px;color:#888;margin-top:6px;">Salvo automaticamente para pr√≥ximas vezes ‚Ä¢ m√°x. 10</p>
  </div>

  <!-- Lista de entregadores dispon√≠veis -->
  <div id="qtd-ent-body">
    <p style="text-align:center;color:#888;">Carregando entregadores...</p>
  </div>
  <div id="qtd-total-info" style="background:#e3f2fd;border-radius:8px;padding:10px;margin:10px 0;font-size:13px;text-align:center;"></div>
  <div id="qtd-msg" style="margin-bottom:8px;"></div>
  <button class="btn btn-primary" onclick="gerarRotaComIA()" id="btn-gerar-rota">ü§ñ Gerar Rota com IA</button>
</div></div>

<div id="m-rota-plano" class="modal"><div class="modal-box">
  <button class="modal-close" onclick="closeM('rota-plano')">&times;</button>
  <h2 style="margin-bottom:4px;">üó∫Ô∏è Plano de Rota</h2>
  <p style="font-size:12px;color:#888;margin-bottom:12px;">Revise as rotas geradas pela IA e confirme</p>
  <div id="rota-plano-body"></div>
  <div style="margin-top:12px;display:flex;gap:8px;">
    <button class="btn btn-secondary" onclick="closeM('rota-plano');openM('qtd-ent')" style="flex:1;background:#f5f5f5;color:#555;border:none;padding:11px;border-radius:9px;font-weight:700;cursor:pointer;">‚Üê Voltar</button>
    <button class="btn btn-primary" onclick="confirmarRotaPlano()" id="btn-confirmar-rota" style="flex:2;">‚úÖ Confirmar e Despachar</button>
  </div>
</div></div>

<div id="m-rota" class="modal"><div class="modal-box">
  <button class="modal-close" onclick="closeM('rota')">&times;</button>
  <h2 style="margin-bottom:9px;">&#128230; Pedidos e Rota</h2>
  <div class="row" style="margin-bottom:11px;flex-wrap:wrap;gap:6px;">
    <button class="btn-sm blue" onclick="abrirDefinirQuantidade()" style="padding:8px 13px;background:#004E89;">üî¢ Definir Qtd / Rota IA</button>
    <button class="btn-sm blue" onclick="otimizarRotaInteligente()" style="padding:8px 13px;">ü§ñ Otimizar Auto</button>
    <button class="btn-sm orange" onclick="avisarPedidoPronto()" style="padding:8px 13px;">üì¢ Pedido Pronto</button>
  </div>
  <div id="rota-lst"></div>
</div></div>

<!-- Relatorio Loja -->
<div id="m-rel" class="modal"><div class="modal-box">
  <button class="modal-close" onclick="closeM('rel')">&times;</button>
  <h2 style="margin-bottom:9px;">&#128202; Relatorio Financeiro</h2>
  <select id="rel-f" onchange="carregarRel()" style="width:100%;padding:9px;border:1.5px solid #e0e0e0;border-radius:8px;margin-bottom:11px;">
    <option value="hoje">Hoje</option>
    <option value="semana" selected>Esta semana (Seg-Dom)</option>
    <option value="semana_passada">Semana passada</option>
    <option value="mes">Este m√™s</option>
    <option value="mes_passado">M√™s passado</option>
  </select>
  <div id="rel-dados"></div>
</div></div>

<!-- Gerenciar Entregadores Loja -->
<div id="m-ger" class="modal"><div class="modal-box">
  <button class="modal-close" onclick="closeM('ger')">&times;</button>
  <h2 style="margin-bottom:9px;">&#128101; Meus Entregadores</h2>
  <div class="secao" style="background:#fff3e0;">
    <div class="s-title" style="color:#e65100;">Codigo da Loja</div>
    <p style="font-size:12px;color:#666;margin-bottom:7px;">O entregador digita este codigo para se vincular a esta loja:</p>
    <div style="font-size:30px;text-align:center;letter-spacing:7px;font-weight:700;color:#004E89;" id="ger-cod">------</div>
  </div>
  <div id="ger-lst" style="margin-top:9px;"></div>
</div></div>

<!-- Config Loja -->
<div id="m-cfg-lj" class="modal"><div class="modal-box">
  <button class="modal-close" onclick="closeM('cfg-lj')">&times;</button>
  <h2 style="margin-bottom:13px;">&#9881; Configuracoes da Loja</h2>
  <!-- Logo upload -->
  <div style="text-align:center;margin-bottom:14px;">
    <div id="cfg-logo-prev" style="margin-bottom:8px;"></div>
    <div onclick="document.getElementById('cfg-logo-input').click()" style="display:inline-block;background:#f0f4ff;border:2px dashed #004E89;border-radius:10px;padding:10px 20px;cursor:pointer;font-size:12px;color:#004E89;font-weight:700;">
      &#128444; Trocar Logo da Loja
    </div>
    <input type="file" id="cfg-logo-input" accept="image/*" class="hidden" onchange="uploadLogoLoja(event)">
    <p style="font-size:10px;color:#999;margin-top:4px;">Aparece no topo do app. Recomendado: fundo transparente, 200x80px</p>
  </div>
  <div class="fg"><label>Nome da Loja</label><input type="text" id="cfg-nlj"></div>
  <div class="fg"><label>Telefone</label><input type="tel" id="cfg-tel"></div>
  <div class="fg"><label>CNPJ</label><input type="text" id="cfg-cnpj"></div>
  <div class="g2"><div class="fg"><label>Rua</label><input type="text" id="cfg-rua"></div><div class="fg"><label>Numero</label><input type="text" id="cfg-nend"></div></div>
  <div class="g2b"><div class="fg"><label>Bairro</label><input type="text" id="cfg-bairro"></div><div class="fg"><label>Cidade</label><input type="text" id="cfg-cidade"></div></div>
  <div class="fg"><label>Complemento</label><input type="text" id="cfg-comp"></div>
  <div class="g2b"><div class="fg"><label>Abertura</label><input type="time" id="cfg-ab"></div><div class="fg"><label>Fechamento</label><input type="time" id="cfg-fch"></div></div>
  <div class="fg"><label>Nova Senha (em branco = nao alterar)</label><input type="password" id="cfg-senha"></div>
  <div id="cfg-lj-msg"></div>
  <button class="btn btn-primary" onclick="salvarCfgLj()">Salvar</button>
</div></div>

<!-- Ganhos Entregador -->
<div id="m-ganhos" class="modal"><div class="modal-box">
  <button class="modal-close" onclick="closeM('ganhos')">&times;</button>
  <h2 style="margin-bottom:9px;">üí∞ Meus Ganhos</h2>
  <!-- Filtros r√°pidos -->
  <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px;">
    <button onclick="filtroGanhos('hoje',this)" class="btn-sm green" id="gnhf-hoje">Hoje</button>
    <button onclick="filtroGanhos('ontem',this)" class="btn-sm gray" id="gnhf-ontem">Ontem</button>
    <button onclick="filtroGanhos('semana',this)" class="btn-sm gray" id="gnhf-semana">Esta Semana</button>
    <button onclick="filtroGanhos('mes',this)" class="btn-sm gray" id="gnhf-mes">Este M√™s</button>
  </div>
  <!-- Navega√ß√£o de meses -->
  <div id="gnh-nav-mes" style="display:none;align-items:center;justify-content:space-between;background:#f0f4ff;border-radius:10px;padding:8px 12px;margin-bottom:8px;">
    <button onclick="navMes(-1)" style="background:none;border:none;font-size:20px;cursor:pointer;color:#004E89;padding:0 8px;">‚Äπ</button>
    <span id="gnh-mes-label" style="font-weight:700;font-size:13px;color:#004E89;text-transform:capitalize;"></span>
    <button onclick="navMes(1)" id="gnh-nav-prox" style="background:none;border:none;font-size:20px;cursor:pointer;color:#004E89;padding:0 8px;">‚Ä∫</button>
  </div>
  <div id="gnh-resumo" style="margin-bottom:12px;"></div>
  <div id="gnh-dados"></div>
</div></div>

<!-- Rota Entregador -->
<div id="m-rota-ent" class="modal"><div class="modal-box">
  <button class="modal-close" onclick="closeM('rota-ent')">&times;</button>
  <h2 style="margin-bottom:9px;">&#127758; Minhas Entregas</h2>
  <div id="rota-ent-lst"></div>
</div></div>

<!-- Editar Pedido -->
<div id="m-editar" class="modal"><div class="modal-box">
  <button class="modal-close" onclick="closeM('editar')">&times;</button>
  <h2 style="margin-bottom:13px;">&#9998; Editar Pedido</h2>
  <input type="hidden" id="edit-id">
  <div class="fg"><label>Numero do Pedido / Codigo Ifood</label><input type="text" id="edit-num" placeholder="Ex: 4321"></div>
  <div class="fg"><label>Nome do Cliente</label><input type="text" id="edit-cli"></div>
  <div class="fg"><label>Telefone</label><input type="tel" id="edit-tel"></div>
  <div class="g2"><div class="fg"><label>Rua / Avenida</label><input type="text" id="edit-rua"></div><div class="fg"><label>Numero</label><input type="text" id="edit-nend"></div></div>
  <div class="g2b"><div class="fg"><label>Bairro</label><input type="text" id="edit-bairro"></div><div class="fg"><label>Cidade</label><input type="text" id="edit-cidade"></div></div>
  <div class="fg"><label>Complemento</label><input type="text" id="edit-comp" placeholder="Ex: Apto 12 Torre 2"></div>
  <div class="fg"><label>Observacoes</label><input type="text" id="edit-obs"></div>
  <div id="edit-msg" style="margin-top:5px;"></div>
  <button class="btn btn-primary" onclick="salvarEdicaoPedido()">&#10003; Salvar Alteracoes</button>
</div></div>

<!-- Confirma√ß√£o iFood -->
<div id="m-ifood-conf" class="modal"><div class="modal-box">
  <button class="modal-close" onclick="closeM('ifood-conf')">&times;</button>
  <div style="text-align:center;margin-bottom:14px;">
    <div style="font-size:40px;">üì±</div>
    <h2 style="color:#ea1d2c;margin-bottom:4px;">Confirma√ß√£o iFood</h2>
    <p style="font-size:12px;color:#888;">Pedido <strong id="ifood-conf-num"></strong></p>
  </div>
  <div style="background:#fff3e0;border:1.5px solid #FF6B35;border-radius:10px;padding:12px;margin-bottom:14px;">
    <p style="font-size:13px;color:#e65100;font-weight:700;margin-bottom:4px;">Como confirmar:</p>
    <p style="font-size:12px;color:#555;line-height:1.7;">1. Chegue ao endere√ßo de entrega<br>2. Abra o iFood e confirme a entrega no app<br>3. Volte aqui e clique em <strong>Finalizar</strong></p>
  </div>
  <a id="ifood-conf-link" href="#" target="_blank" style="display:block;background:#ea1d2c;color:white;text-align:center;padding:14px;border-radius:9px;font-weight:700;font-size:15px;text-decoration:none;margin-bottom:12px;">
    üîó Abrir iFood para Confirmar
  </a>
  <div id="ifood-conf-msg" style="margin-bottom:8px;"></div>
  <button class="btn btn-green" onclick="finalizarSemCodigoIfood()" style="font-size:16px;padding:14px;">‚úÖ Entregue ‚Äî Finalizar</button>
</div></div>

<!-- Config Entregador -->
<div id="m-cfg-ent" class="modal"><div class="modal-box">
  <button class="modal-close" onclick="closeM('cfg-ent')">&times;</button>
  <h2 style="margin-bottom:13px;">&#9881; Meus Dados</h2>
  <div class="fg"><label>Nome</label><input type="text" id="ent-nome2"></div>
  <div class="fg"><label>Telefone</label><input type="tel" id="ent-tel2"></div>
  <div class="fg"><label>Placa</label><input type="text" id="ent-plc"></div>
  <div class="fg"><label>Chave Pix</label><input type="text" id="ent-pix"></div>
  <div class="fg"><label>Nova Senha</label><input type="password" id="ent-sen"></div>
  <div id="ent-cfg-msg"></div>
  <button class="btn btn-primary" onclick="salvarCfgEnt()">Salvar</button>
</div></div>

<script>
const GOOGLE_KEY_DEFAULT='AIzaSyB3cRabRR5vQgwtudkGKXMwBI35c1iNGrs';
// Limpa chave antiga inv√°lida do localStorage para usar a nova padr√£o
(function(){
  const stored=localStorage.getItem('google_vision_key')||'';
  if(stored&&stored!==GOOGLE_KEY_DEFAULT&&!stored.startsWith('AIzaSyB3cRab')){
    localStorage.removeItem('google_vision_key');
  }
})();
function getGoogleKey(){
  const stored=localStorage.getItem('google_vision_key')||'';
  // Valida: chave Google v√°lida come√ßa com AIzaSy e tem 39 chars
  if(stored&&stored.startsWith('AIzaSy')&&stored.length>=35) return stored;
  // Chave inv√°lida no storage ‚Äî usa a padr√£o e limpa
  if(stored) localStorage.removeItem('google_vision_key');
  return GOOGLE_KEY_DEFAULT;
}
const IFOOD_URL='https://confirmacao-entrega-propria.ifood.com.br/';
const LOGO_URL='data:image/jpeg;base64,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';
const SB_URL='https://dfvjaweyxfenhjgusekq.supabase.co';
const SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRmdmphd2V5eGZlbmhqZ3VzZWtxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzk4NTMsImV4cCI6MjA4NzYxNTg1M30.MT9pzSQgc3ZNGiIV95DwjVtNvSZI0Lz-SKMkvMys1Kg';
const db=window.supabase.createClient(SB_URL,SB_KEY);
// OCR usa Google Cloud Vision API ‚Äî chave configurada em GOOGLE_KEY
const RP_LAT=-21.1767, RP_LNG=-47.8208;

let U=null;
let mapas={admin:null,loja:null};
let mrks={admin:{},loja:{}};
let tooltips={admin:{},loja:{}};
let seg={admin:false,loja:false};
let ivs={rast:null,rastPush:null,mAdm:null,mLj:null,alerta:null};
let gpsOk=false;
let realtimeCh=null;
let myLat=null,myLng=null;
let lojaGeoCache={lat:null,lng:null};
let geocodeCache={};

// ============ INIT ============
window.onload=()=>{
  // Set logo on login screen immediately
  const li=$('login-logo');if(li)li.src=LOGO_URL;
  const s=localStorage.getItem('u');
  if(s){U=JSON.parse(s);showPg(U.tipo);}
};


// ‚îÄ‚îÄ GPS EM BACKGROUND: Wake Lock + Visibility API ‚îÄ‚îÄ
// Mant√©m o rastreamento ativo mesmo com tela em segundo plano
let _wakeLock=null;

async function ativarWakeLock(){
  if(!('wakeLock' in navigator))return;
  try{
    _wakeLock=await navigator.wakeLock.request('screen');
    _wakeLock.addEventListener('release',()=>{
      // Tenta reativar se ainda estiver online
      if(U&&U.online)setTimeout(ativarWakeLock,2000);
    });
  }catch(e){console.warn('[WakeLock]',e);}
}

function liberarWakeLock(){
  if(_wakeLock){_wakeLock.release().catch(()=>{});_wakeLock=null;}
}

// Quando app volta ao foco, retoma GPS imediatamente
document.addEventListener('visibilitychange',()=>{
  if(document.visibilityState==='visible'&&U&&U.online&&U.tipo==='entregador'){
    // App voltou ao foco ‚Äî envia posi√ß√£o imediatamente
    if(myLat&&myLng){
      db.from('usuarios').update({latitude:myLat,longitude:myLng}).eq('id',U.id);
    }
    navigator.geolocation&&navigator.geolocation.getCurrentPosition(
      p=>{myLat=p.coords.latitude;myLng=p.coords.longitude;
          db.from('usuarios').update({latitude:myLat,longitude:myLng}).eq('id',U.id);},
      ()=>{},
      {enableHighAccuracy:true,timeout:10000,maximumAge:5000}
    );
    // Reativa Wake Lock se perdeu
    ativarWakeLock();
  }
});

function swPostMessage(msg){
  // Mantido por compatibilidade ‚Äî agora usando Wake Lock em vez de SW
  if(msg.type==='STOP_GPS')liberarWakeLock();
}


// Helper seguro para banner GPS (so existe na tela do entregador)
function showGpsBanner(show){
  const b=$('gps-banner');
  if(!b)return; // nao esta na pagina atual
  b.classList.toggle('hidden',!show);
}

function iniciarGPS(){
  if(!navigator.geolocation)return;
  navigator.geolocation.getCurrentPosition(
    p=>{gpsOk=true;myLat=p.coords.latitude;myLng=p.coords.longitude;showGpsBanner(false);},
    err=>{
      // Mostra banner s√≥ se PERMISSION_DENIED (codigo 1)
      if(err.code===1)showGpsBanner(true);
    },
    {enableHighAccuracy:false,timeout:10000,maximumAge:60000}
  );
}

function pedirGPS(){
  showGpsBanner(false);
  if(!navigator.geolocation)return;
  navigator.geolocation.getCurrentPosition(
    p=>{gpsOk=true;myLat=p.coords.latitude;myLng=p.coords.longitude;showGpsBanner(false);},
    err=>{if(err.code===1)showGpsBanner(true);},
    {enableHighAccuracy:true,timeout:12000,maximumAge:0}
  );
}

// Obter posicao atual (promise)
function obterPosicaoAgora(){
  return new Promise((resolve,reject)=>{
    if(myLat&&myLng){resolve({lat:myLat,lng:myLng});return;}
    if(!navigator.geolocation){reject('sem_gps');return;}
    const timer=setTimeout(()=>{
      if(myLat&&myLng)resolve({lat:myLat,lng:myLng});
      else reject('timeout');
    },8000);
    navigator.geolocation.getCurrentPosition(
      p=>{clearTimeout(timer);gpsOk=true;myLat=p.coords.latitude;myLng=p.coords.longitude;resolve({lat:p.coords.latitude,lng:p.coords.longitude});},
      err=>{clearTimeout(timer);if(myLat&&myLng)resolve({lat:myLat,lng:myLng});else reject(err.code===1?'bloqueado':'indisponivel');},
      {enableHighAccuracy:true,timeout:7000,maximumAge:30000}
    );
  });
}

// ============ UTILS ============
const $=id=>document.getElementById(id);
const v=id=>{const e=$(id);return e?e.value.trim():'';}
const fR=val=>'R$ '+parseFloat(val||0).toFixed(2).replace('.',',');
const fEnd=(r,n,b,c,cp)=>{let s=[r,n].filter(Boolean).join(', ');if(b)s+=', '+b;if(c)s+=' - '+c;if(cp)s+=' ('+cp+')';return s;};
function showM(id,msg,ok){const e=$(id);if(!e)return;e.className=ok?'msg-ok':'msg-error';e.innerHTML=msg;}
function clearM(id){const e=$(id);if(e){e.className='';e.textContent='';}}
function iDia(){const d=new Date();d.setHours(0,0,0,0);return d.toISOString();}
function fDia(){const d=new Date();d.setHours(23,59,59,999);return d.toISOString();}
function iPer(p){
  const n=new Date();
  if(p==='hoje'){n.setHours(0,0,0,0);return n.toISOString();}
  if(p==='semana'){const d=new Date(n);d.setDate(d.getDate()-((d.getDay()+6)%7));d.setHours(0,0,0,0);return d.toISOString();}
  if(p==='semana_passada'){const d=new Date(n);d.setDate(d.getDate()-((d.getDay()+6)%7)-7);d.setHours(0,0,0,0);return d.toISOString();}
  if(p==='mes'){n.setDate(1);n.setHours(0,0,0,0);return n.toISOString();}
  if(p==='mes_passado'){return new Date(n.getFullYear(),n.getMonth()-1,1).toISOString();}
  n.setHours(0,0,0,0);return n.toISOString();
}

// Haversine
function distKm(lat1,lng1,lat2,lng2){
  const R=6371,dL=(lat2-lat1)*Math.PI/180,dG=(lng2-lng1)*Math.PI/180;
  const a=Math.sin(dL/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dG/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}
function angleDeg(lat1,lng1,lat2,lng2){return Math.atan2(lng2-lng1,lat2-lat1)*180/Math.PI;}

// Geocode via Nominatim
async function geocode(addr){
  if(geocodeCache[addr])return geocodeCache[addr];
  try{
    const r=await fetch('https://nominatim.openstreetmap.org/search?q='+encodeURIComponent(addr+', Ribeirao Preto, SP, Brasil')+'&format=json&limit=1',{headers:{'User-Agent':'MontaARotaAi/1.0'}});
    const d=await r.json();
    if(d&&d[0]){const res={lat:parseFloat(d[0].lat),lng:parseFloat(d[0].lon)};geocodeCache[addr]=res;return res;}
  }catch(e){}
  return null;
}

// Sound beep
function beep(freq=880,dur=0.4){
  try{const ctx=new(window.AudioContext||window.webkitAudioContext)();const o=ctx.createOscillator();const g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='sine';o.frequency.value=freq;g.gain.setValueAtTime(0.3,ctx.currentTime);g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+dur);o.start();o.stop(ctx.currentTime+dur);}catch(e){}
}
function beepAlerta(){beep(660,0.2);setTimeout(()=>beep(880,0.3),300);}

// Calcular valor corrida
function calcularValorCorrida(distancia,taxaTipo,taxaBase,kmLimite,taxaExcedente,taxaFixoBase){
  if(taxaTipo==='por_km'){
    if(distancia<=kmLimite)return taxaBase;
    else return taxaExcedente;
  }
  if(taxaTipo==='fixo_mais_km'){
    // fixoBase eh o valor por entrega; taxaFixoBase seria um fixo mensal (nao somado por corrida)
    if(distancia<=kmLimite)return taxaBase;
    else return taxaExcedente;
  }
  return taxaBase; // fixo
}

// MODAIS
function openM(id){const m=$('m-'+id);if(m)m.classList.add('open');}
function closeM(id){const m=$('m-'+id);if(m)m.classList.remove('open');}
window.addEventListener('click',e=>{if(e.target.classList.contains('modal'))e.target.classList.remove('open');});

function switchTab(tab,el){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));el.classList.add('active');
  if(tab==='login'){$('login-tab').classList.remove('hidden');$('register-tab').classList.add('hidden');}
  else{$('login-tab').classList.add('hidden');$('register-tab').classList.remove('hidden');}
}
function toggleCad(){
  const t=document.querySelector('input[name="rtype"]:checked').value;
  $('c-loja').classList.toggle('hidden',t!=='loja');$('c-ent').classList.toggle('hidden',t!=='entregador');
}
function toggleTaxaTipo(){
  const t=v('lj-taxa-tipo');
  $('taxa-fixo-area').classList.toggle('hidden',t!=='fixo');
  $('taxa-km-area').classList.toggle('hidden',t!=='por_km');
  $('taxa-fixo-km-area').classList.toggle('hidden',t!=='fixo_mais_km');
}

// ============ AUTH ============
async function fazerLogin(){
  const email=v('l-email'),senha=v('l-senha'),btn=$('btn-login');
  if(!email||!senha){showM('login-msg','Preencha email e senha');return;}
  btn.disabled=true;btn.textContent='Entrando...';
  try{
    const{data:u}=await db.from('usuarios').select('*').eq('email',email).single();
    if(!u){showM('login-msg','Usuario nao encontrado');return;}
    if(u.status==='bloqueado'){showM('login-msg','Acesso bloqueado.');return;}
    if(senha!==u.senha_hash){showM('login-msg','Senha incorreta');return;}
    U=u;localStorage.setItem('u',JSON.stringify(u));showPg(u.tipo);
  }catch(e){showM('login-msg','Erro: '+e.message);}
  finally{btn.disabled=false;btn.textContent='Entrar';}
}

async function fazerCadastro(){
  const tipo=document.querySelector('input[name="rtype"]:checked').value;
  const nomeRaw=v('r-nome'),emailUser=v('r-email-user'),senha=v('r-senha'),btn=$('btn-cad');
  const nome=nomeRaw.toUpperCase();
  if(!nome||!emailUser||!senha){showM('reg-msg','Preencha nome, login e senha');return;}
  if(!/^[a-z0-9._-]+$/.test(emailUser)){showM('reg-msg','Login inv√°lido. Use apenas letras min√∫sculas e n√∫meros.');return;}
  if(senha.length<6){showM('reg-msg','Senha minimo 6 caracteres');return;}
  const email=emailUser+'@montarotaai.com';
  btn.disabled=true;btn.textContent='Cadastrando...';
  try{
    const{data:ex}=await db.from('usuarios').select('id').eq('email',email).single();
    if(ex){showM('reg-msg','Login ja cadastrado. Escolha outro.');return;}
    const rua=v('r-rua'),num=v('r-num'),bairro=v('r-bairro'),cidade=v('r-cidade')||'Ribeirao Preto';
    const d={tipo,nome,email,telefone:v('r-tel'),senha_hash:senha,status:'ativo',taxa_sistema:0.50,taxa_entrega:0,taxa_tipo:'fixo',taxa_km_limite:5,taxa_km_excedente:2,online:false,cidade};
    if(tipo==='loja'){
      d.nome_loja=(v('r-nloja')||nome).toUpperCase();d.cnpj=v('r-cnpj');
      d.endereco=fEnd(rua,num,bairro,cidade,'');
      d.endereco_rua=rua;d.endereco_numero=num;d.endereco_bairro=bairro;d.endereco_cidade=cidade;
      d.codigo_loja=Math.random().toString(36).substring(2,8).toUpperCase();
    }else{d.placa_moto=v('r-placa');d.chave_pix=v('r-pix');}
    const{error}=await db.from('usuarios').insert([d]);
    if(error){showM('reg-msg','Erro: '+error.message);return;}
    showM('reg-msg','‚úÖ Cadastro realizado! Login: '+email,true);
    setTimeout(()=>{$('l-email').value=email;document.querySelectorAll('.tab')[0].click();},1800);
  }catch(e){showM('reg-msg','Erro: '+e.message);}
  finally{btn.disabled=false;btn.textContent='Cadastrar';}
}

function showPg(tipo){
  ['pg-login','pg-admin','pg-loja','pg-entregador'].forEach(id=>$(id).classList.add('hidden'));
  $('pg-'+tipo).classList.remove('hidden');
  // Inject app logo everywhere
  ['login-logo','adm-logo-img','lj-app-logo','ent-app-logo'].forEach(id=>{const el=$(id);if(el)el.src=LOGO_URL;});
  pararIvs();
  if(tipo==='admin')initAdmin();
  else if(tipo==='loja')initLoja();
  else if(tipo==='entregador')initEnt();
}

function sair(){
  pararIvs();
  if(U&&U.online)db.from('usuarios').update({online:false}).eq('id',U.id);
  // PRESERVA v√≠nculo de loja em chave separada por entregador
  // Assim o nome da loja permanece mesmo ap√≥s logout/fechar app
  if(U&&U.tipo==='entregador'&&U._loja_ativa_nome){
    const lojaKey='loja_vinc_'+U.id;
    localStorage.setItem(lojaKey,JSON.stringify({
      loja_ativa_id:U.loja_ativa_id||null,
      _loja_ativa_nome:U._loja_ativa_nome,
      _loja_ativa_codigo:U._loja_ativa_codigo||''
    }));
  }
  U=null;localStorage.removeItem('u');
  ['pg-admin','pg-loja','pg-entregador'].forEach(id=>$(id).classList.add('hidden'));
  $('pg-login').classList.remove('hidden');
  $('l-email').value='';$('l-senha').value='';
}
function pararIvs(){
  // rast usa watchPosition, nao setInterval
  if(ivs.rast){navigator.geolocation&&navigator.geolocation.clearWatch(ivs.rast);ivs.rast=null;}
  // os demais sao setInterval
  ['rastPush','mAdm','mLj','alerta'].forEach(k=>{if(ivs[k]){clearInterval(ivs[k]);ivs[k]=null;}});
  // Fecha canal realtime
  if(realtimeCh){try{realtimeCh.unsubscribe();}catch(e){}realtimeCh=null;}
}

// ============ MAPA ============
function criarMapa(tipo){
  const id=tipo==='admin'?'mapa-admin':'mapa-loja';
  if(mapas[tipo])return;
  mapas[tipo]=L.map(id).setView([RP_LAT,RP_LNG],13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'OSM'}).addTo(mapas[tipo]);
}

function icoEnt(nome,tel,comPedido){
  const bg=comPedido?'#1565C0':'#2e7d32'; // azul=com pedido, verde=livre
  const emoji=comPedido?'&#128757;':'&#128757;';
  const borda=comPedido?'#90CAF9':'#A5D6A7';
  return L.divIcon({
    html:`<div style="position:relative;text-align:center;">
      <div style="background:${bg};color:white;border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;font-size:17px;border:3px solid ${borda};box-shadow:0 2px 8px rgba(0,0,0,.45);margin:0 auto;">${emoji}</div>
      <div style="background:rgba(0,0,0,.80);color:white;font-size:9px;padding:2px 6px;border-radius:4px;white-space:nowrap;margin-top:2px;max-width:100px;overflow:hidden;text-overflow:ellipsis;">${nome.split(' ')[0]}${tel?' | '+tel.slice(-4):''}</div>
    </div>`,
    iconSize:[100,54],iconAnchor:[50,36],className:''
  });
}

async function atuMapa(tipo,ents){
  const m=mapas[tipo];if(!m)return;
  const mk=mrks[tipo];
  Object.keys(mk).forEach(id=>{if(!ents.find(e=>e.id===id)){mk[id].remove();delete mk[id];}});
  const bounds=[];
  let primLl=null;
  ents.forEach(e=>{
    if(!e.latitude||!e.longitude)return;
    const ll=[e.latitude,e.longitude];
    const ico=icoEnt(e.nome,e.telefone,!!e.com_pedido);
    const popup=`<strong>${e.nome}</strong><br>Tel: ${e.telefone||'-'}<br><span style="color:${e.com_pedido?'#1565C0':'#2e7d32'};font-weight:700">${e.com_pedido?'üîµ Em rota':'üü¢ Livre'}</span>`;
    if(mk[e.id]){mk[e.id].setLatLng(ll);mk[e.id].setIcon(ico);}
    else mk[e.id]=L.marker(ll,{icon:ico}).addTo(m).bindPopup(popup);
    bounds.push(ll);
    if(!primLl)primLl=ll;
  });
  if(seg[tipo]&&primLl){m.setView(primLl,16,{animate:true});}
  else if(!seg[tipo]){
    if(bounds.length===1)m.setView(bounds[0],15);
    else if(bounds.length>1)m.fitBounds(bounds,{padding:[40,40]});
    else m.setView([RP_LAT,RP_LNG],13);
  }
  setTimeout(()=>m.invalidateSize(),300);
}

function toggleFollowEnt(tipo){
  seg[tipo]=!seg[tipo];
  const bid='btn-fol-'+(tipo==='admin'?'adm':'lj');
  const b=$(bid);
  if(b){
    b.classList.toggle('seguindo',seg[tipo]);
    b.innerHTML=seg[tipo]?'&#128308;&#128757;':'&#128757;';
    b.title=seg[tipo]?'Seguindo (clique para parar)':'Seguir entregador automaticamente';
  }
}
function toggleFollow(tipo){toggleFollowEnt(tipo);}
function centerMap(tipo){
  seg[tipo]=false;
  mapas[tipo]&&mapas[tipo].setView([RP_LAT,RP_LNG],13);
}

// ============ ADMIN ============
async function initAdmin(){
  admTab('painel',document.querySelector('.adm-tab'));
  await carregarDadosAdmin();
  await carregarAdmGpsToggle();
  criarMapa('admin');await pullAdm();
  ivs.mAdm=setInterval(pullAdm,5000);
  iniciarRealtimeDrivers('admin');
  await carregarAdmImpersonar();
}

async function carregarDadosAdmin(){
  const{data:e}=await db.from('usuarios').select('id').eq('tipo','entregador')
  const{data:l}=await db.from('usuarios').select('id').eq('tipo','loja')
  const{data:on}=await db.from('usuarios').select('id').eq('tipo','entregador').eq('online',true);
  const{data:rota}=await db.from('entregas').select('id').eq('status','em_rota');
  $('adm-cnt-ent').textContent=e?e.length:0;
  $('adm-cnt-loj').textContent=l?l.length:0;
  $('adm-cnt-on').textContent=on?on.length:0;
  $('adm-cnt-rota').textContent=rota?rota.length:0;
  // Entregas realtime
  const{data:ativ}=await db.from('entregas').select('*,loja:loja_id(nome_loja,nome),entregador:entregador_id(nome,telefone)').in('status',['aceito','chegou_loja','saiu_entrega','em_rota']).order('created_at',{ascending:false}).limit(20);
  const el=$('adm-entregas-realtime');
  if(!ativ||!ativ.length){el.innerHTML='<p style="color:#999;font-size:13px;">Nenhuma entrega ativa agora.</p>';return;}
  el.innerHTML=ativ.map(e=>{
    const st=e.status_detalhado||e.status;
    const stColor={'aceito':'#1565C0','chegou_loja':'#e65100','saiu_entrega':'#FF6B35','em_rota':'#6a1b9a'}[st]||'#555';
    const stLabel={'aceito':'Aceito','chegou_loja':'Na Loja','saiu_entrega':'A Caminho','em_rota':'Em Rota'}[st]||st;
    return `<div style="border-radius:10px;background:white;margin-bottom:8px;border:1.5px solid #e0e0e0;overflow:hidden;">
      <div style="padding:10px 12px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;" onclick="this.nextElementSibling.classList.toggle('hidden')">
        <div>
          <span style="font-weight:700;font-size:13px;">${e.numero_pedido?'#'+e.numero_pedido:e.cliente_nome||'Entrega'}</span>
          <span style="background:${stColor};color:white;font-size:10px;padding:2px 7px;border-radius:10px;margin-left:6px;">${stLabel}</span>
          <div style="font-size:11px;color:#888;margin-top:2px;">üõµ ${e.entregador?e.entregador.nome:'N√£o atribu√≠do'} &nbsp;|&nbsp; üè™ ${e.loja?e.loja.nome_loja||e.loja.nome:'?'}</div>
        </div>
        <span style="font-size:11px;color:#aaa;">‚ñº detalhes</span>
      </div>
      <div class="hidden" style="padding:0 12px 12px;border-top:1px solid #f0f0f0;">
        <p style="font-size:12px;color:#555;margin:6px 0;">üìç ${e.endereco_entrega}</p>
        ${e.cliente_nome?`<p style="font-size:11px;color:#888;">üë§ ${e.cliente_nome}${e.cliente_telefone?` | <a href="tel:${e.cliente_telefone}" style="color:#004E89">üìû ${e.cliente_telefone}</a>`:''}</p>`:''}
        ${e.distancia_km>0?`<p style="font-size:11px;color:#888;">üìè ${parseFloat(e.distancia_km).toFixed(1)}km | <strong style="color:#2e7d32">${fR(e.valor_corrida||0)}</strong></p>`:''}
        ${e.entregador?`<p style="font-size:11px;color:#1565C0;font-weight:700;">üõµ Entregador: ${e.entregador.nome}${e.entregador.telefone?' | '+e.entregador.telefone:''}</p>`:''}
        ${e.codigo_confirmacao?`<p style="font-size:11px;color:#8e44ad;">üîë C√≥d. iFood: ${e.codigo_confirmacao}</p>`:''}
        <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap;">
          <button onclick="admFinalizarEntrega('${e.id}')" style="background:#2e7d32;color:white;border:none;padding:7px 14px;border-radius:7px;font-size:12px;font-weight:700;cursor:pointer;">‚úÖ Finalizar</button>
          <button onclick="admForcarStatus('${e.id}','cancelado')" style="background:#c62828;color:white;border:none;padding:7px 14px;border-radius:7px;font-size:12px;font-weight:700;cursor:pointer;">‚úñ Cancelar</button>
          ${e.entregador_id?`<button onclick="admRealocarEntrega('${e.id}')" style="background:#e65100;color:white;border:none;padding:7px 14px;border-radius:7px;font-size:12px;font-weight:700;cursor:pointer;">üîÑ Trocar Entregador</button>`:''}
        </div>
      </div>
    </div>`;
  }).join('');
}

async function pullAdm(){
  const{data:ents}=await db.from('usuarios').select('id,nome,telefone,latitude,longitude').eq('tipo','entregador').eq('online',true);
  $('adm-cnt-on').textContent=ents?ents.length:0;
  const el=$('lista-on-adm');
  if(!ents||!ents.length){el.innerHTML='<span style="font-size:12px;color:#999">Nenhum online</span>';await atuMapa('admin',[]);carregarDadosAdmin();return;}
  // Verifica quem tem pedido ativo
  const{data:ativas}=await db.from('entregas').select('entregador_id').in('entregador_id',ents.map(e=>e.id)).in('status',['aceito','em_rota','chegou_loja','saiu_entrega']);
  const comPedidoIds=new Set((ativas||[]).map(a=>a.entregador_id));
  const entsParaMapa=ents.map(e=>({...e,com_pedido:comPedidoIds.has(e.id)}));
  el.innerHTML=ents.map(e=>{
    const cp=comPedidoIds.has(e.id);
    return `<span class="badge" onclick="focarEntAdm('${e.id}')" style="background:${cp?'#1565C0':'#2e7d32'};color:white;cursor:pointer;padding:6px 11px;" title="Clique para ver no mapa">&#128757; ${e.nome} ${e.telefone?'('+e.telefone+')':''}${cp?' üîµ':' üü¢'}</span>`;
  }).join('');
  await atuMapa('admin',entsParaMapa);
  carregarDadosAdmin();
}

function admTab(aba,btn){
  ['painel','lojas','entregadores','financeiro','impersonar'].forEach(a=>$('adm-'+a).classList.add('hidden'));
  document.querySelectorAll('.adm-tab').forEach(b=>b.classList.remove('active'));
  $('adm-'+aba).classList.remove('hidden');
  if(btn)btn.classList.add('active');
  if(aba==='lojas')carregarAdmLojas();
  else if(aba==='entregadores')carregarAdmEnt();
  else if(aba==='financeiro')carregarFinAdm();
}

async function carregarAdmLojas(){
  const el=$('adm-loj-lst');el.innerHTML='<p>Carregando...</p>';
  const{data}=await db.from('usuarios').select('*').eq('tipo','loja');
  if(!data||!data.length){el.innerHTML='<p>Nenhuma loja</p>';return;}
  el.innerHTML=data.map(l=>`
    <div class="secao">
      <div style="display:flex;justify-content:space-between;margin-bottom:7px;">
        <div><strong>${l.nome_loja||l.nome}</strong> <span style="font-size:11px;color:#888;">[${l.codigo_loja||'---'}]</span><br>
        <small style="color:#888;">${l.endereco||''} | Tel: ${l.telefone||'-'}</small></div>
        <span class="badge b-${l.status}">${l.status}</span>
      </div>
      <div class="row" style="flex-wrap:wrap;">
        <label style="font-size:11px;">Taxa R$</label>
        <input type="number" id="tx-${l.id}" value="${parseFloat(l.taxa_sistema||0.50).toFixed(2)}" step="0.01" min="0" style="width:70px;padding:6px;border:1.5px solid #e0e0e0;border-radius:6px;font-size:12px;">
        <button class="btn-sm blue" onclick="saveTaxAdm('${l.id}')">Salvar Taxa</button>
        <button class="btn-sm ${l.status==='ativo'?'red':'green'}" onclick="toggleStAdm('${l.id}','${l.status}','loja')">${l.status==='ativo'?'Bloquear':'Ativar'}</button>
      </div>
      <small id="tx-msg-${l.id}" style="color:#27ae60;margin-top:3px;display:block;"></small>
    </div>`).join('');
}

async function carregarAdmEnt(){
  const el=$('adm-ent-lst');el.innerHTML='<p>Carregando...</p>';
  const{data}=await db.from('usuarios').select('*').eq('tipo','entregador');
  if(!data||!data.length){el.innerHTML='<p>Nenhum entregador</p>';return;}
  el.innerHTML=data.map(e=>`
    <div class="secao">
      <div style="display:flex;justify-content:space-between;">
        <div><strong>${e.nome}</strong> <span class="badge ${e.online?'b-online':'b-offline'}">${e.online?'Online':'Offline'}</span><br>
        <small style="color:#888;">Tel: ${e.telefone||'-'} | Placa: ${e.placa_moto||'-'} | Pix: ${e.chave_pix||'-'}</small></div>
        <div style="display:flex;flex-direction:column;gap:5px;align-items:flex-end;">
          <span class="badge b-${e.status}">${e.status}</span>
          <button class="btn-sm ${e.status==='ativo'?'red':'green'}" onclick="toggleStAdm('${e.id}','${e.status}','ent')">${e.status==='ativo'?'Bloquear':'Ativar'}</button>
        </div>
      </div>
    </div>`).join('');
}

async function carregarFinAdm(){
  const p=$('adm-fin-per').value;
  const lojaFiltro=$('adm-fin-loja')?.value||'';
  const el=$('adm-fin-dados');
  el.innerHTML='<p style="text-align:center;padding:20px;color:#888;">‚è≥ Carregando dados...</p>';

  // Calcula per√≠odo
  function getPeriodo(per){
    const now=new Date();
    const hoje=new Date(now.getFullYear(),now.getMonth(),now.getDate());
    if(per==='hoje') return {ini:hoje,fim:new Date(hoje.getTime()+86400000-1)};
    if(per==='semana'){
      const d=new Date(hoje);d.setDate(d.getDate()-((d.getDay()+6)%7));// segunda
      return{ini:d,fim:new Date(d.getTime()+7*86400000-1)};
    }
    if(per==='semana_passada'){
      const d=new Date(hoje);d.setDate(d.getDate()-((d.getDay()+6)%7)-7);
      return{ini:d,fim:new Date(d.getTime()+7*86400000-1)};
    }
    if(per==='mes'){const d=new Date(now.getFullYear(),now.getMonth(),1);return{ini:d,fim:new Date(now.getFullYear(),now.getMonth()+1,0,23,59,59)};}
    if(per==='mes_passado'){const d=new Date(now.getFullYear(),now.getMonth()-1,1);return{ini:d,fim:new Date(now.getFullYear(),now.getMonth(),0,23,59,59)};}
    return{ini:hoje,fim:new Date(hoje.getTime()+86400000-1)};
  }
  const{ini,fim}=getPeriodo(p);

  let q=db.from('entregas').select('*,loja:loja_id(nome_loja,nome,id),entregador:entregador_id(nome,id)')
    .gte('created_at',ini.toISOString()).lte('created_at',fim.toISOString());
  if(lojaFiltro) q=q.eq('loja_id',lojaFiltro);
  const{data:entregas}=await q.order('created_at',{ascending:false});
  const{data:lojas}=await db.from('usuarios').select('id,nome_loja,nome').eq('tipo','loja');

  // Popula filtro de lojas (uma vez)
  const selLoja=$('adm-fin-loja');
  if(selLoja&&selLoja.options.length<=1&&lojas){
    lojas.forEach(l=>{if(!selLoja.querySelector(`option[value="${l.id}"]`)){const o=document.createElement('option');o.value=l.id;o.textContent=l.nome_loja||l.nome;selLoja.appendChild(o);}});
  }

  if(!entregas||!entregas.length){el.innerHTML='<p style="color:#999;text-align:center;padding:30px;">Sem entregas no per√≠odo selecionado.</p>';return;}

  const KM_LIMITE=5; // km limite padr√£o para categoriza√ß√£o
  const totSis=entregas.reduce((s,e)=>s+parseFloat(e.valor_sistema||0),0);
  const totEnt=entregas.reduce((s,e)=>s+parseFloat(e.valor_corrida||e.valor_entregador||0),0);
  const entPorEntregador={};
  entregas.forEach(e=>{
    const eid=e.entregador_id||'sem';
    const enome=e.entregador?.nome||'Sem entregador';
    if(!entPorEntregador[eid])entPorEntregador[eid]={nome:enome,corridas:[],totalVal:0,abaixoKm:0,acimaKm:0,valAbaixo:0,valAcima:0};
    const d=parseFloat(e.distancia_km||0);
    const v=parseFloat(e.valor_corrida||e.valor_entregador||0);
    entPorEntregador[eid].corridas.push(e);
    entPorEntregador[eid].totalVal+=v;
    if(d>0&&d<=KM_LIMITE){entPorEntregador[eid].abaixoKm++;entPorEntregador[eid].valAbaixo+=v;}
    else if(d>KM_LIMITE){entPorEntregador[eid].acimaKm++;entPorEntregador[eid].valAcima+=v;}
    else{entPorEntregador[eid].abaixoKm++;entPorEntregador[eid].valAbaixo+=v;}
  });

  // Entregas por dia para gr√°fico de linha
  const porDia={};
  entregas.forEach(e=>{
    const dia=e.created_at?.split('T')[0]||'';
    if(!porDia[dia])porDia[dia]={entregas:0,sistema:0,entregadores:0};
    porDia[dia].entregas++;
    porDia[dia].sistema+=parseFloat(e.valor_sistema||0);
    porDia[dia].entregadores+=parseFloat(e.valor_corrida||e.valor_entregador||0);
  });
  const dias=Object.keys(porDia).sort();
  const diasLabel=dias.map(d=>{const[,m,dd]=d.split('-');return`${dd}/${m}`;});

  // Bairros top 8
  const porBairro={};
  entregas.forEach(e=>{
    const b=(e.endereco_bairro||'Sem bairro').trim()||'Sem bairro';
    if(!porBairro[b])porBairro[b]={cnt:0,val:0};
    porBairro[b].cnt++;
    porBairro[b].val+=parseFloat(e.valor_corrida||e.valor_entregador||0);
  });
  const bairrosArr=Object.entries(porBairro).sort((a,b)=>b[1].cnt-a[1].cnt).slice(0,8);

  // M√©tricas
  const ticketMedio=entregas.length>0?totEnt/entregas.length:0;
  const kmTotal=entregas.reduce((s,e)=>s+parseFloat(e.distancia_km||0),0);
  const custoKm=kmTotal>0?(totEnt/kmTotal):0;

  // HTML do relat√≥rio
  const entradoresArr=Object.values(entPorEntregador).sort((a,b)=>b.totalVal-a.totalVal);
  const coresEnt=['#FF6B35','#004E89','#00C9A7','#8e44ad','#e74c3c','#27ae60','#f39c12'];

  el.innerHTML=`
  <!-- RESUMO GERAL -->
  <div class="secao" style="background:linear-gradient(135deg,#004E89,#FF6B35);color:white;border-radius:12px;padding:14px;margin-bottom:10px;">
    <div style="font-size:11px;font-weight:700;opacity:.8;margin-bottom:8px;text-transform:uppercase;">Resumo do Per√≠odo</div>
    <div class="g3">
      <div style="text-align:center;background:rgba(255,255,255,.15);border-radius:8px;padding:10px;">
        <div style="font-size:10px;opacity:.8;">Entregas</div>
        <div style="font-size:24px;font-weight:700;">${entregas.length}</div>
      </div>
      <div style="text-align:center;background:rgba(255,255,255,.15);border-radius:8px;padding:10px;">
        <div style="font-size:10px;opacity:.8;">Taxa Sistema</div>
        <div style="font-size:16px;font-weight:700;">${fR(totSis)}</div>
      </div>
      <div style="text-align:center;background:rgba(255,255,255,.15);border-radius:8px;padding:10px;">
        <div style="font-size:10px;opacity:.8;">A Pagar Ent.</div>
        <div style="font-size:16px;font-weight:700;">${fR(totEnt)}</div>
      </div>
    </div>
  </div>

  <!-- GR√ÅFICO ENTREGAS POR DIA -->
  ${dias.length>1?`<div class="secao">
    <div class="s-title">üìà Entregas por Dia</div>
    <canvas id="chart-dias" height="160"></canvas>
  </div>`:''}

  <!-- GR√ÅFICO PIZZA ENTREGADORES -->
  ${entradoresArr.length>1?`<div class="secao">
    <div class="s-title">ü•ß Distribui√ß√£o por Entregador</div>
    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
      <canvas id="chart-pizza" width="160" height="160" style="max-width:160px;"></canvas>
      <div style="flex:1;">
        ${entradoresArr.map((e,i)=>`<div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;">
          <div style="width:12px;height:12px;border-radius:50%;background:${coresEnt[i%coresEnt.length]};flex-shrink:0;"></div>
          <span style="font-size:12px;">${e.nome}</span>
          <span style="margin-left:auto;font-weight:700;font-size:12px;">${e.corridas.length}x</span>
        </div>`).join('')}
      </div>
    </div>
  </div>`:''}

  <!-- DETALHAMENTO POR ENTREGADOR -->
  <div class="secao">
    <div class="s-title">üõµ Detalhamento por Entregador ‚Äî Limite: ${KM_LIMITE}km</div>
    ${entradoresArr.map((ent,i)=>`
    <div style="background:#f8f9fa;border-radius:10px;padding:12px;margin-bottom:10px;border-left:4px solid ${coresEnt[i%coresEnt.length]};">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <strong style="font-size:14px;">${ent.nome}</strong>
        <span style="background:#004E89;color:white;padding:3px 10px;border-radius:20px;font-size:13px;font-weight:700;">${fR(ent.totalVal)}</span>
      </div>
      <div class="g3" style="margin-bottom:8px;">
        <div style="background:white;border-radius:7px;padding:8px;text-align:center;">
          <div style="font-size:10px;color:#888;">Total corridas</div>
          <div style="font-size:18px;font-weight:700;color:#FF6B35;">${ent.corridas.length}</div>
        </div>
        <div style="background:white;border-radius:7px;padding:8px;text-align:center;">
          <div style="font-size:10px;color:#888;">At√© ${KM_LIMITE}km</div>
          <div style="font-size:14px;font-weight:700;color:#00C9A7;">${ent.abaixoKm}x<br><small>${fR(ent.valAbaixo)}</small></div>
        </div>
        <div style="background:white;border-radius:7px;padding:8px;text-align:center;">
          <div style="font-size:10px;color:#888;">Acima ${KM_LIMITE}km</div>
          <div style="font-size:14px;font-weight:700;color:#e74c3c;">${ent.acimaKm}x<br><small>${fR(ent.valAcima)}</small></div>
        </div>
      </div>
      <!-- Lista de corridas -->
      <details>
        <summary style="font-size:12px;color:#004E89;cursor:pointer;font-weight:600;">Ver ${ent.corridas.length} corridas ‚ñº</summary>
        <div style="margin-top:8px;">
          ${ent.corridas.map(c=>`<div style="padding:6px 0;border-bottom:1px solid #eee;font-size:11px;display:flex;justify-content:space-between;align-items:center;">
            <div>
              <strong>${c.cliente_nome||'Cliente'}</strong><br>
              <span style="color:#888;">${c.endereco_bairro||''} | ${parseFloat(c.distancia_km||0).toFixed(1)}km | ${c.created_at?.split('T')[0]||''}</span>
            </div>
            <span style="font-weight:700;color:#2e7d32;white-space:nowrap;">${fR(c.valor_corrida||c.valor_entregador)}</span>
          </div>`).join('')}
        </div>
      </details>
    </div>`).join('')}
  </div>

  <!-- GR√ÅFICO BARRAS: TOP BAIRROS -->
  <div class="secao" id="adm-fin-bairros-sec">
    <div class="s-title">üìç Top Bairros</div>
    <canvas id="chart-bairros-adm" height="160"></canvas>
  </div>

  <!-- M√âTRICAS FINANCEIRAS -->
  <div class="secao">
    <div class="s-title">üí° M√©tricas do Per√≠odo</div>
    <div id="adm-fin-metricas"></div>
  </div>

  <!-- RESUMO POR LOJA -->
  <div class="secao">
    <div class="s-title">üè™ Resumo por Loja</div>
    ${(lojas||[]).map(lj=>{
      const ljEnt=entregas.filter(e=>e.loja_id===lj.id);
      if(!ljEnt.length)return'';
      const ljSis=ljEnt.reduce((s,e)=>s+parseFloat(e.valor_sistema||0),0);
      const ljEntV=ljEnt.reduce((s,e)=>s+parseFloat(e.valor_corrida||e.valor_entregador||0),0);
      return`<div style="background:#f8f9fa;border-radius:10px;padding:10px;margin-bottom:8px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <strong>${lj.nome_loja||lj.nome}</strong>
          <span style="font-size:12px;color:#888;">${ljEnt.length} entregas</span>
        </div>
        <div class="g2b" style="margin-top:6px;gap:6px;">
          <div style="background:#e3f2fd;border-radius:6px;padding:7px;text-align:center;font-size:11px;">
            <div style="color:#888;">Taxa Sistema</div><strong style="color:#004E89;">${fR(ljSis)}</strong>
          </div>
          <div style="background:#e8f5e9;border-radius:6px;padding:7px;text-align:center;font-size:11px;">
            <div style="color:#888;">A Pagar Ent.</div><strong style="color:#2e7d32;">${fR(ljEntV)}</strong>
          </div>
        </div>
      </div>`;
    }).join('')}
  </div>`;

  // Renderiza gr√°ficos ap√≥s DOM atualizado
  setTimeout(()=>{
    // Gr√°fico de linha por dia
    if(dias.length>1){
      const ctx=document.getElementById('chart-dias');
      if(ctx){
        if(ctx._chart)ctx._chart.destroy();
        ctx._chart=new Chart(ctx,{
          type:'line',
          data:{
            labels:diasLabel,
            datasets:[
              {label:'Entregas',data:dias.map(d=>porDia[d].entregas),borderColor:'#FF6B35',backgroundColor:'rgba(255,107,53,.1)',tension:.3,fill:true,yAxisID:'y'},
              {label:'Taxa Sistema',data:dias.map(d=>porDia[d].sistema),borderColor:'#004E89',backgroundColor:'transparent',tension:.3,borderDash:[4,4],yAxisID:'y2'},
              {label:'Pago Entregad.',data:dias.map(d=>porDia[d].entregadores),borderColor:'#00C9A7',backgroundColor:'transparent',tension:.3,yAxisID:'y2'}
            ]
          },
          options:{responsive:true,plugins:{legend:{labels:{font:{size:10}}}},scales:{y:{position:'left',ticks:{font:{size:10}}},y2:{position:'right',grid:{drawOnChartArea:false},ticks:{font:{size:10},callback:v=>'R$'+v.toFixed(0)}}}}
        });
      }
    }
    // Gr√°fico barras bairros
    if(bairrosArr.length>0){
      const ctxB=document.getElementById('chart-bairros-adm');
      if(ctxB){
        if(ctxB._chart)ctxB._chart.destroy();
        ctxB._chart=new Chart(ctxB,{
          type:'bar',
          data:{
            labels:bairrosArr.map(b=>b[0]),
            datasets:[{
              label:'Entregas',
              data:bairrosArr.map(b=>b[1].cnt),
              backgroundColor:'rgba(0,78,137,.7)',
              borderColor:'#004E89',borderWidth:1,borderRadius:4
            }]
          },
          options:{responsive:true,plugins:{legend:{display:false}},scales:{x:{ticks:{font:{size:9},maxRotation:30}},y:{ticks:{font:{size:10},stepSize:1}}}}
        });
      } else {
        const sec=$('adm-fin-bairros-sec');if(sec)sec.style.display='none';
      }
    } else {
      const sec=$('adm-fin-bairros-sec');if(sec)sec.style.display='none';
    }

    // M√©tricas financeiras
    const metEl=$('adm-fin-metricas');
    if(metEl){
      metEl.innerHTML=`
      <div class="g2b" style="gap:8px;">
        <div style="background:#e3f2fd;border-radius:10px;padding:11px;text-align:center;">
          <div style="font-size:10px;color:#555;margin-bottom:4px;">üéüÔ∏è Ticket M√©dio</div>
          <div style="font-size:18px;font-weight:700;color:#004E89;">${fR(ticketMedio)}</div>
          <div style="font-size:10px;color:#888;">por corrida</div>
        </div>
        <div style="background:#e8f5e9;border-radius:10px;padding:11px;text-align:center;">
          <div style="font-size:10px;color:#555;margin-bottom:4px;">üìè Km Rodado</div>
          <div style="font-size:18px;font-weight:700;color:#2e7d32;">${kmTotal.toFixed(1)}km</div>
          <div style="font-size:10px;color:#888;">${fR(custoKm)}/km</div>
        </div>
      </div>
      <div style="margin-top:8px;background:#fff3e0;border-radius:10px;padding:11px;text-align:center;">
        <div style="font-size:10px;color:#555;margin-bottom:4px;">üìä M√©dia di√°ria</div>
        <div style="font-size:18px;font-weight:700;color:#e65100;">${dias.length>0?(entregas.length/dias.length).toFixed(1):0} entregas/dia</div>
      </div>`;
    }

    // Gr√°fico pizza
    if(entradoresArr.length>1){
      const ctx2=document.getElementById('chart-pizza');
      if(ctx2){
        if(ctx2._chart)ctx2._chart.destroy();
        ctx2._chart=new Chart(ctx2,{
          type:'doughnut',
          data:{
            labels:entradoresArr.map(e=>e.nome),
            datasets:[{data:entradoresArr.map(e=>e.corridas.length),backgroundColor:entradoresArr.map((_,i)=>coresEnt[i%coresEnt.length])}]
          },
          options:{responsive:false,plugins:{legend:{display:false}},cutout:'60%'}
        });
      }
    }
  },100);
}

async function toggleStAdm(id,st,tipo){
  const novo=st==='ativo'?'bloqueado':'ativo';
  await db.from('usuarios').update({status:novo}).eq('id',id);
  if(tipo==='loja')carregarAdmLojas();else carregarAdmEnt();
}
async function saveTaxAdm(id){
  const val=parseFloat($('tx-'+id).value);
  await db.from('usuarios').update({taxa_sistema:val}).eq('id',id);
  const m=$('tx-msg-'+id);m.textContent='Salvo!';setTimeout(()=>{m.textContent='';},2000);
}

async function carregarAdmImpersonar(){
  const{data:lojas}=await db.from('usuarios').select('id,nome_loja,nome').eq('tipo','loja');
  const{data:ents}=await db.from('usuarios').select('id,nome').eq('tipo','entregador');
  const selL=$('adm-sel-loja'),selE=$('adm-sel-ent');
  if(lojas)lojas.forEach(l=>{const o=document.createElement('option');o.value=l.id;o.textContent=l.nome_loja||l.nome;selL.appendChild(o);});
  if(ents)ents.forEach(e=>{const o=document.createElement('option');o.value=e.id;o.textContent=e.nome;selE.appendChild(o);});
}

async function admVerLoja(){
  const id=$('adm-sel-loja').value;if(!id)return;
  const el=$('adm-loja-view');el.innerHTML='<p>Carregando...</p>';
  const{data:lj}=await db.from('usuarios').select('*').eq('id',id).single();
  if(!lj){el.innerHTML='<p>Erro ao carregar</p>';return;}
  const{data:ents}=await db.from('entregas').select('*,entregador:entregador_id(nome)').eq('loja_id',id).neq('status','entregue').order('ordem_rota');
  const{data:assoc}=await db.from('loja_entregadores').select('*,e:entregador_id(nome,online,status)').eq('loja_id',id);
  const{data:rel}=await db.from('entregas').select('*,entregador:entregador_id(nome)').eq('loja_id',id).gte('created_at',iDia()).lte('created_at',fDia());
  const totH=rel?rel.length:0;
  const totSis=rel?rel.reduce((s,e)=>s+parseFloat(e.valor_sistema||0),0):0;
  const totEnt=rel?rel.reduce((s,e)=>s+parseFloat(e.valor_corrida||e.valor_entregador||0),0):0;
  el.innerHTML=`
    <div style="background:#e3f2fd;border-radius:10px;padding:12px;margin-bottom:10px;">
      <strong>${lj.nome_loja||lj.nome}</strong> | Codigo: <strong>${lj.codigo_loja||'---'}</strong><br>
      <small>${lj.endereco||''}</small><br>
      <small>Taxa sistema: ${fR(lj.taxa_sistema)} | Taxa entregador: ${fR(lj.taxa_entrega)}</small>
    </div>
    <div class="g3" style="margin-bottom:10px;">
      <div style="text-align:center;padding:8px;background:#fff3e0;border-radius:8px;"><p style="font-size:10px;color:#888;">Hoje</p><p style="font-size:18px;font-weight:700;color:#FF6B35;">${totH}</p></div>
      <div style="text-align:center;padding:8px;background:#e3f2fd;border-radius:8px;"><p style="font-size:10px;color:#888;">Sistema</p><p style="font-size:13px;font-weight:700;color:#004E89;">${fR(totSis)}</p></div>
      <div style="text-align:center;padding:8px;background:#e8f5e9;border-radius:8px;"><p style="font-size:10px;color:#888;">Entregad.</p><p style="font-size:13px;font-weight:700;color:#00C9A7;">${fR(totEnt)}</p></div>
    </div>
    <div style="margin-bottom:8px;"><strong>Entregadores vinculados:</strong><br>${(assoc||[]).map(a=>`<span class="badge ${a.e&&a.e.online?'b-online':'b-offline'}" style="margin:2px;">${a.e?a.e.nome:'?'}</span>`).join('')||'Nenhum'}</div>
    <div><strong>Pedidos ativos:</strong><br>${(!ents||!ents.length)?'<p style="color:#999;font-size:12px;">Nenhum pedido ativo</p>':ents.map(e=>`
      <div class="ecard ${e.status==='em_rota'?'rota':''}">
        <div style="display:flex;justify-content:space-between;"><strong>${e.numero_pedido?'#'+e.numero_pedido:e.cliente_nome||'Entrega'}</strong><span class="badge b-${e.status_detalhado||e.status}">${e.status_detalhado||e.status}</span></div>
        <p style="font-size:12px;color:#555;">&#128205; ${e.endereco_entrega}</p>
        ${e.entregador?`<p style="font-size:11px;color:#004E89;">&#128757; ${e.entregador.nome}</p>`:''}
        ${e.valor_corrida>0?`<span class="badge b-ativo">${fR(e.valor_corrida)}</span>`:''}
      </div>`).join('')}
    </div>`;
}

async function admVerEnt(){
  const id=$('adm-sel-ent').value;if(!id)return;
  const el=$('adm-ent-view');el.innerHTML='<p>Carregando...</p>';
  const{data:ent}=await db.from('usuarios').select('*').eq('id',id).single();
  if(!ent){el.innerHTML='<p>Erro</p>';return;}
  const{data:rota}=await db.from('entregas').select('*,loja:loja_id(nome_loja,nome)').eq('entregador_id',id).in('status',['aceito','em_rota','chegou_loja','saiu_entrega']).order('ordem_rota');
  const{data:ganhos}=await db.from('entregas').select('id,valor_corrida,valor_entregador').eq('entregador_id',id).gte('created_at',iDia()).lte('created_at',fDia());
  const totalGanhos=ganhos?ganhos.reduce((s,e)=>s+parseFloat(e.valor_corrida||e.valor_entregador||0),0):0;
  const{data:assoc}=await db.from('loja_entregadores').select('l:loja_id(nome_loja,nome)').eq('entregador_id',id);
  el.innerHTML=`
    <div style="background:#e8f5e9;border-radius:10px;padding:12px;margin-bottom:10px;">
      <strong>${ent.nome}</strong> <span class="badge ${ent.online?'b-online':'b-offline'}">${ent.online?'Online':'Offline'}</span><br>
      <small>Tel: ${ent.telefone||'-'} | Placa: ${ent.placa_moto||'-'} | Pix: ${ent.chave_pix||'-'}</small><br>
      <small>Lojas: ${(assoc||[]).map(a=>a.l?a.l.nome_loja||a.l.nome:'?').join(', ')||'Nenhuma'}</small><br>
      <small>Ganhos hoje: <strong>${fR(totalGanhos)}</strong> (${ganhos?ganhos.length:0} entregas)</small>
    </div>
    <strong>Rota atual:</strong><br>
    ${(!rota||!rota.length)?'<p style="color:#999;font-size:12px;">Sem entregas na rota.</p>':rota.map((e,i)=>`
      <div class="ecard rota">
        <div style="display:flex;justify-content:space-between;"><strong>${i+1}. ${e.numero_pedido?'#'+e.numero_pedido:e.cliente_nome||'Entrega'}</strong><span class="badge b-${e.status_detalhado||e.status}">${e.status_detalhado||e.status}</span></div>
        <p style="font-size:12px;color:#555;">&#128205; ${e.endereco_entrega}</p>
        <p style="font-size:11px;color:#888;">&#127978; ${e.loja?e.loja.nome_loja||e.loja.nome:'?'}</p>
        ${e.codigo_confirmacao?`<p style="font-size:11px;color:#8e44ad;">&#128273; Cod. Conf: ${e.codigo_confirmacao}</p>`:''}
        ${e.valor_corrida>0?`<span class="badge b-ativo">${fR(e.valor_corrida)}</span>`:''}
        <div class="row" style="margin-top:6px;flex-wrap:wrap;">
          <button class="btn-sm blue" onclick="admForcarStatus('${e.id}','entregue')">&#10003; Marcar Entregue (ADM)</button>
          <button class="btn-sm red" onclick="admForcarStatus('${e.id}','cancelado')">Cancelar</button>
        </div>
      </div>`).join('')}`;
}

async function admForcarStatus(id,status){
  await db.from('entregas').update({status,status_detalhado:status,entregue_at:status==='entregue'?new Date().toISOString():null}).eq('id',id);
  const sel=$('adm-sel-ent').value;if(sel)admVerEnt();
}

// ============ LOJA ============
async function initLoja(){
  const{data}=await db.from('usuarios').select('*').eq('id',U.id).single();
  if(data){
    // Preserva campos locais importantes que podem n√£o existir no banco
    const lojaAtivaLocal=U.loja_ativa_id||null;
    const lojaNomeLocal=U._loja_ativa_nome||null;
    const lojaCodLocal=U._loja_ativa_codigo||null;
    U={...U,...data};
    // Se o banco retornou null mas temos valor local, mant√©m o local
    if(!U.loja_ativa_id&&lojaAtivaLocal)U.loja_ativa_id=lojaAtivaLocal;
    if(!U._loja_ativa_nome&&lojaNomeLocal)U._loja_ativa_nome=lojaNomeLocal;
    if(!U._loja_ativa_codigo&&lojaCodLocal)U._loja_ativa_codigo=lojaCodLocal;
    localStorage.setItem('u',JSON.stringify(U));
  }
  $('loja-nome').textContent=U.nome_loja||U.nome;
  $('loja-cod').textContent=U.codigo_loja||'------';
  $('lj-ts').textContent=fR(U.taxa_sistema);
  // App logo
  const ljLogo=$('lj-app-logo');if(ljLogo)ljLogo.src=LOGO_URL;
  // Logo da loja ‚Äî sempre busca do banco para garantir persist√™ncia
  if(U.logo_url)mostrarLogo(U.logo_url,'loja-logo-box');
  db.from('usuarios').select('logo_url').eq('id',U.id).single().then(({data:ld})=>{
    if(ld&&ld.logo_url){
      mostrarLogo(ld.logo_url,'loja-logo-box');
      if(U.logo_url!==ld.logo_url){U.logo_url=ld.logo_url;try{localStorage.setItem('u',JSON.stringify(U));}catch(e){}}
    }
  });
  // GPS toggle
  atuToggleGps(U.gps_validacao_obrigatorio||false);
  // Taxa tipo
  const tipoEl=$('lj-taxa-tipo');
  if(tipoEl&&U.taxa_tipo){tipoEl.value=U.taxa_tipo;toggleTaxaTipo();}
  if(U.taxa_tipo==='por_km'){
    if($('lj-taxa-base'))$('lj-taxa-base').value=parseFloat(U.taxa_entrega||0).toFixed(2);
    if($('lj-km-limite'))$('lj-km-limite').value=parseFloat(U.taxa_km_limite||5).toFixed(1);
    if($('lj-taxa-km-exc'))$('lj-taxa-km-exc').value=parseFloat(U.taxa_km_excedente||2).toFixed(2);
  }else if(U.taxa_tipo==='fixo_mais_km'){
    if($('lj-taxa-fixo-base'))$('lj-taxa-fixo-base').value=parseFloat(U.taxa_fixo_base||0).toFixed(2);
    if($('lj-taxa-por-ent'))$('lj-taxa-por-ent').value=parseFloat(U.taxa_entrega||0).toFixed(2);
    if($('lj-km-limite2'))$('lj-km-limite2').value=parseFloat(U.taxa_km_limite||7).toFixed(1);
    if($('lj-taxa-km-exc2'))$('lj-taxa-km-exc2').value=parseFloat(U.taxa_km_excedente||0).toFixed(2);
  }else{if($('lj-taxa-new'))$('lj-taxa-new').value=parseFloat(U.taxa_entrega||0).toFixed(2);}
  const{data:ent}=await db.from('entregas').select('id').eq('loja_id',U.id).gte('created_at',iDia()).lte('created_at',fDia());
  $('lj-hj').textContent=ent?ent.length:0;
  // Geocode loja
  if(U.loja_lat&&U.loja_lng){lojaGeoCache={lat:U.loja_lat,lng:U.loja_lng};}
  else if(U.endereco){geocode(U.endereco).then(g=>{if(g){lojaGeoCache=g;db.from('usuarios').update({loja_lat:g.lat,loja_lng:g.lng}).eq('id',U.id);}});}
  criarMapa('loja');await pullLj();
  ivs.mLj=setInterval(pullLj,5000);
  iniciarRealtimeDrivers('loja');
}

async function pullLj(){
  const{data:assoc}=await db.from('loja_entregadores').select('entregador_id').eq('loja_id',U.id);
  const el=$('lista-on-lj');
  if(!assoc||!assoc.length){el.innerHTML='<span style="font-size:12px;color:#999">Nenhum entregador vinculado.</span>';$('lj-online-cnt').textContent='0';return;}
  const ids=assoc.map(a=>a.entregador_id);
  const{data:todos}=await db.from('usuarios').select('id,nome,telefone,latitude,longitude,online').in('id',ids);
  const entsOnline=(todos||[]).filter(e=>e.online);
  $('lj-online-cnt').textContent=entsOnline.length;
  const{data:ativas}=entsOnline.length?await db.from('entregas').select('entregador_id').in('entregador_id',entsOnline.map(e=>e.id)).in('status',['aceito','em_rota','chegou_loja','saiu_entrega']):{data:[]};
  const comPedidoIds=new Set((ativas||[]).map(a=>a.entregador_id));
  const entsParaMapa=entsOnline.map(e=>({...e,com_pedido:comPedidoIds.has(e.id)}));
  // Lista clic√°vel ‚Äî clica no nome e o mapa foca nele
  el.innerHTML=entsOnline.length?entsOnline.map(e=>{
    const cp=comPedidoIds.has(e.id);
    const bg=cp?'#1565C0':'#2e7d32';
    const status=cp?'üîµ Em rota':'üü¢ Livre';
    return `<span onclick="focarEntregadorMapa('${e.id}')" style="background:${bg};color:white;padding:5px 11px;border-radius:20px;font-size:12px;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:5px;margin:2px;" title="Clique para ver no mapa">
      üõµ ${e.nome} <span style="font-size:10px;opacity:.85">${status}</span>
    </span>`;
  }).join(''):'<span style="font-size:12px;color:#999">Nenhum online agora.</span>';
  await atuMapa('loja',entsParaMapa);
}

async function salvarTaxaLj(){
  const tipo=v('lj-taxa-tipo');
  let base,kmLim,kmExc,fixoBase=0;
  if(tipo==='por_km'){
    base=parseFloat(v('lj-taxa-base')||0);
    kmLim=parseFloat(v('lj-km-limite')||5);
    kmExc=parseFloat(v('lj-taxa-km-exc')||0);
  }else if(tipo==='fixo_mais_km'){
    fixoBase=parseFloat(v('lj-taxa-fixo-base')||0);
    base=parseFloat(v('lj-taxa-por-ent')||0);
    kmLim=parseFloat(v('lj-km-limite2')||7);
    kmExc=parseFloat(v('lj-taxa-km-exc2')||0);
  }else{
    base=parseFloat(v('lj-taxa-new')||0);kmLim=5;kmExc=0;
  }
  // Tenta salvar com taxa_fixo_base
  let{error}=await db.from('usuarios').update({taxa_entrega:base,taxa_tipo:tipo,taxa_km_limite:kmLim,taxa_km_excedente:kmExc,taxa_fixo_base:fixoBase}).eq('id',U.id);
  // Se coluna taxa_fixo_base nao existe, salva sem ela
  if(error&&error.message&&error.message.includes('taxa_fixo_base')){
    const r2=await db.from('usuarios').update({taxa_entrega:base,taxa_tipo:tipo,taxa_km_limite:kmLim,taxa_km_excedente:kmExc}).eq('id',U.id);
    error=r2.error;
  }
  if(error){
    $('taxa-msg').style.color='#e53935';
    $('taxa-msg').textContent='‚ùå Erro ao salvar: '+error.message;
    return;
  }
  U.taxa_entrega=base;U.taxa_tipo=tipo;U.taxa_km_limite=kmLim;U.taxa_km_excedente=kmExc;U.taxa_fixo_base=fixoBase;
  localStorage.setItem('u',JSON.stringify(U));
  $('taxa-msg').style.color='#27ae60';$('taxa-msg').textContent='‚úÖ Configuracao salva!';
  setTimeout(()=>{$('taxa-msg').textContent='';},2000);
}

// Avisar pedido pronto (toca alerta em todos entregadores vinculados e online)
async function avisarPedidoPronto(){
  // Marca pedidos pendentes sem entregador como pedido_pronto=true
  const{data:ents}=await db.from('entregas').select('id').eq('loja_id',U.id).eq('status','pendente');
  if(!ents||!ents.length){alert('Nenhum pedido pendente para avisar.');return;}
  for(const e of ents)await db.from('entregas').update({pedido_pronto:true}).eq('id',e.id);
  alert('Aviso enviado! Os entregadores online serao notificados.');
}

// Calcular valor corrida baseado no endereco
async function atualizarValorCorrida(){
  const rua=v('p-rua'),num=v('p-nend'),bairro=v('p-bairro');
  if(!rua){$('p-valor-corrida').classList.add('hidden');return;}
  const endFull=fEnd(rua,num,bairro,v('p-cidade')||'Ribeirao Preto','');
  const geo=await geocode(endFull);
  if(!geo){$('p-valor-corrida').classList.add('hidden');return;}
  const lojaLat=lojaGeoCache.lat||RP_LAT,lojaLng=lojaGeoCache.lng||RP_LNG;
  const dist=distKm(lojaLat,lojaLng,geo.lat,geo.lng);
  const valor=calcularValorCorrida(dist,U.taxa_tipo||'fixo',U.taxa_entrega||0,U.taxa_km_limite||5,U.taxa_km_excedente||0);
  $('p-valor-txt').textContent=fR(valor);
  $('p-dist-txt').textContent='Distancia estimada: '+dist.toFixed(1)+' km';
  $('p-valor-corrida').classList.remove('hidden');
  window._pedidoGeo={lat:geo.lat,lng:geo.lng,dist,valor};
}

function abrirCamera(){$('ocr-camera').click();}
function abrirGaleria(){$('ocr-galeria').click();}

function abrirNovoPedido(){
  openM('pedido');
  ['ocr-camera','ocr-galeria'].forEach(id=>{const e=$(id);if(e)e.value='';});
  $('ocr-prev').classList.add('hidden');$('ocr-load').classList.add('hidden');
  ['p-num','p-cli','p-tel','p-rua','p-nend','p-bairro','p-obs','p-comp','p-cod-conf'].forEach(id=>{const e=$(id);if(e)e.value='';});
  $('p-cidade').value=U.endereco_cidade||U.cidade||'Ribeirao Preto';
  const ca=$('p-codconf-area');if(ca)ca.classList.add('hidden');
  clearM('ped-msg');$('p-valor-corrida').classList.add('hidden');
  window._pedidoGeo=null;
}

// ‚îÄ‚îÄ PARSER DE COMANDA BRASILEIRA (iFood, Takeat, Stone, etc.) ‚îÄ‚îÄ
function parsarComandaBR(txt){
  const lines=txt.split('\n').map(l=>l.trim()).filter(Boolean);
  const r={numero_pedido:'',nome_cliente:'',telefone:'',rua:'',numero_end:'',bairro:'',complemento:'',codigo_confirmacao:''};

  // N√∫mero do pedido: "Pedido #178" ou "Pedido #88" ou n√∫mero isolado no topo (4-6 d√≠gitos)
  // Tamb√©m reconhece: "5823" no in√≠cio, "EXPEDICAO 5823", "# 5823"
  const mHash=txt.match(/[Pp]edido\s*#?\s*(\d+)/)||txt.match(/EXPEDI[C√á][A√É]O\s*#?\s*(\d+)/i)||txt.match(/^\s*#\s*(\d{3,6})\s*$/m);
  if(mHash){r.numero_pedido=mHash[1];}
  else{
    // N√∫mero isolado nas primeiras 5 linhas (pedido de Stone/gen√©rico)
    for(let i=0;i<Math.min(5,lines.length);i++){
      if(/^\d{3,6}$/.test(lines[i])){r.numero_pedido=lines[i];break;}
    }
  }

  // Telefone: (16) 99xxx-xxxx ou 16 99xxx xxxx ou Tel: ...
  const mTel=txt.match(/[Tt]el(?:efone)?[:\s.]*\(?(\d{2})\)?[\s.-]?(\d{4,5})[\s.-]?(\d{4})/);
  if(mTel){r.telefone=mTel[1]+mTel[2]+mTel[3];}
  else{
    const mTel2=txt.match(/\((\d{2})\)\s*(\d{4,5})-?(\d{4})/);
    if(mTel2){r.telefone=mTel2[1]+mTel2[2]+mTel2[3];}
    else{
      const mTel3=txt.match(/(?<!\d)(\d{2})\s(\d{4,5})[\s-](\d{4})(?!\d)/);
      if(mTel3){r.telefone=mTel3[1]+mTel3[2]+mTel3[3];}
    }
  }

  // Nome do cliente: "Cliente: Nome" ou "cliente Nome"
  const mCli=txt.match(/[Cc]liente[:\s]+([^\n\r0-9#@]+?)(?:\n|$)/);
  if(mCli){r.nome_cliente=mCli[1].trim().replace(/\s+/g,' ');}
  else{
    // iFood: nome pr√≥prio em linha isolada (2+ palavras, primeira letra mai√∫scula)
    const excluir=['Delivery','iFood','Cupim','Lanche','Pedido','Total','Pagamento','Itens','Taxa','Entrega','Prevista','Cobrar','Valor','Forma','Bairro','Cidade','Comp','Ref','CEP','Data','Desc','Observ','CODIGO','Localiz'];
    for(const l of lines){
      if(l.length<4||l.length>50)continue;
      if(excluir.some(e=>l.includes(e)))continue;
      if(l.match(/^\d/)|| l.includes(':')|| l.includes('R$')|| l.includes('www'))continue;
      if(/^[A-Z√Å√Ä√É√Ç√â√ä√ç√ì√î√ï√ö√á][a-z√°√†√£√¢√©√™√≠√≥√¥√µ√∫√ß]+(?:\s+[A-Z√Å√Ä√É√Ç√â√ä√ç√ì√î√ï√ö√á][a-z√°√†√£√¢√©√™√≠√≥√¥√µ√∫√ß]+)+$/.test(l)){
        r.nome_cliente=l;break;
      }
    }
  }

  // Endere√ßo multi-formato: "Endere√ßo: Rua X, 200", "End: Av Y 100", "R. Manoel Ache, 206"
  const mEnd=txt.match(/[Ee]ndere[√ßc]o[:\s]+([^,\n\r]+),\s*(\d+)/)||
             txt.match(/\bEnd(?:ereco)?[:\s]+([^,\n\r]+),\s*(\d+)/i)||
             txt.match(/Localiza[c√ß][a√£]o[:\s]+([^,\n\r]+),\s*(\d+)/i);
  if(mEnd){r.rua=mEnd[1].trim();r.numero_end=mEnd[2];}
  else{
    // Linha com tipo de logradouro + nome + v√≠rgula + n√∫mero
    const mEnd2=txt.match(/(?:^|\n)\s*((?:Rua|Av(?:enida)?\.?|R\.|Trav(?:essa)?\.?|Alameda|Estrada|Est\.|Al\.)\s+[^\n,]+),\s*(\d+)/im);
    if(mEnd2){r.rua=mEnd2[1].trim();r.numero_end=mEnd2[2];}
    else{
      // Fallback: logradouro + espa√ßo + n√∫mero sem v√≠rgula (ex: "Rua das Flores 123")
      const mEnd3=txt.match(/(?:^|\n)\s*((?:Rua|Av(?:enida)?\.?|R\.)\s+[^\n\d,]{4,40})\s+(\d{1,5})(?:\s|,|$)/im);
      if(mEnd3)r.rua=mEnd3[1].trim();
    }
  }

  // Bairro: label expl√≠cito ou linha ap√≥s endere√ßo
  const mBairro=txt.match(/[Bb]airro[:\s]+([^\n\r]+)/)||txt.match(/B[:\s]+([A-Z√Å-√ö][a-z√°√†√£√¢√©√™√≠√≥√¥√µ√∫√ß][^\n\r]{2,30})/);
  if(mBairro){r.bairro=mBairro[1].trim().replace(/\s+/g,' ').replace(/^(Bairro|B)\s*/i,'');}

  // Complemento: "Comp: Ap 22" ‚Äî ignora tra√ßo sozinho
  const mComp=txt.match(/[Cc]omp(?:lemento)?[:\s]+([^\n\r]+)/);
  if(mComp){const c=mComp[1].trim();if(c!=='-'&&c!=='‚Äì'&&c!=='')r.complemento=c;}

  // C√≥digo de coleta iFood: "CODIGO DE COLETA PARCEIRA: 3266"
  const mCod=txt.match(/C[O√ì]DIGO\s+DE\s+COLETA\s+PARCEIRA[:\s]*(\d{4})/i);
  if(mCod){r.codigo_confirmacao=mCod[1];}

  return r;
}

async function lerComanda(event){
  const file=event.target.files[0];if(!file)return;
  const url=URL.createObjectURL(file);
  $('ocr-img').src=url;$('ocr-prev').classList.remove('hidden');
  const loadEl=$('ocr-load');
  loadEl.classList.remove('hidden');
  loadEl.innerHTML='<span style="font-size:12px;color:#555">üîç Preparando imagem...</span>';

  try{
    // Redimensiona imagem para max 1200px
    const base64=await new Promise((res,rej)=>{
      const img=new Image();
      img.onload=()=>{
        const MAX=1200;
        let w=img.width,h=img.height;
        if(w>MAX||h>MAX){if(w>h){h=Math.round(h*MAX/w);w=MAX;}else{w=Math.round(w*MAX/h);h=MAX;}}
        const cv=document.createElement('canvas');cv.width=w;cv.height=h;
        const ctx=cv.getContext('2d');ctx.drawImage(img,0,0,w,h);
        res(cv.toDataURL('image/jpeg',0.85).split(',')[1]);
      };
      img.onerror=rej;
      img.src=URL.createObjectURL(file);
    });

    loadEl.innerHTML='<span style="font-size:12px;color:#555">üîç Lendo comanda via Google Vision... aguarde</span>';

    // ‚îÄ‚îÄ GOOGLE CLOUD VISION API ‚îÄ‚îÄ
    const resp=await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${getGoogleKey()}`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        requests:[{
          image:{content:base64},
          features:[{type:'TEXT_DETECTION',maxResults:1}]
        }]
      })
    });

    loadEl.classList.add('hidden');

    if(!resp.ok){
      const errData=await resp.json().catch(()=>({}));
      const errMsg=errData.error?.message||resp.statusText||String(resp.status);
      const errCode=errData.error?.code||resp.status;
      const errDetails=errData.error?.details||errData.error?.errors||[];
      console.error('[OCR Google]',errCode,errMsg,errDetails);
      // Mostra mensagem t√©cnica completa para diagn√≥stico
      let errTip='';
      if(errCode===400&&errMsg.toLowerCase().includes('not valid')){
        errTip='<br><small style="color:#555;line-height:1.6;">‚öôÔ∏è Causa: <strong>Cloud Vision API n√£o est√° ativada</strong> no projeto.<br>Solu√ß√£o: <a href="https://console.cloud.google.com/apis/library/vision.googleapis.com" target="_blank" style="color:#004E89;">Clique aqui para ativar a API</a> ou acesse:<br>console.cloud.google.com ‚Üí Biblioteca ‚Üí Cloud Vision API ‚Üí Ativar</small>';
      }else if(errCode===403){
        errTip='<br><small style="color:#555;">‚öôÔ∏è Permiss√£o negada. Verifique se a Cloud Vision API est√° ativada.</small>';
      }
      showM('ped-msg','‚ùå Google Vision ('+errCode+'): '+errMsg+errTip,false);
      return;
    }

    const data=await resp.json();
    const rawText=data.responses?.[0]?.textAnnotations?.[0]?.description||'';

    if(!rawText){
      showM('ped-msg','‚ùå N√£o consegui ler texto na imagem. Tente foto mais n√≠tida e centralizada.',false);
      return;
    }

    // Parseia o texto extra√≠do
    const parsed=parsarComandaBR(rawText);

    // Preenche campos
    if(parsed.numero_pedido)$('p-num').value=parsed.numero_pedido;
    if(parsed.nome_cliente)$('p-cli').value=parsed.nome_cliente;
    if(parsed.telefone)$('p-tel').value=parsed.telefone;
    if(parsed.rua)$('p-rua').value=parsed.rua;
    if(parsed.numero_end)$('p-nend').value=parsed.numero_end;
    if(parsed.bairro)$('p-bairro').value=parsed.bairro;
    if(parsed.complemento)$('p-comp').value=parsed.complemento;
    window._ocrCodConf=parsed.codigo_confirmacao||'';
    if(parsed.codigo_confirmacao){
      const ca=$('p-codconf-area');if(ca)ca.classList.remove('hidden');
      $('p-cod-conf').value=parsed.codigo_confirmacao;
    }
    setTimeout(atualizarValorCorrida,400);

    const preenchidos=[parsed.nome_cliente,parsed.rua,parsed.numero_end,parsed.bairro].filter(Boolean).length;
    if(preenchidos>=3)showM('ped-msg','‚úÖ Comanda lida com sucesso! Confira os campos.',true);
    else if(preenchidos>=1)showM('ped-msg','‚ö†Ô∏è Leitura parcial ‚Äî complete os campos vazios.',false);
    else showM('ped-msg','‚ùå N√£o consegui ler. Preencha manualmente.',false);

  }catch(err){
    loadEl.classList.add('hidden');
    console.error('[OCR erro]',err);
    const msg=err.message||'';
    if(msg.includes('Failed to fetch')||msg.includes('NetworkError')){
      showM('ped-msg','‚ùå Sem conex√£o com a internet. Verifique a rede e tente novamente.',false);
    }else{
      showM('ped-msg','‚ùå Erro ao processar imagem. Tente novamente.',false);
    }
  }
}

// Parser inteligente ‚Äî suporta iFood, Takeat e sistemas similares
function parsearComanda(txt){
  const t=txt.replace(/\r/g,'').replace(/[ \t]+/g,' ');
  const linhas=t.split('\n').map(l=>l.trim()).filter(l=>l.length>0);
  const r={numero_pedido:'',nome_cliente:'',telefone:'',rua:'',numero_end:'',bairro:'',complemento:'',codigo_confirmacao:''};

  // ‚îÄ‚îÄ DETECTAR FORMATO ‚îÄ‚îÄ
  const isTakeat=/Takeat|takeat\.app|DELIVERY\s*\n.*Pedido #/i.test(t);
  const isIfood=/iFood|EXPEDICAO|COLETA PARCEIRA|Entrega Propria/i.test(t);

  // ‚îÄ‚îÄ NUMERO DO PEDIDO ‚îÄ‚îÄ
  // Takeat: "Pedido #178"  |  iFood: linha isolada "8589"
  const mPedTakeat=t.match(/Pedido\s*#?(\d+)/i);
  if(mPedTakeat){r.numero_pedido=mPedTakeat[1];}
  else{
    for(const l of linhas){if(/^\d{4,5}$/.test(l)){r.numero_pedido=l;break;}}
    if(!r.numero_pedido){const m=t.match(/Pedido[:\s]+(\d+)/i);if(m)r.numero_pedido=m[1];}
  }

  // ‚îÄ‚îÄ CODIGO DE COLETA iFood ‚îÄ‚îÄ
  const mCod=t.match(/(?:COLETA PARCEIRA|CODIGO DE COLETA)[:\s]+(\d{3,6})/i);
  if(mCod)r.codigo_confirmacao=mCod[1];

  // ‚îÄ‚îÄ NOME DO CLIENTE ‚îÄ‚îÄ
  if(isTakeat){
    // Takeat: "Cliente: Fulano" ou "Cliente:Fulano"
    const mNome=t.match(/Cliente[:\s]+([^\n]+)/i);
    if(mNome){
      const nome=mNome[1].trim();
      // Rejeita se for "whats" ou muito curto (bug de sistema)
      if(nome.length>2&&!/^(whats|zap|app|test)/i.test(nome))r.nome_cliente=nome;
    }
  } else if(isIfood){
    // iFood: nome aparece ap√≥s "Localizador:" ou "Primeiro pedido!"
    const idxLoc=linhas.findIndex(l=>/localizador/i.test(l));
    const idxPrim=linhas.findIndex(l=>/primeiro pedido/i.test(l));
    const idxInicio=Math.max(idxLoc,idxPrim);
    if(idxInicio>-1){
      for(let i=idxInicio+1;i<Math.min(idxInicio+5,linhas.length);i++){
        const l=linhas[i];
        if(pareceNomeCliente(l)){r.nome_cliente=l;break;}
      }
    }
    if(!r.nome_cliente){
      // Fallback: busca em todo texto
      for(const l of linhas){if(pareceNomeCliente(l)){r.nome_cliente=l;break;}}
    }
  }

  // ‚îÄ‚îÄ ENDERECO ‚îÄ‚îÄ
  // Takeat: "Endere√ßo: Rua X, 200"  |  iFood: "Endereco: Rua X, 17\n5"
  const mEndLabel=t.match(/Endere[c√ß]o[:\s]+([^\n]+)/i);
  if(mEndLabel){
    const endStr=mEndLabel[1].trim();
    // Tenta separar rua e n√∫mero: "Rua X, 200" ou "R. X, 200"
    const mRuaNum=endStr.match(/^(.+?)[,\s]+(\d+)\s*$/);
    if(mRuaNum){r.rua=mRuaNum[1].trim();r.numero_end=mRuaNum[2];}
    else{r.rua=endStr;}
  } else {
    // Sem label, busca linha que come√ßa com Rua/Av
    for(let i=0;i<linhas.length;i++){
      const l=linhas[i];
      const mEnd=l.match(/^((?:Rua|Avenida|Av\.|R\.|Al\.|Alameda|Travessa)\s+[^,\n]+?)(?:[,\s]+(\d+))?$/i);
      if(mEnd){
        r.rua=mEnd[1].trim();
        const numL=mEnd[2]||'';
        const prox=(linhas[i+1]||'').trim();
        // iFood: "17\n5" = 175
        if(numL&&/^\d+$/.test(prox)&&prox.length<=3){r.numero_end=numL+prox;}
        else if(numL){r.numero_end=numL;}
        else if(/^\d{1,5}$/.test(prox)){r.numero_end=prox;}
        break;
      }
    }
  }

  // ‚îÄ‚îÄ BAIRRO ‚îÄ‚îÄ
  const mBairro=t.match(/Bairro[:\s]+([^\n]+)/i);
  if(mBairro){
    r.bairro=mBairro[1]
      .replace(/\s*[\(\[][^\)\]]*[\)\]]/g,'')
      .replace(/\s*-\s*S[PQ-Z]\b.*/i,'')
      .replace(/\s*-?\s*CEP.*/i,'')
      .replace(/\s*\(\s*S-?\d+\s*\)/g,'')
      .trim();
    // Remove tra√ßo solit√°rio (Takeat usa "Comp: -")
    if(r.bairro==='-')r.bairro='';
  }

  // ‚îÄ‚îÄ COMPLEMENTO ‚îÄ‚îÄ
  const mComp=t.match(/(?:Comp(?:lemento)?)[:\s]+([^\n]+)/i);
  if(mComp){
    r.complemento=mComp[1].replace(/Bairro.*/i,'').trim();
    if(r.complemento==='-'||r.complemento==='- ')r.complemento='';
  }

  // ‚îÄ‚îÄ TELEFONE ‚îÄ‚îÄ
  // Takeat: "Tel: (16) 98157-3642"  |  iFood: "ID: 43421475"
  const mTelLabel=t.match(/Tel(?:efone)?[:\s]+([^\n]+)/i);
  if(mTelLabel){
    const tel=mTelLabel[1].replace(/\D/g,'');
    if(tel.length>=8)r.telefone=tel;
  }
  if(!r.telefone){
    const mId=t.match(/ID[:\s]+(\d{8,11})/i);
    if(mId)r.telefone=mId[1];
  }
  if(!r.telefone){
    const mTel2=t.match(/\(?\d{2}\)?\s?\d{4,5}[-\s]?\d{4}/);
    if(mTel2)r.telefone=mTel2[0].replace(/\D/g,'');
  }

  return r;
}

// Fun√ß√£o auxiliar: verifica se linha parece nome de cliente (para iFood)
function pareceNomeCliente(l){
  const naoNome=/^(Primeiro pedido|Data:|Entrega|Localizador|CODIGO|POR FAVOR|iFood|Steak|ITEM|Festival|Pagamento|Online|Valor|Taxa|Desconto|Cobrar|Rua |Av\.|Bairro|Comp|Cidade|EXPEDICAO|Entrega Propria|PEDIDO|0800|Tel|Fone|\*|\d{4}|Cupim|Paulim|Delivery|Store|Barbecue)/i;
  if(!l||l.length<4||l.length>60)return false;
  if(naoNome.test(l))return false;
  if(/\d{5,}/.test(l))return false;
  if(/R\$/.test(l))return false;
  if(l.includes(':'))return false;
  // Deve ter 2+ palavras com pelo menos 2 letras cada
  const palavras=l.split(' ').filter(p=>/[a-zA-Z√Ä-√∫]{2,}/.test(p));
  return palavras.length>=2;
}


async function salvarPedido(){
  const rua=v('p-rua');if(!rua){showM('ped-msg','Informe a rua de entrega');return;}
  const num=v('p-nend'),bairro=v('p-bairro'),cidade=v('p-cidade')||'Ribeirao Preto',comp=v('p-comp');
  const geo=window._pedidoGeo;
  const valor=geo?geo.valor:(U.taxa_entrega||0);
  const dist=geo?geo.dist:0;
  const dados={
    loja_id:U.id,
    numero_pedido:v('p-num'),cliente_nome:v('p-cli'),cliente_telefone:v('p-tel'),
    endereco_entrega:fEnd(rua,num,bairro,cidade,comp),
    endereco_rua:rua,endereco_numero:num,endereco_bairro:bairro,endereco_cidade:cidade,endereco_complemento:comp,
    valor_sistema:parseFloat(U.taxa_sistema||0),
    valor_entregador:parseFloat(valor),
    valor_corrida:parseFloat(valor),
    distancia_km:parseFloat(dist),
    lat_entrega:geo?geo.lat:null,lng_entrega:geo?geo.lng:null,
    status:'pendente',status_detalhado:'pendente',ordem_rota:99,
    pedido_pronto:false,
    codigo_confirmacao:window._ocrCodConf||''
  };
  const{error}=await db.from('entregas').insert([dados]);
  if(error){showM('ped-msg','Erro: '+error.message);return;}
  showM('ped-msg','Pedido salvo! '+fR(valor),true);
  const{data:ent}=await db.from('entregas').select('id').eq('loja_id',U.id).gte('created_at',iDia()).lte('created_at',fDia());
  $('lj-hj').textContent=ent?ent.length:0;
  setTimeout(()=>closeM('pedido'),1300);
}

// Guarda o plano de rota para confirma√ß√£o
let _rotaPlanoGrupos=[];
let _rotaPlanoEnts=[];

// ============================================================
// DISTRIBUI√á√ÉO INTELIGENTE COM IA
// ============================================================
let _qtdEntData={}; // {entId: {nome, qtd}}
let _rotaIAGrupos=[]; // [{entId, entNome, pedidos:[]}]

// Salva/carrega limite GLOBAL da loja (√∫nico para todos os entregadores)
function salvarLimiteGlobal(qtd){
  localStorage.setItem('loja_limite_global_'+U.id, Math.min(10,Math.max(1,qtd)));
}
function carregarLimiteGlobal(){
  return parseInt(localStorage.getItem('loja_limite_global_'+U.id)||'4')||4;
}
// Mant√©m fun√ß√µes antigas para compatibilidade (n√£o usadas mais)
function salvarLimiteEnt(entId,qtd){}
function carregarLimiteEnt(entId){return carregarLimiteGlobal();}

let _limiteGlobal=4; // limite de pedidos por entregador (configura√ß√£o da loja)

function ajustarLimiteGlobal(delta){
  _limiteGlobal=Math.min(10,Math.max(1,_limiteGlobal+delta));
  const el=$('qtd-limite-val');if(el)el.textContent=_limiteGlobal;
  salvarLimiteGlobal(_limiteGlobal);
  // Atualiza _qtdEntData com o novo limite para todos
  Object.keys(_qtdEntData).forEach(id=>{_qtdEntData[id].qtd=_limiteGlobal;});
  atuQtdTotal(window._qtdPendTotal||0);
}

async function abrirDefinirQuantidade(){
  const{data:peds}=await db.from('entregas').select('id,numero_pedido,cliente_nome,endereco_entrega,distancia_km,lat_entrega,lng_entrega').eq('loja_id',U.id).eq('status','pendente');
  if(!peds||!peds.length){alert('Sem pedidos pendentes para distribuir.');return;}

  const{data:assoc}=await db.from('loja_entregadores').select('entregador_id,e:entregador_id(id,nome,online)').eq('loja_id',U.id);
  const online=(assoc||[]).filter(a=>a.e&&a.e.online);
  if(!online.length){alert('Nenhum entregador online no momento.');return;}

  // Filtra entregadores que J√Å T√äM pedidos ativos ‚Äî n√£o podem receber novas rotas
  const idsOnline=online.map(a=>a.entregador_id);
  const{data:ocupados}=await db.from('entregas').select('entregador_id').in('entregador_id',idsOnline).in('status',['aceito','em_rota','chegou_loja','saiu_entrega']);
  const idsOcupados=new Set((ocupados||[]).map(x=>x.entregador_id));
  const livres=online.filter(a=>!idsOcupados.has(a.entregador_id));
  const emRota=online.filter(a=>idsOcupados.has(a.entregador_id));

  if(!livres.length){
    alert('Todos os entregadores online j√° est√£o com pedidos em andamento. Aguarde finalizarem para distribuir novas rotas.');
    return;
  }

  // Carrega limite global salvo
  _limiteGlobal=carregarLimiteGlobal();
  const el=$('qtd-limite-val');if(el)el.textContent=_limiteGlobal;

  // Monta _qtdEntData apenas com entregadores LIVRES
  _qtdEntData={};
  livres.forEach(a=>{_qtdEntData[a.entregador_id]={nome:a.e.nome,qtd:_limiteGlobal};});
  _rotaPlanoEnts=livres;

  // Monta lista visual dos entregadores
  const listLivres=livres.map(a=>`
    <div style="display:flex;align-items:center;gap:10px;padding:9px 12px;background:#f0faf5;border:1.5px solid #00C9A7;border-radius:9px;margin-bottom:7px;">
      <div style="font-size:20px;">üõµ</div>
      <div style="flex:1;">
        <div style="font-weight:700;font-size:13px;">${a.e.nome}</div>
        <div style="font-size:11px;color:#2e7d32;font-weight:600;">‚úÖ Livre ‚Äî receber√° at√© ${_limiteGlobal} pedido${_limiteGlobal>1?'s':''}</div>
      </div>
    </div>`).join('');

  const listOcupados=emRota.length?`<div style="margin-top:4px;margin-bottom:10px;">
    <p style="font-size:11px;font-weight:700;color:#e65100;margin-bottom:5px;">üîµ Em rota (n√£o receber√£o pedidos agora):</p>
    ${emRota.map(a=>`<div style="display:flex;align-items:center;gap:8px;padding:7px 10px;background:#fff3e0;border-radius:8px;margin-bottom:5px;opacity:.7;">
      <span style="font-size:16px;">üõµ</span>
      <div style="font-size:12px;color:#e65100;font-weight:600;">${a.e.nome} ‚Äî finalizando entregas...</div>
    </div>`).join('')}
  </div>`:'';

  $('qtd-ent-body').innerHTML=`
    <p style="font-size:12px;font-weight:700;color:#555;margin-bottom:8px;">Entregadores dispon√≠veis (${livres.length}):</p>
    ${listLivres}${listOcupados}`;

  atuQtdTotal(peds.length);
  $('qtd-msg').textContent='';
  window._qtdPendTotal=peds.length;
  window._qtdPendPeds=peds;
  closeM('rota');
  openM('qtd-ent');
}

// Mantida por compatibilidade (n√£o usada na nova UI)
function ajustarQtd(entId,delta){}

function atuQtdTotal(total){
  const nLivres=Object.keys(_qtdEntData).length;
  const capacidade=nLivres*(_limiteGlobal||4);
  const el=$('qtd-total-info');
  if(!el)return;
  if(total<=0){el.innerHTML='Sem pedidos pendentes.';el.style.background='#f5f5f5';return;}
  if(capacidade>=total){
    el.innerHTML=`‚úÖ <strong>${nLivres}</strong> entregador${nLivres>1?'es':''} √ó <strong>${_limiteGlobal||4}</strong> pedidos = capacidade de <strong>${capacidade}</strong> (${total} pendentes)`;
    el.style.background='#e8f5e9';
  } else {
    el.innerHTML=`‚ö†Ô∏è Capacidade: <strong>${capacidade}</strong> pedidos, mas h√° <strong>${total}</strong> pendentes ‚Äî <span style="color:#c62828;font-weight:700;">${total-capacidade} ficam sem entregador</span>`;
    el.style.background='#ffebee';
  }
}

async function gerarRotaComIA(){
  const peds=window._qtdPendPeds||[];
  if(!peds.length){showM('qtd-msg','Sem pedidos pendentes.',false);return;}

  const distribuicao=Object.entries(_qtdEntData).map(([id,v])=>([id,{...v,qtd:_limiteGlobal}]));
  if(!distribuicao.length){showM('qtd-msg','‚ö†Ô∏è Nenhum entregador dispon√≠vel.',false);return;}

  const btn=$('btn-gerar-rota');
  btn.textContent='‚è≥ Calculando rotas...';btn.disabled=true;
  showM('qtd-msg','Otimizando rotas...',true);

  const lojaLat=lojaGeoCache.lat||RP_LAT,lojaLng=lojaGeoCache.lng||RP_LNG;

  // PASSO 1: Geocode todos os pedidos
  const pedsGeo=[];
  for(const p of peds){
    let lat=parseFloat(p.lat_entrega||0),lng=parseFloat(p.lng_entrega||0);
    let geocodeFailed=false;
    if(!lat||!lng){
      const g=await geocode(p.endereco_entrega);
      if(g){lat=g.lat;lng=g.lng;await db.from('entregas').update({lat_entrega:lat,lng_entrega:lng}).eq('id',p.id);}
      else{geocodeFailed=true;lat=0;lng=0;} // N√ÉO usa coordenadas da loja como fallback
    }
    const dist=geocodeFailed?999:distKm(lojaLat,lojaLng,lat,lng);
    const ang=geocodeFailed?0:((angleDeg(lojaLat,lojaLng,lat,lng)%360)+360)%360;
    pedsGeo.push({id:p.id,num:p.numero_pedido||'',nome:p.cliente_nome||'Cliente',end:p.endereco_entrega||'',lat,lng,dist,ang,geocodeFailed});
  }

  // PASSO 2: Mesclar pedidos do MESMO endere√ßo (dist√¢ncia < 80m = mesmo local)
  // ATEN√á√ÉO: s√≥ agrupa pedidos com coordenadas v√°lidas ‚Äî evita agrupar pedidos sem GPS
  const grupos_end=[];
  const usados=new Set();
  pedsGeo.forEach((p,i)=>{
    if(usados.has(i))return;
    const grupo=[p];
    usados.add(i);
    // S√≥ agrupa se AMBOS t√™m coordenadas v√°lidas E est√£o muito pr√≥ximos
    if(!p.geocodeFailed){
      pedsGeo.forEach((q,j)=>{
        if(i===j||usados.has(j)||q.geocodeFailed)return;
        if(distKm(p.lat,p.lng,q.lat,q.lng)*1000<80){grupo.push(q);usados.add(j);}
      });
    }
    grupos_end.push(grupo);
  });
  // Cada "item de entrega" agora √© um grupo de pedidos no mesmo endere√ßo
  const itens=grupos_end.map(g=>({
    ids:g.map(x=>x.id),
    labels:g.map(x=>x.num?'#'+x.num:x.nome),
    end:g[0].end,lat:g[0].lat,lng:g[0].lng,dist:g[0].dist,ang:g[0].ang
  })).sort((a,b)=>a.dist-b.dist); // Ordena: mais pr√≥ximos primeiro

  // PASSO 3: Distribuir itens por √¢ngulo entre entregadores
  // Ordena entregadores por quantidade (maior primeiro = mais eficiente)
  const entsOrdenados=distribuicao.sort((a,b)=>b[1].qtd-a[1].qtd);
  const grupos_ent=entsOrdenados.map(([id,v])=>({entId:id,entNome:v.nome,limite:v.qtd,itens:[],totalPeds:0}));
  
  // Algoritmo: atribui item ao entregador que:
  // 1. Ainda tem espa√ßo (totalPeds < limite)
  // 2. Cuja rota existente est√° na mesma dire√ß√£o (√¢ngulo similar)
  // 3. Se empate, escolhe o que tem menos pedidos
  itens.forEach(item=>{
    // Conta quantos pedidos individuais esse item representa
    const qtdItem=item.ids.length;
    
    // Encontra melhor entregador para esse item
    let melhor=null,melhorScore=Infinity;
    grupos_ent.forEach(g=>{
      if(g.totalPeds+qtdItem>g.limite)return; // Sem espa√ßo
      let score=0;
      if(g.itens.length===0){
        // Entregador sem pedidos ainda ‚Äî usa √¢ngulo m√©dio livre
        score=50; // score neutro
      } else {
        // Calcula √¢ngulo m√©dio dos itens j√° atribu√≠dos
        const angMedio=g.itens.reduce((s,it)=>s+it.ang,0)/g.itens.length;
        const diff=Math.abs(((item.ang-angMedio+540)%360)-180);
        score=diff; // menor diferen√ßa angular = melhor score
      }
      // Desempate: prefere quem tem mais espa√ßo proporcional
      const espacoProporcional=(g.limite-g.totalPeds)/g.limite;
      score-=espacoProporcional*10;
      if(score<melhorScore){melhorScore=score;melhor=g;}
    });
    
    if(melhor){
      melhor.itens.push(item);
      melhor.totalPeds+=qtdItem;
    } else {
      // Item n√£o cabe em nenhum ‚Äî distribui para quem tem mais espa√ßo dispon√≠vel
      const comEspaco=grupos_ent.filter(g=>g.totalPeds<g.limite)
        .sort((a,b)=>(b.limite-b.totalPeds)-(a.limite-a.totalPeds));
      if(comEspaco.length){comEspaco[0].itens.push(item);comEspaco[0].totalPeds+=qtdItem;}
      else grupos_ent[0].itens.push(item); // for√ßa no primeiro
    }
  });

  // Remove entregadores sem pedidos
  _rotaIAGrupos=grupos_ent
    .filter(g=>g.itens.length>0)
    .map(g=>{
      // Reordena: mais pr√≥ximos da loja primeiro
      g.itens.sort((a,b)=>a.dist-b.dist);
      const bairroTexto=g.itens.map(it=>it.end.split(',')[1]?.trim()||'').filter(Boolean);
      const unicos=[...new Set(bairroTexto)].slice(0,2).join(' / ');
      return{
        entId:g.entId,entNome:g.entNome,
        descricao:unicos?('üìç '+unicos):(''+g.itens.length+' parada'+( g.itens.length>1?'s':'')),
        pedidos:g.itens.flatMap(it=>it.ids.map(id=>{
          const orig=pedsGeo.find(p=>p.id===id);
          return orig?{...orig,end:it.end,labels:it.labels}:null;
        })).filter(Boolean)
      };
    });
  _rotaPlanoGrupos=_rotaIAGrupos;

  // Exibe resultado
  const body=$('rota-plano-body');
  const coresEnt=['#004E89','#FF6B35','#00C9A7','#8e44ad','#e74c3c','#27ae60'];
  const totalPeds=_rotaIAGrupos.reduce((s,g)=>s+g.pedidos.length,0);
  const sobrou=itens.reduce((s,it)=>s+it.ids.length,0)-totalPeds;

  body.innerHTML=`<div style="background:#e8f5e9;border-radius:9px;padding:11px;margin-bottom:12px;font-size:13px;color:#2e7d32;font-weight:700;">
    ü§ñ Rota otimizada: ${_rotaIAGrupos.length} entregador${_rotaIAGrupos.length>1?'es':''} ‚Ä¢ ${totalPeds} pedido${totalPeds>1?'s':''}${sobrou>0?` ‚Ä¢ <span style="color:#e65100;">${sobrou} sem entregador</span>`:''}
  </div>`+_rotaIAGrupos.map((g,gi)=>`
  <div style="background:#f8f9fa;border-radius:10px;padding:12px;margin-bottom:10px;border-left:4px solid ${coresEnt[gi%coresEnt.length]};">
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
      <span style="font-size:16px;">üõµ</span>
      <div>
        <div style="font-weight:700;font-size:14px;color:${coresEnt[gi%coresEnt.length]};">${g.entNome}</div>
        <div style="font-size:11px;color:#888;">${g.descricao}</div>
      </div>
      <span style="margin-left:auto;background:${coresEnt[gi%coresEnt.length]};color:white;padding:2px 10px;border-radius:20px;font-size:12px;font-weight:700;">${g.pedidos.length}x</span>
    </div>
    ${g.pedidos.map((p,pi)=>`<div style="padding:5px 0;border-bottom:1px solid #eee;font-size:12px;display:flex;gap:6px;align-items:start;">
      <span style="background:${coresEnt[gi%coresEnt.length]};color:white;border-radius:50%;width:18px;height:18px;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;flex-shrink:0;">${pi+1}</span>
      <div>
        <strong>${p.num?'#'+p.num:p.nome}</strong>
        <br><span style="color:#555;font-size:11px;">üìç ${p.end}</span>
        ${p.dist>0?`<span style="color:#888;font-size:10px;"> ‚Ä¢ ${p.dist.toFixed(1)}km</span>`:''}
      </div>
    </div>`).join('')}
  </div>`).join('');

  btn.textContent='ü§ñ Gerar Rota com IA';btn.disabled=false;
  $('qtd-msg').textContent='';
  closeM('qtd-ent');
  openM('rota-plano');
}


async function otimizarRotaInteligente(){
  const{data:peds}=await db.from('entregas').select('*').eq('loja_id',U.id).eq('status','pendente').order('created_at');
  if(!peds||!peds.length){alert('Sem pedidos pendentes para otimizar.');return;}
  const{data:assoc}=await db.from('loja_entregadores').select('entregador_id,e:entregador_id(id,nome,online)').eq('loja_id',U.id);
  const onlineEnts=(assoc||[]).filter(a=>a.e&&a.e.online);
  if(!onlineEnts.length){alert('Nenhum entregador online vinculado √† loja.');return;}
  const lojaLat=lojaGeoCache.lat||RP_LAT,lojaLng=lojaGeoCache.lng||RP_LNG;
  const pedsGeo=[];
  for(const p of peds){
    let lat=p.lat_entrega,lng=p.lng_entrega;
    if(!lat||!lng){const g=await geocode(p.endereco_entrega);if(g){lat=g.lat;lng=g.lng;await db.from('entregas').update({lat_entrega:lat,lng_entrega:lng}).eq('id',p.id);}}
    pedsGeo.push({...p,lat:lat||lojaLat,lng:lng||lojaLng,dist:distKm(lojaLat,lojaLng,lat||lojaLat,lng||lojaLng),ang:angleDeg(lojaLat,lojaLng,lat||lojaLat,lng||lojaLng)});
  }
  const setoresMap={};
  pedsGeo.forEach(p=>{const s=Math.floor((p.ang+180)/60);if(!setoresMap[s])setoresMap[s]=[];setoresMap[s].push(p);});
  Object.values(setoresMap).forEach(s=>s.sort((a,b)=>a.dist-b.dist));
  _rotaPlanoGrupos=Object.values(setoresMap);
  _rotaPlanoEnts=onlineEnts;
  const entOptions=onlineEnts.map(a=>`<option value="${a.entregador_id}">${a.e.nome}</option>`).join('');
  const body=$('rota-plano-body');
  body.innerHTML=`<div style="background:#e8f5e9;border-radius:8px;padding:10px;margin-bottom:12px;font-size:13px;font-weight:700;color:#2e7d32;">
    üì¶ ${peds.length} entrega${peds.length>1?'s':''} em ${_rotaPlanoGrupos.length} grupo${_rotaPlanoGrupos.length>1?'s':''} por dire√ß√£o
  </div>`+_rotaPlanoGrupos.map((grupo,gi)=>`
    <div class="secao" style="margin-bottom:10px;">
      <div class="s-title">Grupo ${gi+1} ‚Äî ${grupo.length} entrega${grupo.length>1?'s':''}</div>
      ${grupo.map((p,pi)=>`<div style="padding:5px 0;border-bottom:1px solid #f0f0f0;font-size:12px;">
        <strong>${pi+1}. ${p.numero_pedido?'#'+p.numero_pedido:p.cliente_nome||'Entrega'}</strong><br>
        <span style="color:#555;">üìç ${p.endereco_entrega}</span>
        ${p.distancia_km>0?`<span style="color:#888;font-size:11px;"> ‚Ä¢ ${parseFloat(p.distancia_km).toFixed(1)}km</span>`:''}
      </div>`).join('')}
      <div style="margin-top:8px;">
        <label style="font-size:11px;font-weight:700;color:#333;">üõµ Entregador:</label>
        <select id="rota-ent-${gi}" style="width:100%;padding:8px;border:1.5px solid #e0e0e0;border-radius:7px;margin-top:4px;font-size:13px;">
          <option value="">‚Äî Selecione ‚Äî</option>${entOptions}
        </select>
      </div>
    </div>`).join('');
  closeM('rota');openM('rota-plano');
}

async function confirmarRotaPlano(){
  const btn=$('btn-confirmar-rota');
  btn.textContent='Salvando...';btn.disabled=true;
  let algumAtribuido=false,ordem=1;
  // Verifica se veio da IA (grupos com entId definido)
  if(_rotaIAGrupos.length){
    for(const g of _rotaIAGrupos){
      if(!g.entId)continue;
      algumAtribuido=true;
      for(const p of g.pedidos){
        await db.from('entregas').update({entregador_id:g.entId,status:'aceito',status_detalhado:'aceito',ordem_rota:ordem,pedido_pronto:true,aceito_at:new Date().toISOString()}).eq('id',p.id);
        ordem++;
      }
    }
    _rotaIAGrupos=[];
  } else {
    for(let gi=0;gi<_rotaPlanoGrupos.length;gi++){
      const eid=$(`rota-ent-${gi}`)?.value;
      if(!eid)continue;
      algumAtribuido=true;
      for(const p of _rotaPlanoGrupos[gi]){
        await db.from('entregas').update({entregador_id:eid,status:'aceito',status_detalhado:'aceito',ordem_rota:ordem,pedido_pronto:true,aceito_at:new Date().toISOString()}).eq('id',p.id);
        ordem++;
      }
    }
  }
  btn.textContent='‚úÖ Confirmar e Despachar';btn.disabled=false;
  if(!algumAtribuido){alert('Nenhum grupo com entregador atribu√≠do.');return;}
  closeM('rota-plano');openM('rota');
  carregarPedidos();
  alert(`‚úÖ ${ordem-1} entrega${ordem>2?'s':''} despachada${ordem>2?'s':''}!`);
}

async function abrirPedidosLj(){openM('rota');carregarPedidos();}
async function carregarPedidos(){
  $('rota-lst').innerHTML='<p>Carregando...</p>';
  const{data}=await db.from('entregas').select('*,entregador:entregador_id(nome)').eq('loja_id',U.id).neq('status','entregue').neq('status','cancelado').order('ordem_rota');
  if(!data||!data.length){$('rota-lst').innerHTML='<p style="color:#999;text-align:center;padding:20px">Sem pedidos. Use "Novo Pedido".</p>';return;}
  // Buscar entregadores disponiveis
  const{data:assoc}=await db.from('loja_entregadores').select('entregador_id,e:entregador_id(nome,online)').eq('loja_id',U.id)
  const onlineList=(assoc||[]).filter(a=>a.e&&a.e.online);
  $('rota-lst').innerHTML=data.map((e,i)=>{
    const stDet=e.status_detalhado||e.status;
    const steps=['pendente','aceito','chegou_loja','saiu_entrega','entregue'];
    const curIdx=steps.indexOf(stDet);
    const stepsHtml=steps.slice(0,4).map((st,idx)=>`<div class="sf-step ${idx<curIdx?'done':idx===curIdx?'current':''}">${['Pendente','Aceito','Na Loja','A Caminho'][idx]}</div>`).join('');
    const entOptions=onlineList.map(a=>`<option value="${a.entregador_id}" ${e.entregador_id===a.entregador_id?'selected':''}>${a.e.nome}</option>`).join('');
    return `<div class="ecard ${e.status==='em_rota'||e.status==='aceito'?'rota':''}">
      <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
        <strong>${i+1}. ${e.numero_pedido?'#'+e.numero_pedido:e.cliente_nome||'Entrega'}</strong>
        <span class="badge b-${stDet}">${stDet}</span>
      </div>
      <div class="status-flow">${stepsHtml}</div>
      <p style="font-size:12px;color:#555;margin:3px 0;">&#128205; ${e.endereco_entrega}</p>
      ${e.cliente_nome?`<p style="font-size:11px;color:#888;">&#128100; ${e.cliente_nome}${e.cliente_telefone?' | '+e.cliente_telefone:''}</p>`:''}
      ${e.distancia_km>0?`<p style="font-size:11px;color:#888;">&#128205; ${parseFloat(e.distancia_km).toFixed(1)}km | ${fR(e.valor_corrida||e.valor_entregador)}</p>`:''}
      ${e.codigo_confirmacao?`<p style="font-size:11px;color:#8e44ad;">&#128273; Cod. Conf: ${e.codigo_confirmacao}</p>`:''}
      ${e.status==='pendente'?`<div style="margin-top:6px;"><label style="font-size:11px;font-weight:700;color:#555;">Atribuir a:</label><select class="ent-select" onchange="atribuirEnt('${e.id}',this.value)"><option value="">Selecione entregador...</option>${entOptions}</select></div>`:''}
      ${e.entregador?`<p style="font-size:11px;color:#004E89;margin-top:4px;">&#128757; ${e.entregador.nome}</p>`:''}
      <div class="row" style="margin-top:7px;flex-wrap:wrap;">
        <button class="btn-sm blue" onclick="abrirEditarPedido('${e.id}','${(e.numero_pedido||'').replace(/'/g,"\\'")}','${(e.cliente_nome||'').replace(/'/g,"\\'")}','${e.cliente_telefone||''}','${(e.endereco_rua||'').replace(/'/g,"\\'")}','${e.endereco_numero||''}','${(e.endereco_bairro||'').replace(/'/g,"\\'")}','${(e.endereco_cidade||'').replace(/'/g,"\\'")}','${(e.endereco_complemento||'').replace(/'/g,"\\'")}','${(e.observacoes||'').replace(/'/g,"\\'")}')">‚úèÔ∏è Editar</button>
        <button class="btn-sm green" onclick="ljFinalizarEntrega('${e.id}')">‚úÖ Finalizar</button>
        <button class="btn-sm red" onclick="cancelarEnt('${e.id}')">‚úñ Cancelar</button>
        ${e.status==='pendente'?`<button class="btn-sm orange" onclick="avisarPedidoPronto()">üîî Pronto</button>`:''}
      </div>
    </div>`;
  }).join('');
}

async function atribuirEnt(pedId,entId){
  if(!entId)return;
  await db.from('entregas').update({entregador_id:entId,status:'aceito',status_detalhado:'aceito',aceito_at:new Date().toISOString(),pedido_pronto:true}).eq('id',pedId);
  carregarPedidos();
}

// ============ GPS VALIDATION TOGGLE ============
let gpsValidacaoAtiva=false;

// ============ ADMIN GPS GLOBAL ============
async function admAtuToggleGps(ativo){
  const sw=$('adm-gps-toggle-sw');
  const knob=$('adm-gps-toggle-knob');
  const desc=$('adm-gps-toggle-desc');
  if(!sw)return;
  gpsValidacaoAtiva=ativo;
  if(ativo){sw.style.background='#e65100';knob.style.left='27px';if(desc)desc.textContent='GPS obrigatorio ‚Äî entregadores devem estar no local';}
  else{sw.style.background='#ccc';knob.style.left='3px';if(desc)desc.textContent='Entregadores confirmam sem validacao (modo livre)';}
}
async function admToggleGpsGlobal(){
  const novo=!gpsValidacaoAtiva;
  admAtuToggleGps(novo);
  // Salva em 3 camadas para garantir persist√™ncia total
  // 1) localStorage - persist√™ncia imediata e offline
  localStorage.setItem('adm_gps_global',novo?'1':'0');
  // 2) Admin user row
  try{await db.from('usuarios').update({gps_validacao_obrigatorio:novo}).eq('id',U.id);}catch(e){}
  U.gps_validacao_obrigatorio=novo;
  // 3) Propaga para todas as lojas (em background, n√£o bloqueia)
  db.from('usuarios').update({gps_validacao_obrigatorio:novo}).eq('tipo','loja').then(()=>{}).catch(()=>{});
  // 4) config_global table (se existir)
  db.from('config_global').upsert({chave:'gps_validacao_obrigatorio',valor:novo?'true':'false',updated_at:new Date().toISOString()}).then(()=>{}).catch(()=>{});
}
async function carregarAdmGpsToggle(){
  // Estrat√©gia tripla: localStorage (instant√¢neo) > banco admin > config_global
  // Primeiro aplica localStorage para resposta imediata
  const cached=localStorage.getItem('adm_gps_global');
  if(cached!==null){admAtuToggleGps(cached==='1');}

  // Depois verifica banco (mais confi√°vel)
  let ativo=cached!==null?cached==='1':false;
  try{
    const{data:cfg}=await db.from('config_global').select('valor').eq('chave','gps_validacao_obrigatorio').single();
    if(cfg)ativo=cfg.valor==='true';
  }catch(e){
    try{
      const{data:admData}=await db.from('usuarios').select('gps_validacao_obrigatorio').eq('id',U.id).single();
      if(admData&&admData.gps_validacao_obrigatorio!==null)ativo=admData.gps_validacao_obrigatorio;
    }catch(e2){}
  }
  // Garante que localStorage fica sincronizado com banco
  localStorage.setItem('adm_gps_global',ativo?'1':'0');
  admAtuToggleGps(ativo);
}

// ============ SUPABASE REALTIME GPS ============
function iniciarRealtimeDrivers(tipo){
  // Cancela canal anterior se houver
  if(realtimeCh){try{db.removeChannel(realtimeCh);}catch(e){}realtimeCh=null;}
  // Canal dedicado por tipo para evitar conflito
  realtimeCh=db.channel('gps-live-'+tipo+'-'+Date.now())
    .on('postgres_changes',{event:'UPDATE',schema:'public',table:'usuarios',filter:'tipo=eq.entregador'},
      async ()=>{
        // Qualquer update num entregador: recarrega o mapa imediatamente
        if(tipo==='admin')await pullAdm();
        else if(tipo==='loja')await pullLj();
      })
    .subscribe((status,err)=>{
      console.log('[Realtime]',tipo,status,err||'');
      if(status==='CHANNEL_ERROR'||status==='TIMED_OUT'){
        // Reconecta automaticamente ap√≥s 3s
        setTimeout(()=>iniciarRealtimeDrivers(tipo),3000);
      }
    });
}

// atuToggleGps - dummy para compatibilidade (GPS toggle agora s√≥ no admin)
function atuToggleGps(ativo){gpsValidacaoAtiva=ativo;}
async function toggleGpsValidacao(){
  const novo=!gpsValidacaoAtiva;
  await db.from('usuarios').update({gps_validacao_obrigatorio:novo}).eq('id',U.id);
  U.gps_validacao_obrigatorio=novo;
  localStorage.setItem('u',JSON.stringify(U));
  atuToggleGps(novo);
}

// ============ LOGO LOJA ============
function mostrarLogo(url,containerId){
  const el=$(containerId);if(!el)return;
  if(url){
    el.innerHTML=`<img src="${url}" style="max-height:60px;max-width:180px;object-fit:contain;border-radius:6px;margin:0 auto;display:block;">`;
  }else{el.innerHTML='';}
}
async function uploadLogoLoja(event){
  const file=event.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=async(e)=>{
    const b64=e.target.result;
    // Salva no banco (fonte de verdade)
    await db.from('usuarios').update({logo_url:b64}).eq('id',U.id);
    U.logo_url=b64;
    // Tenta salvar no localStorage (pode falhar se imagem for muito grande)
    try{localStorage.setItem('u',JSON.stringify(U));}catch(ex){}
    // Salva logo em chave dedicada (mais chance de caber)
    try{localStorage.setItem('loja_logo_'+U.id,b64);}catch(ex){}
    mostrarLogo(b64,'loja-logo-box');
    const prev=$('cfg-logo-prev');
    if(prev)prev.innerHTML=`<img src="${b64}" style="max-height:70px;max-width:200px;object-fit:contain;border-radius:6px;display:block;margin:0 auto;">`;
    showM('cfg-lj-msg','‚úÖ Logo salva com sucesso!',true);setTimeout(()=>clearM('cfg-lj-msg'),2000);
  };
  reader.readAsDataURL(file);
}

// ============ EDITAR PEDIDO ============
function abrirEditarPedido(id,num,cli,tel,rua,nend,bairro,cidade,comp,obs){
  $('edit-id').value=id;
  $('edit-num').value=num||'';$('edit-cli').value=cli||'';$('edit-tel').value=tel||'';
  $('edit-rua').value=rua||'';$('edit-nend').value=nend||'';
  $('edit-bairro').value=bairro||'';$('edit-cidade').value=cidade||'Ribeirao Preto';
  $('edit-comp').value=comp||'';$('edit-obs').value=obs||'';
  clearM('edit-msg');openM('editar');
}
async function salvarEdicaoPedido(){
  const id=$('edit-id').value;if(!id){showM('edit-msg','Erro: ID do pedido n√£o encontrado.',false);return;}
  const btn=document.querySelector('#m-editar .btn-primary');
  if(btn){btn.disabled=true;btn.textContent='Salvando...';}
  const rua=v('edit-rua'),nend=v('edit-nend'),bairro=v('edit-bairro'),cidade=v('edit-cidade')||'Ribeirao Preto',comp=v('edit-comp');
  const endereco=fEnd(rua,nend,bairro,cidade,comp);
  // Monta objeto de update sem campos que podem nao existir no banco
  const upd={
    numero_pedido:v('edit-num')||null,
    cliente_nome:v('edit-cli'),
    cliente_telefone:v('edit-tel'),
    endereco_rua:rua,endereco_numero:nend,endereco_bairro:bairro,endereco_cidade:cidade,
    endereco_complemento:comp,endereco_entrega:endereco
  };
  // Tenta adicionar observacoes - se coluna nao existir, tenta notas
  const obsVal=v('edit-obs');
  const{error}=await db.from('entregas').update({...upd,observacoes:obsVal||null}).eq('id',id);
  if(error&&(error.message.includes('observacoes')||error.message.includes('schema cache'))){
    // Coluna observacoes nao existe - tenta salvar sem ela
    const{error:e2}=await db.from('entregas').update(upd).eq('id',id);
    if(btn){btn.disabled=false;btn.textContent='‚úì Salvar Alteracoes';}
    if(e2){showM('edit-msg','‚ùå Erro ao salvar: '+e2.message,false);return;}
  }else if(error){
    if(btn){btn.disabled=false;btn.textContent='‚úì Salvar Alteracoes';}
    console.error('[editar]',error);
    showM('edit-msg','‚ùå Erro ao salvar: '+error.message,false);
    return;
  }
  if(btn){btn.disabled=false;btn.textContent='‚úì Salvar Alteracoes';}
  showM('edit-msg','‚úÖ Pedido atualizado!',true);
  setTimeout(()=>{closeM('editar');carregarPedidos();},1000);
}

async function marcarEnt(id){
  await db.from('entregas').update({status:'entregue',status_detalhado:'entregue',entregue_at:new Date().toISOString()}).eq('id',id);
  carregarPedidos();
  const{data:ent}=await db.from('entregas').select('id').eq('loja_id',U.id).gte('created_at',iDia()).lte('created_at',fDia());
  $('lj-hj').textContent=ent?ent.length:0;
}
async function cancelarEnt(id){if(!confirm('Cancelar esta entrega?'))return;await db.from('entregas').update({status:'cancelado',status_detalhado:'cancelado'}).eq('id',id);carregarPedidos();}

async function abrirRelLj(){openM('rel');carregarRel();}
async function carregarRel(){
  const p=$('rel-f').value,el=$('rel-dados');
  el.innerHTML='<p style="text-align:center;padding:20px;color:#888;">‚è≥ Carregando...</p>';
  // Calcula per√≠odo com in√≠cio e fim corretos usando BR timezone
  function getRelPeriodo(per){
    const agora=new Date();
    let ini,fim=new Date(agora);fim.setHours(23,59,59,999);
    if(per==='hoje'){ini=new Date(agora);ini.setHours(0,0,0,0);}
    else if(per==='semana'){
      ini=new Date(agora);ini.setDate(ini.getDate()-((agora.getDay()+6)%7));ini.setHours(0,0,0,0);
      fim=new Date(ini);fim.setDate(fim.getDate()+6);fim.setHours(23,59,59,999);
    }
    else if(per==='semana_passada'){
      ini=new Date(agora);ini.setDate(ini.getDate()-((agora.getDay()+6)%7)-7);ini.setHours(0,0,0,0);
      fim=new Date(ini);fim.setDate(fim.getDate()+6);fim.setHours(23,59,59,999);
    }
    else if(per==='mes'){ini=new Date(agora.getFullYear(),agora.getMonth(),1,0,0,0,0);fim=new Date(agora.getFullYear(),agora.getMonth()+1,0,23,59,59,999);}
    else if(per==='mes_passado'){ini=new Date(agora.getFullYear(),agora.getMonth()-1,1,0,0,0,0);fim=new Date(agora.getFullYear(),agora.getMonth(),0,23,59,59,999);}
    else{ini=new Date(agora);ini.setHours(0,0,0,0);}
    return{ini:ini.toISOString(),fim:fim.toISOString()};
  }
  const{ini:dtIni,fim:dtFim}=getRelPeriodo(p);
  const{data:ents}=await db.from('entregas').select('*,entregador:entregador_id(nome)').eq('loja_id',U.id).gte('created_at',dtIni).lte('created_at',dtFim);
  if(!ents||!ents.length){el.innerHTML='<p style="color:#999;text-align:center;padding:20px">Sem entregas no per√≠odo.</p>';return;}

  const tS=ents.reduce((s,e)=>s+parseFloat(e.valor_sistema||0),0);
  const tE=ents.reduce((s,e)=>s+parseFloat(e.valor_corrida||e.valor_entregador||0),0);
  const entregues=ents.filter(e=>e.status==='entregue');
  const taxaConc=ents.length>0?Math.round(entregues.length/ents.length*100):0;

  // Dados por entregador
  const pE={};
  ents.forEach(e=>{
    const k=e.entregador_id||'sem';
    const nome=e.entregador?.nome||'Sem entregador';
    if(!pE[k])pE[k]={nome,lista:[],total:0,entregues:0,kmTotal:0};
    const v=parseFloat(e.valor_corrida||e.valor_entregador||0);
    pE[k].lista.push(e);
    pE[k].total+=v;
    if(e.status==='entregue')pE[k].entregues++;
    pE[k].kmTotal+=parseFloat(e.distancia_km||0);
  });
  const entArr=Object.values(pE).sort((a,b)=>b.lista.length-a.lista.length);
  const melhor=entArr[0];
  const pior=entArr[entArr.length-1];
  const cores=['#FF6B35','#004E89','#00C9A7','#8e44ad','#e74c3c','#f39c12','#27ae60'];

  // Dados por bairro/regi√£o
  const pB={};
  ents.forEach(e=>{
    const b=(e.endereco_bairro||'Sem bairro').trim();
    if(!pB[b])pB[b]=0;
    pB[b]++;
  });
  const bairrosArr=Object.entries(pB).sort((a,b)=>b[1]-a[1]);
  const topBairros=bairrosArr.slice(0,6);

  // Entregas por dia
  const pDia={};
  ents.forEach(e=>{const d=e.created_at?.split('T')[0]||'?';if(!pDia[d])pDia[d]=0;pDia[d]++;});
  const dias=Object.keys(pDia).sort();

  el.innerHTML=`
  <!-- RESUMO CARDS -->
  <div class="g2b" style="gap:8px;margin-bottom:10px;">
    <div style="background:#fff3e0;border-radius:10px;padding:11px;text-align:center;">
      <div style="font-size:10px;color:#888;">Total Entregas</div>
      <div style="font-size:24px;font-weight:700;color:#FF6B35;">${ents.length}</div>
    </div>
    <div style="background:#e8f5e9;border-radius:10px;padding:11px;text-align:center;">
      <div style="font-size:10px;color:#888;">Conclu√≠das</div>
      <div style="font-size:24px;font-weight:700;color:#2e7d32;">${taxaConc}%</div>
    </div>
    <div style="background:#e3f2fd;border-radius:10px;padding:11px;text-align:center;">
      <div style="font-size:10px;color:#888;">Taxa Sistema</div>
      <div style="font-size:16px;font-weight:700;color:#004E89;">${fR(tS)}</div>
    </div>
    <div style="background:#f3e5f5;border-radius:10px;padding:11px;text-align:center;">
      <div style="font-size:10px;color:#888;">Custo Entregad.</div>
      <div style="font-size:16px;font-weight:700;color:#8e44ad;">${fR(tE)}</div>
    </div>
  </div>

  <!-- MELHOR / PIOR -->
  ${entArr.length>1?`<div class="g2b" style="gap:8px;margin-bottom:10px;">
    <div style="background:#e8f5e9;border-radius:10px;padding:11px;border-left:4px solid #27ae60;">
      <div style="font-size:10px;color:#27ae60;font-weight:700;">üèÜ MAIS ENTREGAS</div>
      <div style="font-weight:700;font-size:14px;margin-top:4px;">${melhor.nome}</div>
      <div style="font-size:12px;color:#555;">${melhor.lista.length} corridas ‚Ä¢ ${fR(melhor.total)}</div>
    </div>
    <div style="background:#fce4ec;border-radius:10px;padding:11px;border-left:4px solid #e74c3c;">
      <div style="font-size:10px;color:#e74c3c;font-weight:700;">üìâ MENOS ENTREGAS</div>
      <div style="font-weight:700;font-size:14px;margin-top:4px;">${pior.nome}</div>
      <div style="font-size:12px;color:#555;">${pior.lista.length} corridas ‚Ä¢ ${fR(pior.total)}</div>
    </div>
  </div>`:''}

  <!-- GR√ÅFICO BARRAS POR ENTREGADOR -->
  ${entArr.length>0?`<div style="background:white;border-radius:12px;padding:12px;margin-bottom:10px;box-shadow:0 1px 6px rgba(0,0,0,.06);">
    <div style="font-size:12px;font-weight:700;color:#333;margin-bottom:8px;">üõµ Corridas por Entregador</div>
    <canvas id="lj-chart-bar" height="160"></canvas>
  </div>`:''}

  <!-- GR√ÅFICO BAIRROS -->
  ${topBairros.length>0?`<div style="background:white;border-radius:12px;padding:12px;margin-bottom:10px;box-shadow:0 1px 6px rgba(0,0,0,.06);">
    <div style="font-size:12px;font-weight:700;color:#333;margin-bottom:8px;">üìç Regi√µes com mais entregas (Top ${topBairros.length})</div>
    <canvas id="lj-chart-bairros" height="160"></canvas>
    <div style="margin-top:8px;">
      ${bairrosArr.map((b,i)=>`<div style="display:flex;align-items:center;justify-content:space-between;padding:4px 0;font-size:12px;border-bottom:1px solid #f5f5f5;">
        <span>${i===0?'üî¥':i===1?'üü†':i===2?'üü°':'‚ö™'} ${b[0]}</span>
        <strong>${b[1]} entrega${b[1]>1?'s':''}</strong>
      </div>`).join('')}
    </div>
  </div>`:''}

  <!-- GR√ÅFICO LINHA DIAS -->
  ${dias.length>1?`<div style="background:white;border-radius:12px;padding:12px;margin-bottom:10px;box-shadow:0 1px 6px rgba(0,0,0,.06);">
    <div style="font-size:12px;font-weight:700;color:#333;margin-bottom:8px;">üìà Entregas por Dia</div>
    <canvas id="lj-chart-dias" height="140"></canvas>
  </div>`:''}

  <!-- CUSTO POR ENTREGADOR -->
  <div style="background:white;border-radius:12px;padding:12px;margin-bottom:10px;box-shadow:0 1px 6px rgba(0,0,0,.06);">
    <div style="font-size:12px;font-weight:700;color:#333;margin-bottom:8px;">üí∞ Custo Detalhado por Entregador</div>
    ${entArr.map((ent,i)=>`
    <div style="padding:8px 0;border-bottom:1px solid #f5f5f5;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div style="display:flex;align-items:center;gap:7px;">
          <div style="width:10px;height:10px;border-radius:50%;background:${cores[i%cores.length]};"></div>
          <strong style="font-size:13px;">${ent.nome}</strong>
        </div>
        <span style="font-weight:700;color:#004E89;font-size:13px;">${fR(ent.total)}</span>
      </div>
      <div style="display:flex;gap:12px;margin-top:4px;font-size:11px;color:#666;">
        <span>üöÄ ${ent.lista.length} corridas</span>
        <span>‚úÖ ${ent.entregues} entregues</span>
        <span>üìè ${ent.kmTotal.toFixed(1)}km total</span>
        <span>üìä M√©dia: ${fR(ent.lista.length>0?ent.total/ent.lista.length:0)}/corrida</span>
      </div>
      <!-- Barra de taxa de conclus√£o -->
      <div style="margin-top:5px;">
        <div style="font-size:10px;color:#888;margin-bottom:2px;">Taxa de conclus√£o: ${ent.lista.length>0?Math.round(ent.entregues/ent.lista.length*100):0}%</div>
        <div style="background:#f0f0f0;border-radius:20px;height:6px;overflow:hidden;">
          <div style="background:${ent.lista.length>0&&ent.entregues/ent.lista.length>=0.8?'#27ae60':'#e74c3c'};height:100%;width:${ent.lista.length>0?Math.round(ent.entregues/ent.lista.length*100):0}%;border-radius:20px;transition:width .5s;"></div>
        </div>
      </div>
    </div>`).join('')}
  </div>

  <!-- GR√ÅFICO TAXA DE CONCLUS√ÉO -->
  ${entArr.length>0?`<div style="background:white;border-radius:12px;padding:12px;margin-bottom:10px;box-shadow:0 1px 6px rgba(0,0,0,.06);">
    <div style="font-size:12px;font-weight:700;color:#333;margin-bottom:8px;">‚úÖ Taxa de Conclus√£o por Entregador (%)</div>
    <canvas id="lj-chart-taxa" height="140"></canvas>
  </div>`:''}

  <!-- GR√ÅFICO CUSTO POR KM -->
  ${entArr.filter(e=>e.kmTotal>0).length>0?`<div style="background:white;border-radius:12px;padding:12px;margin-bottom:10px;box-shadow:0 1px 6px rgba(0,0,0,.06);">
    <div style="font-size:12px;font-weight:700;color:#333;margin-bottom:8px;">üìè Custo por Km (R$/km)</div>
    <canvas id="lj-chart-km" height="140"></canvas>
    <p style="font-size:10px;color:#888;margin-top:6px;">Menor custo/km = entregador mais eficiente por dist√¢ncia percorrida</p>
  </div>`:''}
  </div>`;

  // Gr√°ficos ap√≥s render
  setTimeout(()=>{
    // Barras por entregador
    const c1=document.getElementById('lj-chart-bar');
    if(c1){
      if(c1._ch)c1._ch.destroy();
      c1._ch=new Chart(c1,{type:'bar',data:{
        labels:entArr.map(e=>e.nome.split(' ')[0]),
        datasets:[
          {label:'Corridas',data:entArr.map(e=>e.lista.length),backgroundColor:entArr.map((_,i)=>cores[i%cores.length]),borderRadius:6},
          {label:'Custo (R$)',data:entArr.map(e=>e.total),backgroundColor:'rgba(0,78,137,.2)',borderColor:'#004E89',type:'line',yAxisID:'y2'}
        ]
      },options:{responsive:true,plugins:{legend:{labels:{font:{size:10}}}},scales:{
        y:{ticks:{font:{size:10}}},
        y2:{position:'right',grid:{drawOnChartArea:false},ticks:{font:{size:10},callback:v=>'R$'+v.toFixed(0)}}
      }}});
    }
    // Bairros
    const c2=document.getElementById('lj-chart-bairros');
    if(c2){
      if(c2._ch)c2._ch.destroy();
      c2._ch=new Chart(c2,{type:'bar',data:{
        labels:topBairros.map(b=>b[0].length>15?b[0].substring(0,15)+'‚Ä¶':b[0]),
        datasets:[{label:'Entregas',data:topBairros.map(b=>b[1]),backgroundColor:topBairros.map((_,i)=>cores[i%cores.length]),borderRadius:5}]
      },options:{indexAxis:'y',responsive:true,plugins:{legend:{display:false}},scales:{x:{ticks:{font:{size:10}}},y:{ticks:{font:{size:10}}}}}});
    }
    // Taxa de conclus√£o por entregador
    const c4=document.getElementById('lj-chart-taxa');
    if(c4){
      if(c4._ch)c4._ch.destroy();
      c4._ch=new Chart(c4,{type:'bar',data:{
        labels:entArr.map(e=>e.nome.split(' ')[0]),
        datasets:[{
          label:'Taxa de conclus√£o (%)',
          data:entArr.map(e=>e.lista.length>0?Math.round(e.entregues/e.lista.length*100):0),
          backgroundColor:entArr.map(e=>{const t=e.lista.length>0?e.entregues/e.lista.length:0;return t>=0.8?'#27ae60':t>=0.5?'#f39c12':'#e74c3c';}),
          borderRadius:6
        }]
      },options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{min:0,max:100,ticks:{font:{size:10},callback:v=>v+'%'}},x:{ticks:{font:{size:10}}}}}});
    }
    // Custo por km
    const c5=document.getElementById('lj-chart-km');
    if(c5){
      const comKm=entArr.filter(e=>e.kmTotal>0);
      if(comKm.length>0){
        if(c5._ch)c5._ch.destroy();
        c5._ch=new Chart(c5,{type:'bar',data:{
          labels:comKm.map(e=>e.nome.split(' ')[0]),
          datasets:[{
            label:'R$/km',
            data:comKm.map(e=>parseFloat((e.total/e.kmTotal).toFixed(2))),
            backgroundColor:comKm.map((_,i)=>cores[i%cores.length]),
            borderRadius:6
          }]
        },options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{ticks:{font:{size:10},callback:v=>'R$'+v.toFixed(2)}},x:{ticks:{font:{size:10}}}}}});
      }
    }
    if(c3&&dias.length>1){
      if(c3._ch)c3._ch.destroy();
      c3._ch=new Chart(c3,{type:'line',data:{
        labels:dias.map(d=>{const[,m,dd]=d.split('-');return`${dd}/${m}`;}),
        datasets:[{label:'Entregas/dia',data:dias.map(d=>pDia[d]),borderColor:'#FF6B35',backgroundColor:'rgba(255,107,53,.1)',tension:.3,fill:true}]
      },options:{responsive:true,plugins:{legend:{labels:{font:{size:10}}}},scales:{y:{beginAtZero:true,ticks:{font:{size:10},stepSize:1}}}}});
    }
  },150);
}

async function abrirGerEnt(){openM('ger');$('ger-cod').textContent=U.codigo_loja||'------';carregarGer();}
async function carregarGer(){
  $('ger-lst').innerHTML='<p>Carregando...</p>';
  const{data:assoc}=await db.from('loja_entregadores').select('*,e:entregador_id(id,nome,telefone,placa_moto,online)').eq('loja_id',U.id);
  if(!assoc||!assoc.length){$('ger-lst').innerHTML='<p style="color:#999;margin-top:9px">Nenhum entregador vinculado ainda.</p>';return;}
  $('ger-lst').innerHTML=assoc.map(a=>`
    <div class="litem">
      <div style="flex:1"><strong>${a.e?a.e.nome:'Removido'}</strong> <span class="badge ${a.e&&a.e.online?'b-online':'b-offline'}">${a.e&&a.e.online?'Online':'Offline'}</span><br>
      <small style="color:#888">Tel:${a.e?a.e.telefone||'-':'-'} | Placa:${a.e?a.e.placa_moto||'-':'-'}</small></div>
      <button class="btn-sm red" onclick="remEnt('${a.id}')">Remover</button>
    </div>`).join('');
}
async function remEnt(id){if(!confirm('Remover?'))return;await db.from('loja_entregadores').delete().eq('id',id);carregarGer();}

async function abrirCfgLj(){
  openM('cfg-lj');
  const{data}=await db.from('usuarios').select('*').eq('id',U.id).single();
  if(data){
    $('cfg-nlj').value=data.nome_loja||'';$('cfg-tel').value=data.telefone||'';$('cfg-cnpj').value=data.cnpj||'';
    $('cfg-rua').value=data.endereco_rua||'';$('cfg-nend').value=data.endereco_numero||'';
    $('cfg-bairro').value=data.endereco_bairro||'';$('cfg-cidade').value=data.endereco_cidade||data.cidade||'Ribeirao Preto';
    $('cfg-comp').value=data.endereco_complemento||'';
    if(data.horario_abertura)$('cfg-ab').value=String(data.horario_abertura).substring(0,5);
    if(data.horario_fechamento)$('cfg-fch').value=String(data.horario_fechamento).substring(0,5);
    const prev=$('cfg-logo-prev');
    if(prev&&data.logo_url)prev.innerHTML=`<img src="${data.logo_url}" style="max-height:70px;max-width:200px;object-fit:contain;border-radius:6px;display:block;margin:0 auto;">`;
    else if(prev)prev.innerHTML='<p style="font-size:11px;color:#999;text-align:center;">Sem logo cadastrado</p>';
  }
  // Google Vision j√° est√° configurado no c√≥digo (GOOGLE_KEY)
  const gk=localStorage.getItem('google_vision_key')||'';
  if($('cfg-google-key'))$('cfg-google-key').value=gk?'‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'+gk.slice(-8):'';
  if($('cfg-google-key-status'))$('cfg-google-key-status').textContent=gk?'‚úÖ Chave configurada':'‚ö†Ô∏è Usando chave padr√£o do sistema';
  clearM('cfg-lj-msg');$('cfg-senha').value='';
}
function salvarGoogleKey(){
  const k=v('cfg-google-key');
  if(!k||k.startsWith('‚Ä¢')){showM('cfg-lj-msg','Digite a chave completa primeiro.',false);return;}
  if(!k.startsWith('AIza')){showM('cfg-lj-msg','Chave inv√°lida. Deve come√ßar com AIza...',false);return;}
  localStorage.setItem('google_vision_key',k);
  if($('cfg-google-key'))$('cfg-google-key').value='‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'+k.slice(-8);
  if($('cfg-google-key-status'))$('cfg-google-key-status').textContent='‚úÖ Chave salva com sucesso!';
  showM('cfg-lj-msg','‚úÖ Chave Google Vision salva! OCR pronto para usar.',true);
}
async function salvarCfgLj(){
  const rua=v('cfg-rua'),num=v('cfg-nend'),bairro=v('cfg-bairro'),cidade=v('cfg-cidade')||'Ribeirao Preto',comp=v('cfg-comp');
  const d={nome_loja:v('cfg-nlj'),telefone:v('cfg-tel'),cnpj:v('cfg-cnpj'),cidade,
    endereco:fEnd(rua,num,bairro,cidade,comp),
    endereco_rua:rua,endereco_numero:num,endereco_bairro:bairro,endereco_cidade:cidade,endereco_complemento:comp,
    horario_abertura:v('cfg-ab')||null,horario_fechamento:v('cfg-fch')||null};
  const ns=v('cfg-senha');if(ns.length>=6)d.senha_hash=ns;
  const{error}=await db.from('usuarios').update(d).eq('id',U.id);
  if(error){showM('cfg-lj-msg','Erro: '+error.message);return;}
  U={...U,...d};localStorage.setItem('u',JSON.stringify(U));
  $('loja-nome').textContent=d.nome_loja||U.nome;showM('cfg-lj-msg','Salvo!',true);setTimeout(()=>closeM('cfg-lj'),1500);
}

// ============ ENTREGADOR ============
async function initEnt(){
  // IMPORTANTE: N√ÉO busca loja_ativa_id do banco ‚Äî usa SEMPRE o localStorage
  // Isso evita que um null no banco apague o v√≠nculo salvo localmente
  try{
    const{data}=await db.from('usuarios').select(
      'nome,foto_url,online,taxa_tipo,taxa_entrega,taxa_km_limite,taxa_km_excedente,taxa_fixo_base,observacoes'
    ).eq('id',U.id).single();
    if(data){
      // Merge SOMENTE campos seguros ‚Äî NUNCA sobrescreve dados de loja
      const camposSeguros=['nome','foto_url','online','taxa_tipo','taxa_entrega','taxa_km_limite','taxa_km_excedente','taxa_fixo_base','observacoes'];
      camposSeguros.forEach(k=>{if(data[k]!==undefined&&data[k]!==null)U[k]=data[k];});
      localStorage.setItem('u',JSON.stringify(U));
    }
  }catch(e){console.warn('[initEnt fetch]',e);}
  // RESTAURA v√≠nculo de loja da chave dedicada (SEMPRE sobrescreve ‚Äî mais confi√°vel)
  // Esta chave nunca √© apagada pelo banco e persiste entre logins
  const _lojaKey='loja_vinc_'+U.id;
  const _lojaSalva=localStorage.getItem(_lojaKey);
  if(_lojaSalva){
    try{
      const _lj=JSON.parse(_lojaSalva);
      // Usa chave dedicada sempre ‚Äî ela √© atualizada em conectarCodigo, carregarLojaAtiva e sair
      if(_lj.loja_ativa_id)U.loja_ativa_id=_lj.loja_ativa_id;
      if(_lj._loja_ativa_nome)U._loja_ativa_nome=_lj._loja_ativa_nome;
      if(_lj._loja_ativa_codigo)U._loja_ativa_codigo=_lj._loja_ativa_codigo;
      localStorage.setItem('u',JSON.stringify(U));
    }catch(e){}
  }
  $('ent-nome').textContent=U.nome;
  $('ent-st').textContent=U.online?'&#128994; Online':'&#9899; Offline';
  atuBtnOn(U.online);
  if(U.foto_url){$('foto-img').src=U.foto_url;$('foto-img').classList.remove('hidden');$('foto-ph').classList.add('hidden');}
  // Inicia GPS silencioso assim que entregador abre o app
  iniciarGPS();
  // Entregas hoje
  const{data:e}=await db.from('entregas').select('id,valor_corrida,valor_entregador').eq('entregador_id',U.id).gte('created_at',iDia()).lte('created_at',fDia());
  $('ent-cnt').textContent=e?e.length:0;
  const g=e?e.reduce((s,x)=>s+parseFloat(x.valor_corrida||x.valor_entregador||0),0):0;
  $('ent-gnh').textContent=fR(g);
  // Lojas vinculadas
  await carregarLojaAtiva();
  if(U.online)inicRast();
  // Polling alertas
  ivs.alerta=setInterval(verificarAlertas,8000);
  verificarAlertas();
  // Notif rota
  verificarRotaAtiva();
}

async function carregarLojaAtiva(){
  const infoBox=$('ent-loja-ativa-info');
  const selBox=$('ent-selecionar-loja-box');

  // PASSO 1: Mostra imediatamente o que est√° no localStorage (resposta instant√¢nea)
  function renderCard(nome,codigo,ativa,lojaId){
    const cor=ativa?'#e8f5e9':'#f0f4ff';
    const borda=ativa?'#00C9A7':'#004E89';
    const corText=ativa?'#1b5e20':'#004E89';
    const status=ativa?'‚úÖ Online ‚Äî trabalhando agora':'‚è∏Ô∏è Conectado ‚Äî clique em Ficar Online';
    const corStatus=ativa?'#2e7d32':'#e65100';
    const btnDesv=lojaId&&!ativa?`<button onclick="desvinculardaLoja('${lojaId}')" style="margin-top:7px;width:100%;background:#ffebee;color:#c62828;border:1px solid #ef9a9a;border-radius:7px;padding:6px;font-size:11px;font-weight:700;cursor:pointer;">üîì Desvincular desta loja</button>`:'';
    return `<div style="background:${cor};border-radius:10px;padding:11px;border:2px solid ${borda};">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
        <span style="font-size:20px;">üè™</span>
        <strong style="font-size:16px;color:${corText};">${nome}</strong>
      </div>
      ${codigo?`<p style="font-size:11px;color:#666;margin:2px 0;">üîë C√≥digo: <strong>${codigo}</strong></p>`:''}
      <p style="font-size:12px;margin:4px 0;color:${corStatus};font-weight:700;">${status}</p>
      ${btnDesv}
    </div>`;
  }

  if(U._loja_ativa_nome){
    infoBox.innerHTML=renderCard(U._loja_ativa_nome,U._loja_ativa_codigo,U.online,U.loja_ativa_id);
    selBox.classList.add('hidden');
  }

  // PASSO 2: Busca associa√ß√µes reais no banco para validar e atualizar
  const{data:assoc}=await db.from('loja_entregadores')
    .select('loja_id,l:loja_id(id,nome_loja,nome,logo_url,codigo_loja)')
    .eq('entregador_id',U.id);

  if(!assoc||!assoc.length){
    if(!U._loja_ativa_nome){
      infoBox.innerHTML='<p style="font-size:12px;color:#999;margin:4px 0;">Sem loja vinculada. Digite o c√≥digo abaixo.</p>';
    }
    selBox.classList.add('hidden');
    return;
  }

  // Encontra a loja ativa: por ID > por nome > √∫nica loja
  let lojaAtiva=null;
  if(U.loja_ativa_id){lojaAtiva=assoc.find(a=>a.loja_id===U.loja_ativa_id);}
  if(!lojaAtiva&&U._loja_ativa_nome){
    lojaAtiva=assoc.find(a=>a.l&&(a.l.nome_loja||a.l.nome)===U._loja_ativa_nome);
  }
  if(!lojaAtiva&&assoc.length===1){lojaAtiva=assoc[0];}

  if(lojaAtiva&&lojaAtiva.l){
    const lj=lojaAtiva.l;
    const nomeLoja=lj.nome_loja||lj.nome;
    // Atualiza UI com dados reais do banco
    infoBox.innerHTML=renderCard(nomeLoja,lj.codigo_loja,U.online,lojaAtiva.loja_id);
    // Logo da loja
    const hdr=$('ent-loja-logo');
    if(hdr)hdr.innerHTML=lj.logo_url?`<img src="${lj.logo_url}" style="max-height:45px;max-width:150px;object-fit:contain;display:block;margin:0 auto 4px;">`:'' ;
    // Salva no localStorage
    U.loja_ativa_id=lojaAtiva.loja_id;
    U._loja_ativa_nome=nomeLoja;
    U._loja_ativa_codigo=lj.codigo_loja||'';
    localStorage.setItem('u',JSON.stringify(U));
    // Salva tamb√©m na chave dedicada (sobrevive a logout e recarregamentos)
    localStorage.setItem('loja_vinc_'+U.id,JSON.stringify({
      loja_ativa_id:U.loja_ativa_id,
      _loja_ativa_nome:U._loja_ativa_nome,
      _loja_ativa_codigo:U._loja_ativa_codigo
    }));
    selBox.classList.add('hidden');
    // Bot√£o trocar se tem m√∫ltiplas
    if(assoc.length>1){
      infoBox.innerHTML+=`<p style="font-size:11px;color:#888;margin-top:6px;">
        Voc√™ tem ${assoc.length} lojas. 
        <button onclick="trocarLoja()" style="background:none;border:none;color:#004E89;font-weight:700;cursor:pointer;font-size:11px;padding:0;text-decoration:underline;">Trocar loja</button>
      </p>`;
    }
    // Tenta salvar no banco (n√£o bloqueia se coluna n√£o existir)
    db.from('usuarios').update({loja_ativa_id:lojaAtiva.loja_id}).eq('id',U.id).then(()=>{}).catch(()=>{});
    return;
  }

  // M√∫ltiplas lojas sem ativa definida ‚Äî mostra seletor
  infoBox.innerHTML=`<p style="font-size:12px;color:#e65100;margin-bottom:6px;">‚ö†Ô∏è Selecione com qual loja vai trabalhar hoje:</p>`;
  const sel=$('ent-sel-loja-ativa');sel.innerHTML='';
  assoc.forEach(a=>sel.innerHTML+=`<option value="${a.loja_id}">${a.l?a.l.nome_loja||a.l.nome:'Loja'}</option>`);
  selBox.classList.remove('hidden');
}

function trocarLoja(){
  U.loja_ativa_id=null;localStorage.setItem('u',JSON.stringify(U));
  carregarLojaAtiva();
}

async function confirmarLojaAtiva(){
  const lid=v('ent-sel-loja-ativa');if(!lid)return;
  await db.from('usuarios').update({loja_ativa_id:lid,online:true}).eq('id',U.id);
  U.loja_ativa_id=lid;U.online=true;localStorage.setItem('u',JSON.stringify(U));
  atuBtnOn(true);inicRast();await carregarLojaAtiva();
}

async function verificarAlertas(){
  if(!U)return;
  // Verificar pedido pronto para este entregador
  const{data:peds}=await db.from('entregas').select('id').eq('entregador_id',U.id).eq('pedido_pronto',true).in('status',['aceito','em_rota']).limit(1);
  const alerta=$('ent-pedido-alerta');
  if(peds&&peds.length){
    if(alerta.classList.contains('hidden')){
      alerta.classList.remove('hidden');beepAlerta();
      $('rota-notif').classList.remove('hidden');
    }
  }else{
    alerta.classList.add('hidden');$('rota-notif').classList.add('hidden');
  }
}

async function verificarRotaAtiva(){
  const{data:rota}=await db.from('entregas').select('id').eq('entregador_id',U.id).in('status',['aceito','em_rota','chegou_loja','saiu_entrega']).limit(1);
  if(rota&&rota.length)$('rota-notif').classList.remove('hidden');
  else $('rota-notif').classList.add('hidden');
}

function atuBtnOn(on){
  const c=$('btn-on-card');
  if(on){c.style.background='linear-gradient(135deg,#00C9A7,#007a65)';$('ico-on').innerHTML='&#128308;';$('txt-on').textContent='Ficar Offline';$('txt-on').style.color='white';$('ent-st').innerHTML='&#128994; Online';}
  else{c.style.background='';$('ico-on').innerHTML='&#128994;';$('txt-on').textContent='Ficar Online';$('txt-on').style.color='';$('ent-st').innerHTML='&#9899; Offline';}
}

async function toggleOnline(){
  const{data:assoc}=await db.from('loja_entregadores').select('loja_id,l:loja_id(nome_loja,nome)').eq('entregador_id',U.id);
  // Se tentar ficar ONLINE sem loja
  if(!U.online){
    if(!assoc||!assoc.length){
      alert('‚ö†Ô∏è Nenhuma loja conectada.\n\nDigite o c√≥digo da loja no campo acima e clique em Conectar primeiro.');
      return;
    }
    // Se tem m√∫ltiplas lojas e n√£o tem loja ativa selecionada, mostrar seletor
    if(assoc.length>1&&!U.loja_ativa_id&&!U._loja_ativa_nome){
      $('ent-selecionar-loja-box').classList.remove('hidden');
      return;
    }
    // Se tem apenas uma loja, define ela automaticamente
    if(assoc.length===1&&!U.loja_ativa_id){
      U.loja_ativa_id=assoc[0].loja_id;
      if(assoc[0].l){U._loja_ativa_nome=assoc[0].l.nome_loja||assoc[0].l.nome;}
      localStorage.setItem('u',JSON.stringify(U));
    }
  }
  const novo=!U.online;
  // Ao ficar offline, NAO zera a loja ativa ‚Äî ela deve persistir o turno todo
  await db.from('usuarios').update({online:novo}).eq('id',U.id);
  U.online=novo;
  // Nao zera loja_ativa_id ao ficar offline
  localStorage.setItem('u',JSON.stringify(U));
  atuBtnOn(novo);
  if(novo){
    inicRast();
    const av=$('gps-bg-aviso');
    if(av)av.classList.remove('hidden');
    await carregarLojaAtiva();
  }else{
    if(ivs.rast){navigator.geolocation&&navigator.geolocation.clearWatch(ivs.rast);ivs.rast=null;}
    if(ivs.rastPush){clearInterval(ivs.rastPush);ivs.rastPush=null;}
    swPostMessage({type:'STOP_GPS'});
    carregarLojaAtiva();
  }
}

function inicRast(){
  if(ivs.rast!=null){try{navigator.geolocation&&navigator.geolocation.clearWatch(ivs.rast);}catch(e){}ivs.rast=null;}
  if(ivs.rastPush){clearInterval(ivs.rastPush);ivs.rastPush=null;}
  if(!navigator.geolocation)return;

  // Ativa Wake Lock: impede tela de apagar enquanto online (mant√©m GPS ativo)
  ativarWakeLock();

  const salvarPos=async (lat,lng)=>{
    myLat=lat;myLng=lng;gpsOk=true;
    showGpsBanner(false);
    const dbg=$('gps-debug');
    if(dbg)dbg.innerHTML=`<span style="color:#27ae60;font-size:10px;">üì° GPS ativo: ${lat.toFixed(5)}, ${lng.toFixed(5)}</span>`;
    if(U&&U.online){
      db.from('usuarios').update({latitude:lat,longitude:lng}).eq('id',U.id)
        .then(({error})=>{if(error)console.error('[GPS]',error);});
    }
  };

  // Inicia SW com timer de backup (a cada 15s mesmo app fechado)
  if(U&&U.id)swPostMessage({type:'START_GPS',userId:U.id,sbUrl:SB_URL,sbKey:SB_KEY,intervalMs:15000});

  // watchPosition: atualiza a cada movimento detectado pelo dispositivo
  try{
    ivs.rast=navigator.geolocation.watchPosition(
      p=>salvarPos(p.coords.latitude,p.coords.longitude),
      err=>{if(err.code===1)showGpsBanner(true);},
      {enableHighAccuracy:true,timeout:30000,maximumAge:0}
    );
  }catch(e){ivs.rast=null;}

  // Intervalo de 5s como garantia (funciona mesmo sem movimento)
  ivs.rastPush=setInterval(()=>{
    if(!U||!U.online)return;
    navigator.geolocation.getCurrentPosition(
      p=>salvarPos(p.coords.latitude,p.coords.longitude),
      ()=>{if(myLat&&myLng&&U&&U.online)db.from('usuarios').update({latitude:myLat,longitude:myLng}).eq('id',U.id);},
      {enableHighAccuracy:true,timeout:8000,maximumAge:10000}
    );
  },5000);

  // Posi√ß√£o imediata ao entrar online
  navigator.geolocation.getCurrentPosition(
    p=>salvarPos(p.coords.latitude,p.coords.longitude),
    err=>{if(err.code===1)showGpsBanner(true);},
    {enableHighAccuracy:true,timeout:10000,maximumAge:0}
  );
}

function abrirFoto(){$('input-foto').click();}
async function uploadFoto(event){
  const file=event.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=async function(e){
    const b=e.target.result;
    await db.from('usuarios').update({foto_url:b}).eq('id',U.id);
    U.foto_url=b;localStorage.setItem('u',JSON.stringify(U));
    $('foto-img').src=b;$('foto-img').classList.remove('hidden');$('foto-ph').classList.add('hidden');
  };
  reader.readAsDataURL(file);
}

async function desvinculardaLoja(lojaId,lojaIdConfirm){
  if(!confirm('Tem certeza que deseja se DESVINCULAR desta loja?\nVoc√™ n√£o receber√° mais pedidos dela.'))return;
  await db.from('loja_entregadores').delete().eq('entregador_id',U.id).eq('loja_id',lojaId);
  await db.from('usuarios').update({online:false}).eq('id',U.id);
  U.online=false;U.loja_ativa_id=null;U._loja_ativa_nome=null;U._loja_ativa_codigo=null;
  localStorage.setItem('u',JSON.stringify(U));
  localStorage.removeItem('loja_vinc_'+U.id);
  atuBtnOn(false);
  carregarLojaAtiva();
  $('msg-cod').className='msg-ok';
  $('msg-cod').textContent='Desvinculado com sucesso.';
}

async function conectarCodigo(){
  const cod=v('cod-loja-inp').toUpperCase();const msg=$('msg-cod');
  if(cod.length<4){msg.className='msg-error';msg.textContent='Digite o codigo da loja';return;}
  msg.className='';msg.textContent='Validando...';
  const{data:loja,error:ljErr}=await db.from('usuarios').select('id,nome_loja,nome,codigo_loja').eq('codigo_loja',cod).eq('tipo','loja').single();
  if(!loja){msg.className='msg-error';msg.textContent='‚ùå C√≥digo n√£o encontrado. Verifique e tente novamente.';return;}
  const nomeLoja=loja.nome_loja||loja.nome;
  // REGRA: entregador pode estar vinculado a m√∫ltiplas lojas, mas s√≥ trabalhar em UMA por vez
  // Verifica se j√° est√° online em outra loja
  if(U.online&&U.loja_ativa_id&&U.loja_ativa_id!==loja.id){
    msg.className='msg-error';
    msg.textContent='‚ö†Ô∏è Voc√™ est√° online em outra loja. Fique Offline primeiro antes de trocar de loja.';
    return;
  }
  // Insere associa√ß√£o (ignora duplicata)
  const{error:insErr}=await db.from('loja_entregadores').insert([{loja_id:loja.id,entregador_id:U.id}]);
  if(insErr&&insErr.code!=='23505'){msg.className='msg-error';msg.textContent='Erro ao vincular: '+insErr.message;return;}
  // Salva loja ativa no banco
  const{error:updErr}=await db.from('usuarios').update({loja_ativa_id:loja.id}).eq('id',U.id);
  if(updErr){console.warn('[loja_ativa_id]',updErr.message);}
  // Salva localmente tamb√©m (fallback se coluna n√£o existir no banco)
  U.loja_ativa_id=loja.id;
  U._loja_ativa_nome=nomeLoja;
  U._loja_ativa_codigo=loja.codigo_loja;
  localStorage.setItem('u',JSON.stringify(U));
  // Salva em chave permanente ‚Äî persiste mesmo ap√≥s logout/fechar app
  localStorage.setItem('loja_vinc_'+U.id,JSON.stringify({
    loja_ativa_id:loja.id,
    _loja_ativa_nome:nomeLoja,
    _loja_ativa_codigo:loja.codigo_loja||''
  }));
  $('cod-loja-inp').value='';
  // Mostra card de confirma√ß√£o imediatamente
  const infoBox=$('ent-loja-ativa-info');
  infoBox.innerHTML=`
    <div style="background:#e8f5e9;border-radius:10px;padding:12px;border:2px solid #00C9A7;">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
        <span style="font-size:20px;">üè™</span>
        <strong style="font-size:15px;color:#1b5e20;">${nomeLoja}</strong>
      </div>
      <p style="font-size:12px;color:#2e7d32;margin:2px 0;">üîë C√≥digo: <strong>${loja.codigo_loja}</strong></p>
      <p style="font-size:12px;color:#2e7d32;margin:2px 0;font-weight:700;">‚úÖ Loja conectada com sucesso!</p>
    </div>`;
  $('ent-selecionar-loja-box').classList.add('hidden');
  if(!U.online){
    msg.className='msg-ok';
    msg.textContent='‚úÖ Loja conectada! Agora clique em "Ficar Online"';
  }else{
    msg.className='msg-ok';
    msg.textContent='‚úÖ Loja conectada!';
  }
  setTimeout(()=>carregarLojaAtiva(),500);
}

// ===== ROTA ENTREGADOR COM STATUS GPS =====
async function abrirRotaEnt(){
  openM('rota-ent');
  // Marcar como visto (remover alerta)
  await db.from('entregas').update({pedido_pronto:false}).eq('entregador_id',U.id).in('status',['aceito','em_rota','chegou_loja','saiu_entrega']);
  $('ent-pedido-alerta').classList.add('hidden');$('rota-notif').classList.add('hidden');
  carregarRotaEnt();
}

async function carregarRotaEnt(){
  const{data}=await db.from('entregas').select('*,loja:loja_id(nome_loja,nome,endereco,loja_lat,loja_lng)').eq('entregador_id',U.id).in('status',['aceito','em_rota','chegou_loja','saiu_entrega','pendente']).order('ordem_rota');
  const el=$('rota-ent-lst');
  if(!data||!data.length){el.innerHTML='<p style="color:#999;text-align:center;padding:20px">Nenhuma entrega atribuida.</p>';return;}
  const ends=data.map(e=>encodeURIComponent(e.endereco_entrega));
  const dest=ends[ends.length-1],wp=ends.slice(0,-1).join('|');
  // Waze: melhor para motos no Brasil
  // Botoes de navegacao no topo (rota completa)
  const mapsUrlRota=`https://www.google.com/maps/dir/?api=1&destination=${dest}${wp?'&waypoints='+wp:''}&travelmode=two-wheeler`;
  const wazeUrlRota=`waze://ul?q=${dest}&navigate=yes`;
  const totalEnts=data.length;
  el.innerHTML=`<div style="margin-bottom:14px;">
    <p style="font-size:11px;color:#888;margin-bottom:6px;text-align:center;">üìç ${totalEnts === 1 ? 'Navegar para a entrega' : 'Rota completa com '+totalEnts+' paradas'}</p>
    <div class="row" style="gap:7px;">
      <a href="${mapsUrlRota}" target="_blank" style="flex:1;">
        <button class="btn btn-blue" style="padding:10px;width:100%;font-size:13px;">üó∫Ô∏è Google Maps</button>
      </a>
      <a href="${wazeUrlRota}" target="_blank" style="flex:1;" onclick="if(!this.href.startsWith('waze'))return;setTimeout(()=>{if(document.hasFocus())this.href='https://waze.com/ul?q=${dest}&navigate=yes';},500)">
        <button class="btn" style="padding:10px;width:100%;font-size:13px;background:#00BBCC;color:white;">üöó Waze</button>
      </a>
    </div>
  </div>`;
  data.forEach((e,i)=>{
    const st=e.status_detalhado||e.status;
    const lojaLat=e.loja&&e.loja.loja_lat||RP_LAT,lojaLng=e.loja&&e.loja.loja_lng||RP_LNG;
    const temCodIfood=!!(e.codigo_confirmacao);
    // Botoes de status
    let botoesHtml='';
    if(st==='aceito'||st==='pendente'){botoesHtml+=`<button class="btn-sm blue" onclick="entStatus('${e.id}','chegou_loja',${lojaLat},${lojaLng})" style="margin:2px">üè™ Cheguei na Loja</button>`;}
    if(st==='chegou_loja'){botoesHtml+=`<button class="btn-sm orange" onclick="entStatus('${e.id}','saiu_entrega',${lojaLat},${lojaLng})" style="margin:2px">üõµ Saindo para Entrega</button>`;}
    if(st==='saiu_entrega'||st==='em_rota'){
      if(temCodIfood){
        // Exige c√≥digo antes de finalizar
        botoesHtml+=`<button class="btn-sm green" onclick="confirmarEntregaComCodigo('${e.id}','${e.numero_pedido||''}',${e.lat_entrega||RP_LAT},${e.lng_entrega||RP_LNG})" style="margin:2px">‚úÖ Confirmar Entrega</button>`;
      } else {
        botoesHtml+=`<button class="btn-sm green" onclick="entStatus('${e.id}','entregue',${e.lat_entrega||RP_LAT},${e.lng_entrega||RP_LNG})" style="margin:2px">‚úÖ Confirmar Entrega</button>`;
      }
    }
    const steps=['aceito','chegou_loja','saiu_entrega','entregue'];
    const curI=steps.indexOf(st);
    const flowHtml=steps.map((s,idx)=>`<div class="sf-step ${idx<curI?'done':idx===curI?'current':''}">${['Aceito','Na Loja','A Caminho','Entregue'][idx]}</div>`).join('');
    const endEnc=encodeURIComponent(e.endereco_entrega);
    // Link Maps abre app externo via deep link
    const mapsLink=`https://www.google.com/maps/dir/?api=1&destination=${endEnc}&travelmode=two-wheeler`;
    const wazeLink=`waze://ul?q=${endEnc}&navigate=yes`;
    el.innerHTML+=`<div class="ecard rota">
      <div style="display:flex;justify-content:space-between;margin-bottom:4px;"><strong>${i+1}. ${e.numero_pedido?'#'+e.numero_pedido:e.cliente_nome||'Entrega'}</strong><span class="badge b-${st}">${st}</span></div>
      <div class="status-flow">${flowHtml}</div>
      <p style="font-size:12px;color:#555;margin:3px 0">üìç ${e.endereco_entrega}</p>
      ${e.cliente_nome?`<p style="font-size:11px;color:#888">üë§ ${e.cliente_nome}${e.cliente_telefone?` | <a href="tel:${e.cliente_telefone}" style="color:#004E89;font-weight:700">üìû ${e.cliente_telefone}</a>`:''}</p>`:''}
      ${e.distancia_km>0?`<p style="font-size:11px;color:#888">üìè ${parseFloat(e.distancia_km).toFixed(1)}km | <strong style="color:#2e7d32">${fR(e.valor_corrida||e.valor_entregador)}</strong></p>`:''}
      ${temCodIfood?`<div style="background:#fff3e0;padding:8px;border-radius:8px;margin:5px 0;border:1.5px solid #FF6B35;">
        <p style="font-size:11px;font-weight:700;color:#e65100;margin:0">‚ö†Ô∏è Esta entrega exige confirma√ß√£o no iFood ao entregar</p>
      </div>`:''}
      <div class="row" style="margin-top:7px;flex-wrap:wrap;gap:4px;">
        ${botoesHtml}
      </div>
    </div>`;
  });
}

async function entStatus(id,novoStatus,refLat,refLng){
  const RAIO_M=350; // metros ‚Äî raio de valida√ß√£o
  if(novoStatus==='chegou_loja'||novoStatus==='entregue'){
    // 1) Verifica GPS global (localStorage √© mais confi√°vel que banco pois sync pode atrasar)
    const gpsGlobalLocal=localStorage.getItem('adm_gps_global')==='1';
    let gpsObrigatorio=gpsGlobalLocal;
    // 2) Confirma com banco se o localStorage diz false (pode estar desatualizado)
    if(!gpsObrigatorio){
      try{
        const{data:ped}=await db.from('entregas').select('loja_id').eq('id',id).single();
        if(ped?.loja_id){
          const{data:lj}=await db.from('usuarios').select('gps_validacao_obrigatorio').eq('id',ped.loja_id).single();
          gpsObrigatorio=lj?.gps_validacao_obrigatorio||false;
          // Sincroniza localStorage com banco
          if(gpsObrigatorio)localStorage.setItem('adm_gps_global','1');
        }
      }catch(e){}
    }
    if(gpsObrigatorio){
      // Pede posi√ß√£o FRESCA (maximumAge:0 = n√£o usa cache)
      try{
        const pos=await new Promise((resolve,reject)=>{
          const timer=setTimeout(()=>{
            // Timeout: tenta usar a √∫ltima posi√ß√£o conhecida mesmo que velha
            if(myLat&&myLng)resolve({lat:myLat,lng:myLng,stale:true});
            else reject('timeout');
          },10000);
          navigator.geolocation.getCurrentPosition(
            p=>{clearTimeout(timer);myLat=p.coords.latitude;myLng=p.coords.longitude;resolve({lat:p.coords.latitude,lng:p.coords.longitude,stale:false});},
            err=>{clearTimeout(timer);if(myLat&&myLng)resolve({lat:myLat,lng:myLng,stale:true});else reject('bloqueado');},
            {enableHighAccuracy:true,timeout:9000,maximumAge:0}
          );
        });
        if(!refLat||!refLng||refLat===0){
          // Sem coordenada de refer√™ncia ‚Äî n√£o bloqueia mas avisa
          console.warn('[GPS] refLat/refLng ausente, pulando valida√ß√£o');
        } else {
          const dist=distKm(pos.lat,pos.lng,refLat,refLng)*1000;
          const aviso=pos.stale?' (GPS desatualizado)':'';
          if(dist>RAIO_M){
            alert('üìç Valida√ß√£o de GPS ativa'+aviso+'\n\nVoc√™ precisa estar a menos de '+RAIO_M+'m do local.\nDist√¢ncia atual: '+Math.round(dist)+'m\n\nCertifique-se de estar no endere√ßo correto antes de confirmar.');
            return;
          }
        }
      }catch(e){
        alert('üìç GPS obrigat√≥rio mas n√£o dispon√≠vel.\nAtive o GPS do celular e tente novamente.\n('+e+')');
        return;
      }
    }
  }
  const upd={status_detalhado:novoStatus};
  if(novoStatus==='chegou_loja')upd.chegou_loja_at=new Date().toISOString();
  if(novoStatus==='saiu_entrega'){upd.saiu_entrega_at=new Date().toISOString();upd.status='em_rota';}
  if(novoStatus==='entregue'){upd.status='entregue';upd.entregue_at=new Date().toISOString();upd.pedido_pronto=false;}
  await db.from('entregas').update(upd).eq('id',id);
  carregarRotaEnt();initEnt();
}

// ‚îÄ‚îÄ Confirma√ß√£o de Entrega com C√≥digo iFood (modal) ‚îÄ‚îÄ
let _ifoodPedId=null,_ifoodRefLat=null,_ifoodRefLng=null;

async function confirmarEntregaComCodigo(pedId,numPedido,refLat,refLng){
  _ifoodPedId=pedId;_ifoodRefLat=refLat;_ifoodRefLng=refLng;
  $('ifood-conf-num').textContent=numPedido?'#'+numPedido:'';
  $('ifood-conf-link').href=`${IFOOD_URL}${numPedido||''}`;
  clearM('ifood-conf-msg');
  openM('ifood-conf');
}

async function finalizarComCodigoIfood(){
  // Mantido para compatibilidade ‚Äî redireciona para vers√£o sem c√≥digo
  await finalizarSemCodigoIfood();
}
async function finalizarSemCodigoIfood(){
  showM('ifood-conf-msg','Finalizando...', true);
  closeM('ifood-conf');
  await entStatus(_ifoodPedId,'entregue',_ifoodRefLat,_ifoodRefLng);
}

// ‚îÄ‚îÄ Admin: Finalizar entrega manualmente ‚îÄ‚îÄ
async function admFinalizarEntrega(id){
  if(!confirm('Finalizar esta entrega manualmente pelo painel administrativo?'))return;
  await db.from('entregas').update({status:'entregue',status_detalhado:'entregue',entregue_at:new Date().toISOString()}).eq('id',id);
  await carregarDadosAdmin();
}

// ‚îÄ‚îÄ Admin: Realocar entrega para outro entregador ‚îÄ‚îÄ
async function admRealocarEntrega(pedId){
  const{data:ents}=await db.from('usuarios').select('id,nome').eq('tipo','entregador').eq('online',true);
  if(!ents||!ents.length){alert('Nenhum entregador online no momento.');return;}
  const opts=ents.map((e,i)=>`${i+1}. ${e.nome}`).join('\n');
  const escolha=prompt(`Escolha o novo entregador (digite o n√∫mero):\n\n${opts}`);
  if(!escolha)return;
  const idx=parseInt(escolha)-1;
  if(isNaN(idx)||idx<0||idx>=ents.length){alert('Op√ß√£o inv√°lida.');return;}
  await db.from('entregas').update({entregador_id:ents[idx].id}).eq('id',pedId);
  await carregarDadosAdmin();
  alert(`‚úÖ Entrega realocada para ${ents[idx].nome}`);
}

// ‚îÄ‚îÄ Loja: Finalizar entrega manualmente (sem c√≥digo) ‚îÄ‚îÄ
async function ljFinalizarEntrega(id){
  if(!confirm('Finalizar esta entrega?\nNenhum c√≥digo de confirma√ß√£o √© necess√°rio.'))return;
  await db.from('entregas').update({status:'entregue',status_detalhado:'entregue',entregue_at:new Date().toISOString()}).eq('id',id);
  carregarPedidos();
}

// ‚îÄ‚îÄ Admin: Clicar no entregador foca no mapa ‚îÄ‚îÄ
function focarEntAdm(entId){
  const mk=mrks['admin'];
  const marker=mk[entId];
  if(marker&&mapas['admin']){
    seg['admin']=false;
    mapas['admin'].setView(marker.getLatLng(),17,{animate:true});
    marker.openPopup();
    // Scroll at√© o mapa
    const mapaEl=$('mapa-admin');
    if(mapaEl)mapaEl.scrollIntoView({behavior:'smooth',block:'center'});
  }else{
    alert('Localiza√ß√£o ainda n√£o dispon√≠vel para este entregador.');
  }
}

// ‚îÄ‚îÄ Loja: Clicar em entregador para focar no mapa ‚îÄ‚îÄ
function focarEntregadorMapa(entId){
  const mk=mrks['loja'];
  const marker=mk[entId];
  if(marker&&mapas['loja']){
    seg['loja']=false;
    mapas['loja'].setView(marker.getLatLng(),17,{animate:true});
    marker.openPopup();
    // Destaca o badge clicado
    document.querySelectorAll('#lista-on-lj span').forEach(s=>s.style.outline='');
    event&&event.currentTarget&&(event.currentTarget.style.outline='3px solid #FFD700');
  }else{
    alert('Localiza√ß√£o ainda n√£o dispon√≠vel. O entregador precisa ter o GPS ativo.');
  }
}
let _gnhFiltro='hoje';
let _gnhMesOffset=0; // 0 = m√™s atual, -1 = m√™s passado, -2 = 2 meses atr√°s, etc.

// Verifica virada de m√™s e arquiva ganhos do m√™s anterior no banco
async function verificarArquivoMensal(){
  const agora=new Date();
  const chave='ganhos_mes_arquivado_'+agora.getFullYear()+'_'+(agora.getMonth()+1);
  // Se j√° arquivou este m√™s, n√£o faz nada
  if(localStorage.getItem(chave))return;
  // Verifica se tem ganhos do m√™s PASSADO para arquivar
  const mesPassado=new Date(agora.getFullYear(),agora.getMonth()-1,1);
  const fimMesPassado=new Date(agora.getFullYear(),agora.getMonth(),0,23,59,59,999);
  const{data:ents}=await db.from('entregas').select('valor_corrida,valor_entregador').eq('entregador_id',U.id).in('status',['entregue']).gte('created_at',mesPassado.toISOString()).lte('created_at',fimMesPassado.toISOString());
  if(ents&&ents.length>0){
    const total=ents.reduce((s,e)=>s+parseFloat(e.valor_corrida||e.valor_entregador||0),0);
    const nomeMes=mesPassado.toLocaleString('pt-BR',{month:'long',year:'numeric'});
    // Salva no banco como hist√≥rico
    const histKey='historico_ganhos_'+mesPassado.getFullYear()+'_'+(mesPassado.getMonth()+1);
    try{
      await db.from('usuarios').update({[histKey]:JSON.stringify({total,corridas:ents.length,mes:nomeMes})}).eq('id',U.id);
    }catch(e){}// Ignora se coluna n√£o existir
    // Salva no localStorage mesmo assim
    const hist=JSON.parse(localStorage.getItem('ganhos_historico_'+U.id)||'[]');
    hist.unshift({mes:nomeMes,total,corridas:ents.length,ano:mesPassado.getFullYear(),menum:mesPassado.getMonth()+1});
    if(hist.length>12)hist.pop();// Mant√©m √∫ltimos 12 meses
    localStorage.setItem('ganhos_historico_'+U.id,JSON.stringify(hist));
    localStorage.setItem(chave,'1');
  } else {
    localStorage.setItem(chave,'1');// Marca como verificado mesmo sem dados
  }
}

async function abrirGanhosEnt(){
  openM('ganhos');
  _gnhFiltro='hoje';
  _gnhMesOffset=0;
  // Verificar e arquivar ganhos do m√™s passado se necess√°rio
  verificarArquivoMensal().catch(e=>console.warn('[arquivo mensal]',e));
  // Highlight bot√£o ativo
  ['hoje','ontem','semana','mes'].forEach(f=>{
    const b=$('gnhf-'+f);if(b){b.style.background=f==='hoje'?'#00C9A7':'#888';b.style.opacity='1';}
  });
  // Oculta nav de mes ao abrir (filtro padr√£o √© hoje)
  const navEl=$('gnh-nav-mes');if(navEl)navEl.style.display='none';
  await carregarResumoGanhos();
  await carregarGanhos();
  // Mostrar hist√≥rico mensal se houver
  mostrarHistoricoMensal();
}

function mostrarHistoricoMensal(){
  const hist=JSON.parse(localStorage.getItem('ganhos_historico_'+U.id)||'[]');
  if(!hist.length)return;
  const el=$('gnh-dados');
  const histHTML=`<div style="background:white;border-radius:12px;padding:12px;margin-top:10px;box-shadow:0 1px 6px rgba(0,0,0,.06);">
    <div style="font-size:12px;font-weight:700;color:#333;margin-bottom:8px;">üìÖ Hist√≥rico Mensal</div>
    ${hist.map(h=>`<div style="display:flex;justify-content:space-between;padding:7px 0;border-bottom:1px solid #f5f5f5;font-size:13px;">
      <span style="color:#666;text-transform:capitalize;">${h.mes}</span>
      <div style="text-align:right;">
        <strong style="color:#1b5e20;">${fR(h.total)}</strong>
        <span style="font-size:11px;color:#888;display:block;">${h.corridas} corrida${h.corridas!==1?'s':''}</span>
      </div>
    </div>`).join('')}
  </div>`;
  // Adiciona ao final se n√£o existir ainda
  if(!el.querySelector('#hist-mensal-div')){
    const div=document.createElement('div');div.id='hist-mensal-div';div.innerHTML=histHTML;
    el.appendChild(div);
  }
}

function filtroGanhos(per,btn){
  _gnhFiltro=per;
  _gnhMesOffset=0; // reset ao trocar filtro
  ['hoje','ontem','semana','mes'].forEach(f=>{
    const b=$('gnhf-'+f);if(b){b.style.background=f===per?'#00C9A7':'#888';}
  });
  // Mostrar/ocultar navega√ß√£o de meses
  const navEl=$('gnh-nav-mes');
  if(per==='mes'){
    navEl.style.display='flex';
    atualizarLabelMes();
  } else {
    navEl.style.display='none';
  }
  carregarGanhos();
}

function navMes(dir){
  const novoOffset=_gnhMesOffset+dir;
  // N√£o permite ir para o futuro (al√©m do m√™s atual = offset 0)
  if(novoOffset>0)return;
  _gnhMesOffset=novoOffset;
  atualizarLabelMes();
  carregarGanhos();
  // Desabilita bot√£o pr√≥ximo se j√° est√° no m√™s atual
  const proxBtn=$('gnh-nav-prox');
  if(proxBtn)proxBtn.style.opacity=_gnhMesOffset===0?'0.3':'1';
}

function atualizarLabelMes(){
  const agora=new Date();
  const alvo=new Date(agora.getFullYear(),agora.getMonth()+_gnhMesOffset,1);
  const label=alvo.toLocaleString('pt-BR',{month:'long',year:'numeric'});
  const el=$('gnh-mes-label');if(el)el.textContent=label.charAt(0).toUpperCase()+label.slice(1);
  const proxBtn=$('gnh-nav-prox');
  if(proxBtn)proxBtn.style.opacity=_gnhMesOffset===0?'0.3':'1';
}

function periodoRange(per,mesOffset){
  const agora=new Date();
  const off=mesOffset||0;
  let inicio,fim=new Date(agora);
  fim.setHours(23,59,59,999);
  if(per==='hoje'){inicio=new Date(agora);inicio.setHours(0,0,0,0);}
  else if(per==='ontem'){
    inicio=new Date(agora);inicio.setDate(inicio.getDate()-1);inicio.setHours(0,0,0,0);
    fim=new Date(agora);fim.setDate(fim.getDate()-1);fim.setHours(23,59,59,999);
  }
  else if(per==='semana'){
    // Semana BR: Segunda a Domingo ‚Äî (getDay()+6)%7 dias desde segunda
    inicio=new Date(agora);
    inicio.setDate(inicio.getDate()-((agora.getDay()+6)%7));
    inicio.setHours(0,0,0,0);
    fim=new Date(inicio);fim.setDate(fim.getDate()+6);fim.setHours(23,59,59,999);
  }
  else{ // mes ‚Äî suporta offset para meses anteriores
    // JavaScript Date handles month underflow correctly (e.g. month -1 = December of prev year)
    const ano=agora.getFullYear();
    const mes=agora.getMonth()+off; // off negativo = meses anteriores, JS normaliza automaticamente
    inicio=new Date(ano,mes,1,0,0,0,0);
    // √öltimo dia do m√™s alvo
    fim=new Date(ano,mes+1,0,23,59,59,999);
  }
  return{inicio:inicio.toISOString(),fim:fim.toISOString()};
}

async function carregarResumoGanhos(){
  const el=$('gnh-resumo');el.innerHTML='';
  // Busca hoje, semana, m√™s de uma vez
  const hoje=new Date();
  const inicioHoje=new Date(hoje);inicioHoje.setHours(0,0,0,0);
  const inicioOntem=new Date(hoje);inicioOntem.setDate(inicioOntem.getDate()-1);inicioOntem.setHours(0,0,0,0);
  const fimOntem=new Date(hoje);fimOntem.setDate(fimOntem.getDate()-1);fimOntem.setHours(23,59,59,999);
  const inicioSem=new Date(hoje);inicioSem.setDate(inicioSem.getDate()-((hoje.getDay()+6)%7));inicioSem.setHours(0,0,0,0);
  const fimSem=new Date(inicioSem);fimSem.setDate(fimSem.getDate()+6);fimSem.setHours(23,59,59,999);
  const inicioMes=new Date(hoje.getFullYear(),hoje.getMonth(),1);

  const[rHoje,rOntem,rSem,rMes]=await Promise.all([
    db.from('entregas').select('valor_corrida,valor_entregador').eq('entregador_id',U.id).in('status',['entregue']).gte('created_at',inicioHoje.toISOString()),
    db.from('entregas').select('valor_corrida,valor_entregador').eq('entregador_id',U.id).in('status',['entregue']).gte('created_at',inicioOntem.toISOString()).lte('created_at',fimOntem.toISOString()),
    db.from('entregas').select('valor_corrida,valor_entregador').eq('entregador_id',U.id).in('status',['entregue']).gte('created_at',inicioSem.toISOString()).lte('created_at',fimSem.toISOString()),
    db.from('entregas').select('valor_corrida,valor_entregador').eq('entregador_id',U.id).in('status',['entregue']).gte('created_at',inicioMes.toISOString()).lte('created_at',new Date().toISOString()),
  ]);
  const soma=arr=>(arr||[]).reduce((s,e)=>s+parseFloat(e.valor_corrida||e.valor_entregador||0),0);
  const dH=rHoje.data||[],dO=rOntem.data||[],dS=rSem.data||[],dM=rMes.data||[];
  el.innerHTML=`
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:4px;">
      <div style="background:#e8f5e9;border-radius:10px;padding:12px;text-align:center;cursor:pointer;" onclick="filtroGanhos('hoje',$('gnhf-hoje'))">
        <p style="font-size:10px;color:#666;font-weight:700;text-transform:uppercase;">Hoje</p>
        <p style="font-size:22px;font-weight:800;color:#2e7d32;">${fR(soma(dH))}</p>
        <p style="font-size:11px;color:#555;">${dH.length} corridas</p>
      </div>
      <div style="background:#fff3e0;border-radius:10px;padding:12px;text-align:center;cursor:pointer;" onclick="filtroGanhos('ontem',$('gnhf-ontem'))">
        <p style="font-size:10px;color:#666;font-weight:700;text-transform:uppercase;">Ontem</p>
        <p style="font-size:22px;font-weight:800;color:#e65100;">${fR(soma(dO))}</p>
        <p style="font-size:11px;color:#555;">${dO.length} corridas</p>
      </div>
      <div style="background:#e3f2fd;border-radius:10px;padding:12px;text-align:center;cursor:pointer;" onclick="filtroGanhos('semana',$('gnhf-semana'))">
        <p style="font-size:10px;color:#666;font-weight:700;text-transform:uppercase;">Esta Semana</p>
        <p style="font-size:22px;font-weight:800;color:#1565C0;">${fR(soma(dS))}</p>
        <p style="font-size:11px;color:#555;">${dS.length} corridas</p>
      </div>
      <div style="background:#f3e5f5;border-radius:10px;padding:12px;text-align:center;cursor:pointer;" onclick="filtroGanhos('mes',$('gnhf-mes'))">
        <p style="font-size:10px;color:#666;font-weight:700;text-transform:uppercase;">Este M√™s</p>
        <p style="font-size:22px;font-weight:800;color:#6a1b9a;">${fR(soma(dM))}</p>
        <p style="font-size:11px;color:#555;">${dM.length} corridas</p>
      </div>
    </div>`;
}

async function carregarGanhos(){
  const per=_gnhFiltro||'hoje';
  const el=$('gnh-dados');el.innerHTML='<p style="text-align:center;color:#999;font-size:12px;">Carregando...</p>';
  const{inicio,fim}=periodoRange(per,per==='mes'?_gnhMesOffset:0);
  const{data}=await db.from('entregas').select('*,l:loja_id(nome_loja,nome,endereco)').eq('entregador_id',U.id).in('status',['entregue']).gte('created_at',inicio).lte('created_at',fim).order('created_at',{ascending:false});
  if(!data||!data.length){el.innerHTML='<p style="color:#999;text-align:center;padding:20px">Nenhuma entrega no per√≠odo.</p>';return;}
  const tot=data.reduce((s,e)=>s+parseFloat(e.valor_corrida||e.valor_entregador||0),0);
  // Label din√¢mico para meses passados
  let labelPer='';
  if(per==='mes'&&_gnhMesOffset<0){
    const agora=new Date();
    const alvo=new Date(agora.getFullYear(),agora.getMonth()+_gnhMesOffset,1);
    labelPer=alvo.toLocaleString('pt-BR',{month:'long',year:'numeric'});
    labelPer=labelPer.charAt(0).toUpperCase()+labelPer.slice(1);
  }else{
    const labels={hoje:'Hoje',ontem:'Ontem',semana:'Esta Semana',mes:'Este M√™s'};
    labelPer=labels[per]||per;
  }
  el.innerHTML=`
    <div style="background:#e8f5e9;padding:12px;border-radius:11px;text-align:center;margin-bottom:12px;border:2px solid #00C9A7;">
      <p style="font-size:11px;color:#666;">${labelPer} ‚Äî ${data.length} entrega(s)</p>
      <p style="font-size:28px;font-weight:800;color:#2e7d32;">${fR(tot)}</p>
    </div>
    <p style="font-size:12px;font-weight:700;color:#444;margin-bottom:6px;">üìã Detalhes das corridas:</p>
    ${data.map((e,i)=>{
      const hr=e.entregue_at?new Date(e.entregue_at).toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}):'--:--';
      const nomeLoja=e.l?e.l.nome_loja||e.l.nome:'Loja';
      const endRetirada=e.l&&e.l.endereco?e.l.endereco:'Endere√ßo da loja';
      return `<div style="padding:10px;border-bottom:1px solid #f0f0f0;background:white;border-radius:8px;margin-bottom:5px;border:1px solid #eee;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
          <strong style="font-size:13px;">Corrida ${i+1}${e.numero_pedido?' ‚Äî #'+e.numero_pedido:''}</strong>
          <strong style="color:#2e7d32;font-size:14px;">${fR(e.valor_corrida||e.valor_entregador)}</strong>
        </div>
        <p style="font-size:11px;color:#666;margin:2px 0;">üïê Hor√°rio: <strong>${hr}</strong></p>
        <p style="font-size:11px;color:#666;margin:2px 0;">üè™ Loja: <strong>${nomeLoja}</strong></p>
        <p style="font-size:11px;color:#555;margin:2px 0;">üì§ Retirada: ${endRetirada}</p>
        <p style="font-size:11px;color:#555;margin:2px 0;">üìç Entrega: ${e.endereco_entrega||'-'}</p>
        ${e.distancia_km>0?`<p style="font-size:11px;color:#888;margin:2px 0;">üìè ${parseFloat(e.distancia_km).toFixed(1)} km</p>`:''}
        <span class="badge b-entregue" style="margin-top:4px;display:inline-block;">‚úÖ Entregue</span>
      </div>`;
    }).join('')}`;
}

async function abrirCfgEnt(){
  openM('cfg-ent');
  $('ent-nome2').value=U.nome||'';$('ent-tel2').value=U.telefone||'';$('ent-plc').value=U.placa_moto||'';$('ent-pix').value=U.chave_pix||'';$('ent-sen').value='';clearM('ent-cfg-msg');
}
async function salvarCfgEnt(){
  const d={nome:v('ent-nome2'),telefone:v('ent-tel2'),placa_moto:v('ent-plc'),chave_pix:v('ent-pix')};
  const ns=v('ent-sen');if(ns.length>=6)d.senha_hash=ns;
  const{error}=await db.from('usuarios').update(d).eq('id',U.id);
  if(error){showM('ent-cfg-msg','Erro: '+error.message);return;}
  U={...U,...d};localStorage.setItem('u',JSON.stringify(U));$('ent-nome').textContent=d.nome;showM('ent-cfg-msg','Salvo!',true);setTimeout(()=>closeM('cfg-ent'),1500);
}
</script>
</body>
</html>
