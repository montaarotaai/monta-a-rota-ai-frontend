<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monta a Rota A&iacute;</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #333; }

        /* LOGIN */
        .login-container { max-width: 400px; margin: 50px auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .logo { text-align: center; margin-bottom: 30px; }
        .logo img { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; }
        h2 { text-align: center; color: #004E89; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #666; font-size: 14px; }
        input[type=text], input[type=email], input[type=password], input[type=tel], input[type=number] {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px;
        }
        input:focus { outline: none; border-color: #FF6B35; }
        button { width: 100%; padding: 15px; background: linear-gradient(135deg, #FF6B35 0%, #004E89 100%); color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin-top: 10px; }
        button:hover { opacity: 0.9; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        .tabs { display: flex; margin-bottom: 20px; }
        .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; border-bottom: 2px solid #ddd; background: none; color: #333; font-size: 15px; margin-top: 0; }
        .tab.active { border-bottom-color: #FF6B35; color: #FF6B35; font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .user-type { display: flex; gap: 10px; margin-bottom: 15px; }
        .user-type label { flex: 1; padding: 10px; text-align: center; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; margin-bottom: 0; }
        .user-type input:checked + label { border-color: #FF6B35; background: #fff5f2; }
        .user-type input { display: none; }
        .hidden { display: none !important; }
        .error-msg { background: #ffebee; color: #c62828; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; }
        .success-msg { background: #e8f5e9; color: #2e7d32; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; }

        /* DASHBOARD */
        .header { background: linear-gradient(135deg, #FF6B35 0%, #004E89 100%); color: white; padding: 20px; text-align: center; position: relative; }
        .header img { width: 80px; height: 80px; border-radius: 50%; margin-bottom: 10px; object-fit: cover; }
        .container { padding: 20px; max-width: 1200px; margin: 0 auto; }
        .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s; }
        .card:hover { transform: translateY(-3px); }
        .card h3 { font-size: 13px; color: #666; margin-bottom: 10px; }
        .card .value { font-size: 28px; font-weight: bold; color: #FF6B35; }
        .menu { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .menu-item { background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s; }
        .menu-item:hover { transform: translateY(-2px); }
        .menu-item .icon { font-size: 32px; margin-bottom: 10px; }
        .logout { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer; border: none; width: auto; font-size: 14px; }

        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto; }
        .modal-content { background: white; margin: 20px auto; padding: 20px; border-radius: 12px; max-width: 600px; position: relative; }
        .close { position: absolute; top: 10px; right: 15px; font-size: 28px; cursor: pointer; color: #666; }
        .list-item { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .list-item:last-child { border-bottom: none; }
        .btn-sm { background: #FF6B35; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; white-space: nowrap; }
        .btn-sm.verde { background: #00C9A7; }
        .btn-sm.vermelho { background: #e74c3c; }
        .btn-sm.azul { background: #004E89; }
        .taxa-input { width: 80px; padding: 6px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; text-align: center; }
        .badge-ativo { background: #e8f5e9; color: #2e7d32; padding: 3px 8px; border-radius: 12px; font-size: 12px; }
        .badge-bloqueado { background: #ffebee; color: #c62828; padding: 3px 8px; border-radius: 12px; font-size: 12px; }
        .badge-online { background: #e3f2fd; color: #1565c0; padding: 3px 8px; border-radius: 12px; font-size: 12px; }
        .section-title { font-size: 16px; font-weight: bold; color: #004E89; margin: 20px 0 10px; }

        /* ENTREGADOR ONLINE TOGGLE */
        .online-btn { background: #00C9A7; font-size: 18px; padding: 20px; border-radius: 16px; }
        .online-btn.offline { background: linear-gradient(135deg, #FF6B35 0%, #004E89 100%); }

        /* FOTO PERFIL */
        .foto-perfil { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid white; cursor: pointer; }
        .foto-placeholder { width: 100px; height: 100px; border-radius: 50%; background: rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; font-size: 40px; cursor: pointer; border: 3px dashed rgba(255,255,255,0.6); margin: 0 auto 10px; }
    </style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen" class="login-container">
    <div class="logo">
        <img src="logo.png" alt="Monta a Rota A&iacute;" onerror="this.style.display='none'">
        <h2>Monta a Rota A&iacute;</h2>
    </div>
    <div class="tabs">
        <button class="tab active" onclick="switchTab('login', this)">Entrar</button>
        <button class="tab" onclick="switchTab('register', this)">Cadastrar</button>
    </div>
    <div id="login-tab" class="tab-content active">
        <div id="login-msg"></div>
        <div class="form-group"><label>Email</label><input type="email" id="login-email" placeholder="seu@email.com"></div>
        <div class="form-group"><label>Senha</label><input type="password" id="login-senha" placeholder="\u2022\u2022\u2022\u2022\u2022\u2022"></div>
        <button onclick="fazerLogin()" id="btn-login">Entrar</button>
    </div>
    <div id="register-tab" class="tab-content">
        <div id="register-msg"></div>
        <div class="user-type">
            <label><input type="radio" name="register-type" value="loja" checked onchange="toggleCadastro()"> <span>\ud83c\udfea Loja</span></label>
            <label><input type="radio" name="register-type" value="entregador" onchange="toggleCadastro()"> <span>\ud83d\udef5 Entregador</span></label>
        </div>
        <div class="form-group"><label>Nome</label><input type="text" id="reg-nome" placeholder="Nome completo"></div>
        <div class="form-group"><label>Email</label><input type="email" id="reg-email" placeholder="seu@email.com"></div>
        <div class="form-group"><label>Telefone</label><input type="tel" id="reg-telefone" placeholder="(11) 99999-9999"></div>
        <div class="form-group"><label>Senha</label><input type="password" id="reg-senha" placeholder="M&iacute;nimo 6 caracteres"></div>
        <div id="campos-loja">
            <div class="form-group"><label>Nome da Loja</label><input type="text" id="reg-nome-loja" placeholder="Ex: Pizzaria do Z&eacute;"></div>
            <div class="form-group"><label>CNPJ</label><input type="text" id="reg-cnpj" placeholder="00.000.000/0000-00"></div>
            <div class="form-group"><label>Endere&ccedil;o</label><input type="text" id="reg-endereco" placeholder="Rua, n&uacute;mero, bairro"></div>
        </div>
        <div id="campos-entregador" class="hidden">
            <div class="form-group"><label>CNH</label><input type="text" id="reg-cnh" placeholder="N&uacute;mero da CNH"></div>
            <div class="form-group"><label>Placa da Moto</label><input type="text" id="reg-placa" placeholder="ABC-1234"></div>
            <div class="form-group"><label>Pix para pagamento</label><input type="text" id="reg-pix" placeholder="Chave Pix"></div>
        </div>
        <button onclick="fazerCadastro()" id="btn-cadastrar">Cadastrar</button>
    </div>
</div>

<!-- DASHBOARD ADMIN -->
<div id="dashboard-admin" class="hidden">
    <div class="header">
        <button class="logout" onclick="fazerLogout()">Sair</button>
        <img src="logo.png" alt="" onerror="this.style.display='none'">
        <h1>Monta a Rota A&iacute;</h1>
        <p>Dashboard Administrativo</p>
    </div>
    <div class="container">
        <div class="cards">
            <div class="card" onclick="carregarEntregadores()">
                <h3>Entregadores</h3>
                <div class="value" id="total-entregadores">-</div>
            </div>
            <div class="card" onclick="carregarLojas()">
                <h3>Lojas Ativas</h3>
                <div class="value" id="total-lojas">-</div>
            </div>
            <div class="card">
                <h3>Cobran&ccedil;as Pendentes</h3>
                <div class="value" id="total-pendentes">-</div>
            </div>
        </div>
        <div class="menu">
            <div class="menu-item" onclick="carregarEntregadores()"><div class="icon">\ud83d\udef5</div><h3>Entregadores</h3></div>
            <div class="menu-item" onclick="carregarLojas()"><div class="icon">\ud83c\udfea</div><h3>Lojas</h3></div>
            <div class="menu-item" onclick="abrirFinanceiroAdmin()"><div class="icon">\ud83d\udcb0</div><h3>Financeiro</h3></div>
            <div class="menu-item" onclick="abrirCobrancas()"><div class="icon">\ud83d\udcc5</div><h3>Cobran&ccedil;as</h3></div>
        </div>
    </div>
</div>

<!-- DASHBOARD LOJA -->
<div id="dashboard-loja" class="hidden">
    <div class="header">
        <button class="logout" onclick="fazerLogout()">Sair</button>
        <h1 id="nome-loja-display">Minha Loja</h1>
        <p>\u00c1rea da Loja</p>
    </div>
    <div class="container">
        <div class="cards">
            <div class="card">
                <h3>Minha taxa/entrega</h3>
                <div class="value" id="taxa-sistema-loja">R$ -</div>
            </div>
            <div class="card">
                <h3>Taxa entregador</h3>
                <div class="value" id="taxa-entregador-loja">R$ -</div>
            </div>
            <div class="card">
                <h3>Entregas Hoje</h3>
                <div class="value" id="entregas-loja-hoje">0</div>
            </div>
        </div>
        <!-- Taxa entregador editavel -->
        <div style="background:white;padding:15px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);margin-bottom:20px;">
            <p style="font-size:13px;color:#666;margin-bottom:8px;">Definir taxa que pago por entrega ao entregador:</p>
            <div style="display:flex;gap:10px;align-items:center;">
                <input type="number" id="nova-taxa-entregador" placeholder="Ex: 5.00" step="0.10" min="0" style="flex:1;">
                <button onclick="salvarTaxaEntregador()" style="width:auto;padding:10px 15px;margin:0;">Salvar</button>
            </div>
            <div id="taxa-msg" style="margin-top:8px;font-size:13px;"></div>
        </div>
        <div class="menu">
            <div class="menu-item" onclick="abrirScannerLoja()"><div class="icon">\ud83d\udcf7</div><h3>Scanear Comanda</h3></div>
            <div class="menu-item" onclick="abrirRelatorioLoja()"><div class="icon">\ud83d\udcca</div><h3>Relat&oacute;rio</h3></div>
            <div class="menu-item" onclick="abrirMapaCalorLoja()"><div class="icon">\ud83d\uddfa\ufe0f</div><h3>Mapa de Calor</h3></div>
            <div class="menu-item"><div class="icon">\u2699\ufe0f</div><h3>Configura&ccedil;&otilde;es</h3></div>
        </div>
    </div>
</div>

<!-- DASHBOARD ENTREGADOR -->
<div id="dashboard-entregador" class="hidden">
    <div class="header" style="cursor:pointer;" onclick="abrirFotoPerfil()">
        <button class="logout" onclick="event.stopPropagation();fazerLogout()">Sair</button>
        <div id="foto-container">
            <div class="foto-placeholder" id="foto-placeholder">\ud83d\udc64</div>
            <img id="foto-entregador" class="foto-perfil hidden" src="" alt="Foto">
        </div>
        <h1 id="nome-entregador-display">Entregador</h1>
        <p>&Aacute;rea do Entregador &bull; <span id="status-online-texto">Offline</span></p>
        <input type="file" id="input-foto" accept="image/*" class="hidden" onchange="uploadFoto(event)">
    </div>
    <div class="container">
        <div class="cards">
            <div class="card">
                <h3>Entregas Hoje</h3>
                <div class="value" id="minhas-entregas">0</div>
            </div>
            <div class="card">
                <h3>Ganhos Hoje</h3>
                <div class="value" id="meus-ganhos">R$ 0</div>
            </div>
            <div class="card">
                <h3>Avalia&ccedil;&atilde;o</h3>
                <div class="value" id="minha-avaliacao">\u2b50 5.0</div>
            </div>
        </div>
        <div class="menu">
            <div class="menu-item online-btn offline" id="btn-online-card" onclick="toggleOnline()">
                <div class="icon" id="icone-online">\ud83d\udfe2</div>
                <h3 id="texto-online">Ficar Online</h3>
            </div>
            <div class="menu-item" onclick="abrirRota()">
                <div class="icon">\ud83d\uddfa\ufe0f</div>
                <h3>Minha Rota</h3>
            </div>
            <div class="menu-item" onclick="abrirGanhos()">
                <div class="icon">\ud83d\udcb5</div>
                <h3>Meus Ganhos</h3>
            </div>
            <div class="menu-item" onclick="abrirConfiguracoes()">
                <div class="icon">\u2699\ufe0f</div>
                <h3>Configura&ccedil;&otilde;es</h3>
            </div>
        </div>
    </div>
</div>

<!-- MODAIS -->
<!-- Modal Entregadores (Admin) -->
<div id="modal-entregadores" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('entregadores')">&times;</span>
        <h2>\ud83d\udef5 Entregadores</h2>
        <div id="lista-entregadores"><p>Carregando...</p></div>
    </div>
</div>

<!-- Modal Lojas (Admin) -->
<div id="modal-lojas" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('lojas')">&times;</span>
        <h2>\ud83c\udfea Lojas</h2>
        <div id="lista-lojas"><p>Carregando...</p></div>
    </div>
</div>

<!-- Modal Financeiro Admin -->
<div id="modal-financeiro-admin" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('financeiro-admin')">&times;</span>
        <h2>\ud83d\udcb0 Financeiro</h2>
        <p style="color:#666;font-size:14px;margin-bottom:15px;">Resumo semanal de cobran&ccedil;as por loja</p>
        <div id="dados-financeiro-admin"><p>Carregando...</p></div>
    </div>
</div>

<!-- Modal Cobran\u00e7as Admin -->
<div id="modal-cobrancas" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('cobrancas')">&times;</span>
        <h2>\ud83d\udcc5 Cobran&ccedil;as Semanais</h2>
        <p style="color:#666;font-size:13px;margin-bottom:15px;">Cobran&ccedil;a toda quarta-feira. Taxa definida por loja.</p>
        <div id="lista-cobrancas"><p>Carregando...</p></div>
    </div>
</div>

<!-- Modal Relat\u00f3rio Loja -->
<div id="modal-relatorio-loja" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('relatorio-loja')">&times;</span>
        <h2>\ud83d\udcca Relat&oacute;rio Financeiro</h2>
        <div id="dados-relatorio-loja"><p>Carregando...</p></div>
    </div>
</div>

<!-- Modal Ganhos Entregador -->
<div id="modal-ganhos" class
